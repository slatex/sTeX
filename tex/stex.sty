%%
%% This is file `stex.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% stex.dtx  (with options: `package')
%% stex/utilities.idtx  (with options: `package')
%% stex/html.idtx  (with options: `package')
%% stex/archives.idtx  (with options: `package')
%% stex/uris.idtx  (with options: `package')
%% stex/documents.idtx  (with options: `package')
%% stex/modules.idtx  (with options: `package')
%% stex/smsmode.idtx  (with options: `package')
%% stex/imports.idtx  (with options: `package')
%% stex/morphisms.idtx  (with options: `package')
%% stex/symbols.idtx  (with options: `package')
%% stex/variables.idtx  (with options: `package')
%% stex/notations.idtx  (with options: `package')
%% stex/expressions.idtx  (with options: `package')
%% stex/structures.idtx  (with options: `package')
%% stex/statements.idtx  (with options: `package')
%% stex/proofs.idtx  (with options: `package')
%% stex/metatheory.idtx  (with options: `package')
%% stex/others.idtx  (with options: `package')
%% 
\RequirePackage{expl3,l3keys2e,ltxcmds}
\ProvidesExplPackage{stex}{2024/10/26}{4.0.0}{sTeX package}
\IfFileExists{stex-expl-compat.sty}{
  \usepackage{stex-expl-compat}
}{}
\RequirePackage{stex-logo} % externalized for backwards-compatibility reasons
\RequirePackage{standalone}

\bool_new:N \c_stex_use_sref_bool
\message{^^J*~This~is~sTeX~version~4.0.0~*^^J}
\keys_define:nn { stex / package } {
  debug      .str_set_x:N  = \c_stex_debug_clist ,
  lang       .clist_set:N  = \c_stex_languages_clist ,
  mathhub    .tl_set_x:N   = \mathhub ,
  usesms     .bool_set:N   = \c_stex_persist_mode_bool ,
  writesms   .bool_set:N   = \c_stex_persist_write_mode_bool ,
  forcenousesms .bool_set:N   = \c_stex_persist_force_bool ,
  checkterms .bool_set:N   = \c_stex_check_terms_bool ,
  metadata   .bool_set:N   = \c_stex_metadata_bool ,
  image      .bool_set:N   = \c_tikzinput_image_bool,
  nofrontmatter .bool_set:N = \c_stex_no_frontmatter_bool,
  unknown    .code:n       = {}
}
\exp_args:NNo \clist_set:Nn \c_stex_debug_clist \c_stex_debug_clist
\ProcessKeysOptions { stex / package }
\input{stex-en.ldf}
\cs_new_protected:Nn \stex_ignore_spaces_and_pars:{
  \begingroup\catcode13=10\relax
  \@ifnextchar\par{
    \endgroup\expandafter\stex_ignore_spaces_and_pars:\@gobble
  }{
    \endgroup
  }
}
\cs_new_protected:Nn \stex_undefine:N {
  \cs_set_eq:NN #1 \tex_undefined:D
}
\cs_generate_variant:Nn \stex_undefine:N {c}
\prg_new_conditional:Nnn \stex_str_if_starts_with:nn {p,T,F,TF} {
  \exp_args:Ne \str_if_eq:nnTF {
    \str_range:nnn{#1}{1}{\str_count:n{#2}}
  }{#2}\prg_return_true: \prg_return_false:
}
\prg_new_conditional:Nnn \stex_str_if_ends_with:nn {p,T,F,TF} {
  \exp_args:Ne \str_if_eq:nnTF {
    \str_range:nnn{#1}{- \str_count:n{#2}}{-1}
  }{#2}\prg_return_true: \prg_return_false:
}

\cs_new_protected:Nn \stex_deactivate_macro:Nn {
  \tl_set_eq:cN{\tl_to_str:n{#1}~-~orig}#1
  \cs_set_protected:Npn#1{
    \msg_error:nnnn{stex}{error/deactivated-macro}{#1}{#2}
  }
}
\cs_new_protected:Nn \stex_reactivate_macro:N {
  \cs_set_eq:Nc #1{\tl_to_str:n{#1}~-~orig}
}
\cs_new_protected:Nn \stex_kpsewhich:Nn {
  \group_begin:
    \catcode`\ =12
    \sys_get_shell:nnN { kpsewhich ~ #2 } { } \l_tmpa_tl
    \tl_gset_eq:NN \l_tmpa_tl \l_tmpa_tl
  \group_end:
  \exp_args:NNo\str_set:Nn #1 \l_tmpa_tl
  \tl_trim_spaces:N #1
}
\sys_if_platform_windows:TF{
  \cs_new_protected:Nn \stex_get_env:Nn {\group_begin:
    \escapechar=-1\catcode`\\=12
    \exp_args:NNe \stex_kpsewhich:Nn #1 {-expand-var~\c_percent_str#2\c_percent_str}
    \exp_args:NNx \str_if_eq:VnT #1 {\c_percent_str #2 \c_percent_str}{
      \str_clear:N #1
    }
    \exp_args:NNx\use:nn\group_end:{
      \str_set:Nn \exp_not:N #1 { #1 }
    }
  }
}{
  \cs_new_protected:Nn \stex_get_env:Nn {
    \stex_kpsewhich:Nn #1 {-var-value~#2}
  }
}
\cs_new_protected:Nn \stex_debug:nn {
  \exp_args:NNo \clist_if_in:NnTF \c_stex_debug_clist { \tl_to_str:n{all} }{
    \__stex_debug_:nn{#1}{#2}
  }{
    \exp_args:NNo \clist_if_in:NnT \c_stex_debug_clist { \tl_to_str:n{#1} }{
      \__stex_debug_:nn{#1}{#2}
    }
  }
}

\cs_new_protected:Nn \__stex_debug_:nn {
  \msg_set:nnn{stex}{debug / #1}{
    \\Debug~#1:~#2\\
  }
  \msg_none:nn{stex}{debug / #1}
}
\stex_get_env:Nn\__stex_debug_env_str{STEX_DEBUG}
\str_if_empty:NTF\__stex_debug_env_str {
  \clist_set_eq:NN \l__stex_debug_cl \c_stex_debug_clist
}{
  \clist_set:No \l__stex_debug_cl {\__stex_debug_env_str}
}
\clist_clear:N \c_stex_debug_clist
\clist_map_inline:Nn \l__stex_debug_cl {
  \exp_args:NNo \clist_put_right:Nn \c_stex_debug_clist
  { \tl_to_str:n{#1} }
}

\exp_args:NNo \clist_if_in:NnTF \c_stex_debug_clist {\tl_to_str:n{all}} {
    \msg_redirect_module:nnn{ stex }{ none }{ warning }
    \stex_debug:nn{all}{Logging~everything!}
}{
  \clist_map_inline:Nn \c_stex_debug_clist {
    \msg_redirect_name:nnn{ stex }{ debug / #1 }{ warning }
    \stex_debug:nn{#1}{Logging~#1}
  }
}
\cs_new_protected:Nn \stex_file_set:Nn {
  \str_if_empty:nTF {#2} { \seq_clear:N #1 }{
    \exp_args:NNno \seq_set_split:Nnn #1 / { \tl_to_str:n{#2} }
  }
}
\cs_generate_variant:Nn \stex_file_set:Nn {No, Ne}
\sys_if_platform_windows:TF{
  \cs_new_protected:Npn \__stex_path_win_take:w #1#2#3 \__stex_path_: {
    \uppercase{ \str_set:Nn \l__stex_path_str{#1}}
    \str_set:Ne \l__stex_path_win_drive {\l__stex_path_str #2}
    \str_set:Nn \l__stex_path_str{#3}
  }
  \cs_new_protected:Nn \stex_file_resolve:Nn {
    \str_set:Nn \l__stex_path_str {#2}
    \str_clear:N \l__stex_path_win_drive
    \exp_args:NNo \str_replace_all:Nnn \l__stex_path_str \c_backslash_str /
    \exp_args:Ne \str_if_eq:nnT {\str_item:Nn \l__stex_path_str 2} : {
      \exp_after:wN \__stex_path_win_take:w \l__stex_path_str \__stex_path_:
    }
    \stex_file_set:No #1 \l__stex_path_str
    \__stex_path_canonicalize:N #1
    \str_if_empty:NF \l__stex_path_win_drive {
      \seq_pop_left:NN #1 \l__stex_path_str
      \seq_put_left:No #1 \l__stex_path_win_drive
    }
    %\stex_debug:nn{files}{Set~\tl_to_str:n{#1}~to~\stex_file_use:N #1}
  }
}{
  \cs_new_protected:Nn \stex_file_resolve:Nn {
    \str_set:Nn \l__stex_path_str {#2}
    \stex_file_set:No #1 \l__stex_path_str
    \__stex_path_canonicalize:N #1
    % \stex_debug:nn{files}{Set~\tl_to_str:n{#1}~to~\stex_file_use:N #1}
  }
}
\cs_generate_variant:Nn \stex_file_resolve:Nn {No, Ne}
\cs_new_protected:Nn \__stex_path_canonicalize:N {
  \seq_if_empty:NF #1 {
    \seq_pop:NN #1 \l__stex_path_can_str
    \seq_clear:N \l__stex_path_can_seq
    \str_if_empty:NTF \l__stex_path_can_str {
      \seq_map_function:NN #1 \__stex_path_dodots:n
      \seq_put_left:Nn \l__stex_path_can_seq {}
    }{
      \seq_push:No #1 \l__stex_path_can_str
      \seq_map_function:NN #1 \__stex_path_dodots:n
    }
    \seq_set_eq:NN #1 \l__stex_path_can_seq
  }
}

\cs_new_protected:Nn \__stex_path_dodots:n {
  \str_if_empty:nF{#1}{
    \str_if_eq:nnF {#1} {.} {
      \str_if_eq:nnTF {#1} {..} {
        \seq_if_empty:NF \l__stex_path_can_seq {
          \seq_pop_right:NN \l__stex_path_can_seq \l__stex_path_can_str
        }
      }{
        \seq_put_right:Nn \l__stex_path_can_seq {#1}
      }
    }
  }
}
\cs_new:Nn \stex_file_use:N {
  \seq_use:Nn #1 /
}
\cs_new_protected:Nn \stex_file_split_off_ext:NN {
  \seq_set_eq:NN #1 #2
  \seq_pop_right:NN #1 \l__stex_path_str
  \seq_set_split:NnV \l__stex_path_seq . \l__stex_path_str
  \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str
  \seq_put_right:Ne #1 {\seq_use:Nn \l__stex_path_seq .}
}
\cs_new_protected:Nn \stex_file_split_off_lang:NN {
  \seq_set_eq:NN #1 #2
  \seq_pop_right:NN #1 \l__stex_path_str
  \seq_set_split:NnV \l__stex_path_seq . \l__stex_path_str
  \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str

  \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str
  \exp_args:NNo \prop_if_in:NnF \c_stex_languages_prop \l__stex_path_str {
    \seq_put_right:No \l__stex_path_seq \l__stex_path_str
  }

  \seq_put_right:Ne #1 {\seq_use:Nn \l__stex_path_seq .}
}
\sys_if_platform_windows:TF{
  \stex_get_env:Nn\l__stex_path_str{CD}
}{
  \stex_get_env:Nn\l__stex_path_str{PWD}
}
\stex_file_resolve:No \c_stex_pwd_file \l__stex_path_str
\seq_set_eq:NN \c_stex_main_file \c_stex_pwd_file
\seq_put_right:Ne \c_stex_main_file {\jobname\tl_to_str:n{.tex}}

\stex_debug:nn {files} {PWD:~\stex_file_use:N \c_stex_pwd_file}
\sys_if_platform_windows:TF{
  \stex_get_env:Nn \l__stex_path_str {homedrive\c_percent_str\c_percent_str homepath}
}{
  \stex_get_env:Nn \l__stex_path_str {HOME}
}
\stex_file_resolve:No \c_stex_home_file \l__stex_path_str
\seq_gset_eq:NN \g_stex_current_file \c_stex_main_file
\cs_new_protected:Nn \stex_input_with_hooks:Nn {
  \stex_with_file_hooks:Nnn #1 {#2} {\input{#2}}
}
\cs_generate_variant:Nn \stex_input_with_hooks:Nn {Ne}
\cs_new_protected:Nn \stex_with_file_hooks:Nnn {
  \stex_pseudogroup:nn {
    \stex_file_resolve:Nn \l__stex_path_seq {#2}
    \seq_gset_eq:NN \g_stex_current_file \l__stex_path_seq
    \tl_set_eq:NN \l_stex_current_document_uri #1
    \str_set:Ne \l_stex_current_language_str { \stex_document_uri_language:N \l_stex_current_document_uri}
    #3
  }{
    \tl_gset:Nn \exp_not:N \g_stex_current_file { \exp_args:No \exp_not:n \g_stex_current_file }
    \stex_pseudogroup_restore:N \l_stex_current_language_str
    \stex_pseudogroup_restore:N \l_stex_current_document_uri
  }
}
\sys_if_platform_windows:TF {
  \prg_new_conditional:Nnn \stex_if_file_absolute:N {p, T, F, TF} {
    \seq_if_empty:NTF #1 \prg_return_false: {
      \exp_args:Ne \tl_if_empty:nTF {\seq_item:Nn #1 1} \prg_return_true: {
        \exp_args:Ne \str_if_eq:nnTF { \exp_args:Ne \str_item:nn {\seq_item:Nn #1 1} 2} :
          \prg_return_true: \prg_return_false:
      }
    }
  }
}{
  \prg_new_conditional:Nnn \stex_if_file_absolute:N {p, T, F, TF} {
    \seq_if_empty:NTF #1 \prg_return_false: {
      \exp_args:Ne \tl_if_empty:nTF {\seq_item:Nn #1 1}
        \prg_return_true: \prg_return_false:
    }
  }
}
\prg_new_protected_conditional:Nnn \stex_if_file_starts_with:NN {T,F,TF} {
  \seq_set_eq:NN \l__stex_path_a_seq #1
  \seq_set_eq:NN \l__stex_path_b_seq #2
  \tl_clear:N \l__stex_path_return_tl
  \bool_while_do:nn{
    \bool_not_p:n{
      \bool_lazy_any_p:n{
        {\seq_if_empty_p:N \l__stex_path_a_seq}
        {\seq_if_empty_p:N \l__stex_path_b_seq}
        {\bool_not_p:n{\tl_if_empty_p:N \l__stex_path_return_tl}}
      }
    }
  }{
    \seq_pop_left:NN \l__stex_path_a_seq \l__stex_path_a_tl
    \seq_pop_left:NN \l__stex_path_b_seq \l__stex_path_b_tl
    \str_if_eq:NNF \l__stex_path_a_tl \l__stex_path_b_tl {
      \tl_set:Nn \l__stex_path_return_tl {\prg_return_false:}
    }
  }
  \tl_if_empty:NTF \l__stex_path_return_tl {
    \seq_if_empty:NTF \l__stex_path_b_seq \prg_return_true: \prg_return_false:
  } \l__stex_path_return_tl
}
\cs_new_protected:Npn \stex_pseudogroup:nn {
  \exp_args:Nne \use:nn
}
\cs_new:Nn \stex_pseudogroup_restore:N {
  \tl_if_exist:NTF #1 {
    \tl_set:Nn \exp_not:N #1 { \exp_args:No \exp_not:n #1 }
  }{
    \stex_undefine:N \exp_not:N #1
  }
}
\cs_new_protected:Nn \stex_pseudogroup_with:nn {
  \tl_map_inline:nn{#1}{
    \cs_set_eq:cN{__stex_groups_\tl_to_str:n{##1}}##1
  }
  #2
  \tl_map_inline:nn{#1}{
    \cs_set_eq:Nc##1{__stex_groups_\tl_to_str:n{##1}}
    \stex_undefine:c{__stex_groups_\tl_to_str:n{##1}}
  }
}
\int_new:N \l__stex_groups_lvl_int
\cs_new_protected:Nn \stex_metagroup_new: {
  \int_set_eq:NN \l__stex_groups_lvl_int \currentgrouplevel
}
\cs_new_protected:Npn \stex_metagroup_do_in:n {
  \int_compare:nNnTF \l__stex_groups_lvl_int = \currentgrouplevel
    \use:n \__stex_groups_do_in:n
}
\cs_generate_variant:Nn \stex_metagroup_do_in:n {e}

\cs_new_protected:Nn \__stex_groups_do_in:n {
  \tl_if_exist:cTF{g__stex_groups_\the\currentgrouplevel _tl}{
    \exp_args:Nno \tl_gput_right:cn{g__stex_groups_\the\currentgrouplevel _tl}
  }{
    \exp_args:Nno \tl_gset:cn{g__stex_groups_\the\currentgrouplevel _tl}
  }{ #1 }
  \bool_if_exist:cF {l__stex_groups_\the\currentgrouplevel _bool} {
      \group_insert_after:N \__stex_groups_do:
      \bool_set_true:c {l__stex_groups_\the\currentgrouplevel _bool}
  }
  #1
}

\cs_new_protected:Nn \__stex_groups_do: {
  \tl_if_exist:cT{g__stex_groups_\int_eval:n{\currentgrouplevel+1}_tl}{
    \exp_args:NNo \exp_args:No \stex_metagroup_do_in:n {
      \csname g__stex_groups_\int_eval:n{\currentgrouplevel+1}_tl \endcsname
    }
    \cs_undefine:c{g__stex_groups_\int_eval:n{\currentgrouplevel+1}_tl}
  }
  \bool_if_exist:cF {l__stex_groups_\the\currentgrouplevel _bool} {
    \group_insert_after:N \__stex_groups_do:
    \bool_set_true:c {l__stex_groups_\the\currentgrouplevel _bool}
  }
}
\cs_new_nopar:Nn \stex_keys_define:nnnn {
  \tl_gset:cn {__stex_keys_keys_#1_pre_tl}{#2}
  \tl_gset:cn {__stex_keys_keys_#1_def_tl}{#3}
  \tl_if_empty:nF{#4}{
    \clist_map_inline:nn{#4}{
      \tl_set_eq:Nc \l__stex_keys_tl {__stex_keys_keys_##1_pre_tl}
      \tl_gput_left:co{__stex_keys_keys_#1_pre_tl} \l__stex_keys_tl
      \tl_set_eq:Nc \l__stex_keys_tl {__stex_keys_keys_##1_def_tl}
      \tl_gput_left:cn{__stex_keys_keys_#1_def_tl} ,
      \tl_gput_left:co{__stex_keys_keys_#1_def_tl} \l__stex_keys_tl
    }
  }
  \tl_set_eq:Nc \l__stex_keys_tl {__stex_keys_keys_#1_def_tl}
  \exp_args:Nno \keys_define:nn {stex / #1} {\l__stex_keys_tl}
}
\cs_new_nopar:Nn \stex_keys_set:nn {
  \use:c{__stex_keys_keys_#1_pre_tl}
  \keys_set:nn {stex / #1} { #2 }
}
\stex_keys_define:nnnn{archive file}{
  \str_clear:N \l_stex_key_archive_str
  \str_clear:N \l_stex_key_file_str
}{
  archive .str_set_x:N = \l_stex_key_archive_str ,
  file    .str_set_x:N = \l_stex_key_file_str
}{}

\stex_keys_define:nnnn{id}{
  \str_clear:N \l_stex_key_id_str
}{
  id .str_set_x:N = \l_stex_key_id_str
}{}

\stex_keys_define:nnnn{title}{
  \tl_clear:N \l_stex_key_title_tl
}{
  title .tl_set:N = \l_stex_key_title_tl
}{}

\stex_keys_define:nnnn{style}{
  \clist_clear:N \l_stex_key_style_clist
}{
  style .clist_set:N = \l_stex_key_style_clist
}{}

\stex_keys_define:nnnn{deprecate}{
  \str_clear:N \l_stex_key_deprecate_str
}{
  deprecate     .str_set_x:N  = \l_stex_key_deprecate_str
}{}

\stex_keys_define:nnnn{uses}{}{
  uses .code:n = {
    \clist_map_inline:nn{#1}{
      \stex_str_if_starts_with:nnTF{##1}[{
        \__stex_keys_split_at_bracket:w ##1 \_stex_end:
      }{
        \usemodule{##1}
      }
    }
  }
}{}

\cs_new_protected:Npn \__stex_keys_split_at_bracket:w [ #1 ] #2 \_stex_end: {
  \usemodule[#1]{#2}
}
\exp_args:NNx \prop_const_from_keyval:Nn \c_stex_languages_prop { \tl_to_str:n {
  en = english ,
  de = ngerman ,
  ar = arabic ,
  bg = bulgarian ,
  ru = russian ,
  fi = finnish ,
  ro = romanian ,
  tr = turkish ,
  fr = french ,
  sl = slovenian
}}

\exp_args:NNx \prop_const_from_keyval:Nn \c_stex_language_abbrevs_prop { \tl_to_str:n {
  english   = en ,
  ngerman   = de ,
  arabic    = ar ,
  bulgarian = bg ,
  russian   = ru ,
  finnish   = fi ,
  romanian  = ro ,
  turkish   = tr ,
  french    = fr ,
  slovenian = sl ,
}}
\str_new:N \l_stex_current_language_str
\clist_if_empty:NF \c_stex_languages_clist {
  \bool_set_false:N \l__stex_lang_turkish_bool
  \seq_clear:N \l_tmpa_seq
  \clist_map_inline:Nn \c_stex_languages_clist {
    \str_if_empty:NF \l_stex_current_language_str {
      \str_set:Nn \l_stex_current_language_str {#1}
    }
    \str_set:Ne \l_tmpa_str {#1}
    \str_if_eq:nnT {#1}{tr}{
      \bool_set_true:N \l__stex_lang_turkish_bool
    }
    \prop_get:NoNTF \c_stex_languages_prop \l_tmpa_str \l_tmpa_str {
      \tl_set_rescan:Nno \l_tmpa_str {} \l_tmpa_str
      \seq_put_right:No \l_tmpa_seq \l_tmpa_str
    } {
      \msg_error:nnx{stex}{error/unknownlanguage}{\l_tmpa_str}
    }
  }
  \stex_debug:nn{lang} {Languages:~\seq_use:Nn \l_tmpa_seq {,~} }
  \bool_if:NTF \l__stex_lang_turkish_bool {
    \exp_args:NNe \use:nn \RequirePackage
      {[main=\seq_use:Nn \l_tmpa_seq, ,shorthands=:!]}{babel}
  }{
    \exp_args:NNe \use:nn \RequirePackage
      {[main=\seq_use:Nn \l_tmpa_seq, ]}{babel}
  }
}
\cs_new_protected:Nn \stex_new_stylable_cmd:nnnn {
  \exp_after:wN \newcommand \cs:w stexstyle#1 \cs_end:[2][]{
    \__stex_styles_patch:nnn{#1}{##1}{##2}
  }
  \exp_after:wN \NewDocumentCommand\cs:w #1\cs_end:{#2}{
    \cs_set:Npn \stex_style_apply: {
      \__stex_styles_apply_patch:n{#1}
    }
    #3
  }
  \tl_set:cn {__stex_styles_style_#1:} { #4 }
}

\cs_new_protected:Nn \__stex_styles_patch:nnn {
  \str_if_empty:nTF {#2}{
    \tl_set:cn{__stex_styles_style_#1:}{#3}
  }{
    \tl_set:cn{__stex_styles_style_#1_#2:}{#3}
  }
}

\cs_new_protected:Nn \__stex_styles_apply_patch:n {
  \clist_if_empty:NTF \l_stex_key_style_clist {
    \tl_clear:N \thisstyle
    \use:c{__stex_styles_style_#1:}
  }{
    \clist_get:NN \l_stex_key_style_clist \thisstyle
    \tl_if_exist:cTF{__stex_styles_style_#1_\thisstyle :}{
      \use:c{__stex_styles_style_#1_\thisstyle :}
    }{
      \use:c{__stex_styles_style_#1:}
    }
  }
}
\cs_new_protected:Nn \stex_new_stylable_env:nnnnnnn {
  \exp_after:wN \newcommand \cs:w stexstyle#1 \cs_end:[3][]{
    \__stex_styles_patch:nnnn{#1}{##1}{##2}{##3}
  }
  \NewDocumentEnvironment{#7#1}{#2}{
    \cs_set:Npn \stex_style_apply: {
      \_stex_apply_patch_begin:n{#1}
    }
    #3
  }{
    \cs_set:Npn \stex_style_apply: {
      \_stex_apply_patch_end:n{#1}
    }
    #4
  }
  \tl_set:cn {__stex_styles_style_#1_start:} { #5 }
  \tl_set:cn {__stex_styles_style_#1_end:} { #6 }
}

\cs_new_protected:Nn \__stex_styles_patch:nnnn {
  \str_if_empty:nTF {#2}{
    \tl_set:cn{__stex_styles_style_#1_start:}{#3}
    \tl_set:cn{__stex_styles_style_#1_end:}{#4}
  }{
    \tl_set:cn{__stex_styles_style_#1_#2_start:}{#3}
    \tl_set:cn{__stex_styles_style_#1_#2_end:}{#4}
  }
}

\cs_new_protected:Nn \_stex_apply_patch_begin:n {
  \clist_if_empty:NTF \l_stex_key_style_clist {
    \tl_clear:N \thisstyle
    \use:c{__stex_styles_style_#1_start:}
  }{
    \clist_get:NN \l_stex_key_style_clist \thisstyle
    \stex_debug:nn{styling}{dominant~style:~\thisstyle}
    \tl_if_exist:cTF{__stex_styles_style_#1_\thisstyle _start:}{
      \use:c{__stex_styles_style_#1_\thisstyle _start:}
    }{
      \use:c{__stex_styles_style_#1_start:}
    }
  }
}

\cs_new_protected:Nn \_stex_apply_patch_end:n {
  \tl_if_empty:NTF \thisstyle {
    \use:c{__stex_styles_style_#1_end:}
  }{
    \tl_if_exist:cTF{__stex_styles_style_#1_\thisstyle _end:}{
      \use:c{__stex_styles_style_#1_\thisstyle _end:}
    }{
      \use:c{__stex_styles_style_#1_end:}
    }
  }
}
\stex_get_env:Nn\__stex_persist_env_str{STEX_USESMS}
\str_if_empty:NF\__stex_persist_env_str{
  \exp_args:No \str_if_eq:nnF \__stex_persist_env_str{false}{
    \bool_set_true:N \c_stex_persist_mode_bool
  }
}
\stex_get_env:Nn\__stex_persist_env_str{STEX_WRITESMS}
\str_if_empty:NF\__stex_persist_env_str{
  \exp_args:No \str_if_eq:nnF \__stex_persist_env_str{false}{
    \bool_set_true:N \c_stex_persist_write_mode_bool
  }
}

\bool_if:NT \c_stex_persist_force_bool {
  \bool_set_false:N \c_stex_persist_mode_bool
}

\iow_new:N \c__stex_persist_sms_iow
\cs_new_protected:Nn \_stex_persist_read_now: {
  \bool_if:NTF \c_stex_persist_mode_bool {
    \bool_if:NTF \c_stex_persist_write_mode_bool
      \__stex_persist_read_and_write:
      {
        \__stex_persist_load_file:n{\jobname.sms}
      }
  }{
    \bool_if:NT \c_stex_persist_write_mode_bool \__stex_persist_write_only:
  }
}

\cs_new_protected:Nn \__stex_persist_load_file:n {
  \file_if_exist:nT{#1}{
    \group_begin:
    \cs_set:Npn \stex_persist:n ##1 {}
    \cs_set:Npn \stex_persist:e ##1 {}
      \stex_debug:nn{persist}{restoring~from~sms~file}
      \catcode`\ =10\relax
      \cs:w @ @ input \cs_end:#1\relax
    \group_end:
  }
}

\cs_new_protected:Nn \__stex_persist_write_only: {
  \iow_open:Nn \c__stex_persist_sms_iow {\jobname.sms}
  \AtEndDocument{ \iow_close:N \c__stex_persist_sms_iow }
}

\cs_new_protected:Nn \__stex_persist_read_and_write: {
  \file_if_exist:nTF{\jobname.sms}{
    \ior_open:Nn \g_tmpa_ior {\jobname.sms}
    \iow_open:Nn \g_tmpa_iow {\jobname.sms2}
    \ior_str_map_inline:Nn \g_tmpa_ior {
      \iow_now:Nn \g_tmpa_iow {##1}
    }
    \iow_close:N \g_tmpa_iow
    \ior_close:N \g_tmpa_ior
    \__stex_persist_write_only:
    \ior_open:Nn \g_tmpa_ior {\jobname.sms2}
    \ior_str_map_inline:Nn \g_tmpa_ior {
      \iow_now:Nn \c__stex_persist_sms_iow {##1}
    }
    \ior_close:N \g_tmpa_ior
    \__stex_persist_load_file:n{\jobname.sms2}
  }\__stex_persist_write_only:
}
\cs_new:Nn \_stex_do_deprecation:n {
  \str_if_empty:NF \l_stex_key_deprecate_str {
    \msg_warning:nnxx{stex}{warning/deprecated}{#1}{\l_stex_key_deprecate_str}
  }
}
\cs_new_protected:Nn \_stex_do_id: {
  \stex_if_smsmode:F {
    \str_if_empty:NF \l_stex_key_id_str {
      \exp_args:No \stex_ref_new_doc_target:n \l_stex_key_id_str
    }
  }
}
\ifcsname if@rustex\endcsname\else
  \expandafter\newif\csname if@rustex\endcsname
  \@rustexfalse
\fi

\stex_get_env:Nn\__stex_annotate_env_str{STEX_FORCE_PDF}
\exp_args:No \str_if_eq:nnTF \__stex_annotate_env_str {true} {
  \def\stex@backend{pdflatex}
}{
  \tl_if_exist:NF\stex@backend{
    \if@rustex
      \def\stex@backend{rustex}
    \else
      \cs_if_exist:NTF\HCode{
        \def\stex@backend{tex4ht}
      }{
        \def\stex@backend{pdflatex}
      }
    \fi
  }
}

\input{stex-backend-\stex@backend.cfg}
\bool_new:N \l__stex_annotate_do_output_bool

\newif\ifstexhtml
\stex_if_html_backend:TF {
  \stexhtmltrue
  \bool_set_true:N \l__stex_annotate_do_output_bool
}{
  \stexhtmlfalse
  \bool_set_false:N \l__stex_annotate_do_output_bool
}
\prg_new_conditional:Nnn \stex_if_do_html: {p,T,F,TF} {
  \bool_if:NTF \l__stex_annotate_do_output_bool
    \prg_return_true: \prg_return_false:
}
\cs_new_protected:Nn \stex_suppress_html:n {
  \stex_pseudogroup:nn{
    \bool_set_false:N \l__stex_annotate_do_output_bool
    #1
  }{
    \stex_if_do_html:T {
      \bool_set_true:N \l__stex_annotate_do_output_bool
    }
  }
}
\cs_new_protected:Npn \STEXinvisible #1 {
  \stex_annotate_invisible:n { #1 }
}
\stex_if_html_backend:TF {
  \cs_new_protected:Npn \mmlintent #1 #2 {
    \stex_annotate:nn{mml:intent={#1}}{#2}
  }
  \cs_new_protected:Npn \mmlarg #1 #2 {
    \stex_annotate:nn{mml:arg={#1}}{#2}
  }
}{
  \cs_new_protected:Npn \mmlintent #1 #2 { #2 }
  \cs_new_protected:Npn \mmlarg #1 #2 { #2 }
}
\bool_if:NTF \c_stex_persist_write_mode_bool {
  \stex_if_html_backend:TF{
    \cs_new:Npn \stex_persist:n #1 {}
    \cs_new:Npn \stex_persist:e #1 {}
  }{
    \cs_new_protected:Nn \stex_persist:n {
      \iow_now:Nn \c__stex_persist_sms_iow {#1}
    }
    \cs_generate_variant:Nn \stex_persist:n {e}
  }
}{
  \cs_new:Npn \stex_persist:n #1 {}
  \cs_new:Npn \stex_persist:e #1 {}
}
\str_if_empty:NTF\mathhub{
  \stex_get_env:Nn \l__stex_mathhub_str {MATHHUB}
  \str_if_empty:NTF \l__stex_mathhub_str {
    \ior_open:NnTF \g_tmpa_ior{\stex_file_use:N \c_stex_home_file/.stex/mathhub.path}{
      \group_begin:
        \escapechar=-1\catcode`\\=12
        \ior_str_get:NN \g_tmpa_ior \l__stex_mathhub_str
        \str_gset_eq:NN \l__stex_mathhub_str \l__stex_mathhub_str
      \group_end:
      \ior_close:N \g_tmpa_ior
      \stex_debug:nn{mathhub}{MathHub~directory~determined~from~home~directory}
    }{
      \str_clear:N \l__stex_mathhub_str
    }
  }{
    \stex_debug:nn{mathhub}{MathHub~directory~determined~from~environment~variable}
  }
}{
  \str_set_eq:NN \l__stex_mathhub_str \mathhub
}

\str_if_empty:NTF \l__stex_mathhub_str {
  \msg_warning:nn{stex}{warning/nomathhub}
  \stex_file_set:Ne \l_tmpa_seq {\stex_file_use:N \c_stex_home_file \tl_to_str:n{/MathHub}}
  \seq_clear:N \c_stex_mathhub_files
  \seq_push:Ne \c_stex_mathhub_files {\stex_file_use:N \l_tmpa_seq}
}{
  \seq_clear:N \c_stex_mathhub_files
  \seq_set_split:NnV \l_tmpa_seq , \l__stex_mathhub_str
  \seq_map_inline:Nn \l_tmpa_seq {
    \stex_file_resolve:Nn \l__stex_mathhub_str {#1}
    \stex_if_file_absolute:NF \l__stex_mathhub_str {
      \stex_file_resolve:Ne \l__stex_mathhub_str {
        \stex_file_use:N \c_stex_pwd_file / #1
      }
    }
    \seq_put_right:Ne \c_stex_mathhub_files {
      \stex_file_use:N \l__stex_mathhub_str
    }
  }
}

\exp_args:NNe \str_set:Nn \mathhub {\seq_use:Nn \c_stex_mathhub_files ,}
\stex_debug:nn{mathhub}{MATHHUBs:~\mathhub}
\cs_new:Npn \stex_archive_id:N {
  \exp_after:wN \use_i:nnn
}
\cs_new:Npn \stex_archive_base:N {
  \exp_after:wN \use_ii:nnn
}

\cs_new:Nn \stex_archive_base:n {
  \exp_args:NNe \use:nn \use_ii:nnn { \use:c {c_stex_mathhub_#1_archive} }
}
\cs_new:Npn \stex_archive_path:N {
  \exp_after:wN \use_iii:nnn
}

\cs_new:Nn \stex_archive_path:n {
  \exp_args:NNe \use:nn \use_iii:nnn { \use:c {c_stex_mathhub_#1_archive} }
}
\cs_new_protected:Nn \stex_in_archive:nn {
  \stex_pseudogroup:nn{
    \cs_set:Npn \l__stex_mathhub_cs ##1 {#2}
    \tl_if_empty:nTF{#1}{
      \tl_if_exist:NTF \l_stex_current_archive {
        \exp_args:Ne \l__stex_mathhub_cs {\stex_archive_id:N \l_stex_current_archive }
      }{
        \l__stex_mathhub_cs {}
      }
    }{
      \__stex_mathhub_set_current:n{#1}
      \l__stex_mathhub_cs {#1}
    }
  }{
    \stex_pseudogroup_restore:N \l_stex_current_archive
    \cs_set:Npn \exp_not:N \l__stex_mathhub_cs ##1 {
      \exp_args:No \exp_not:n {\l__stex_mathhub_cs {##1}}
    }
  }
}

\cs_set:Npn \l__stex_mathhub_cs #1 {}
\cs_new_protected:Nn \__stex_mathhub_set_current:n {
  \__stex_mathhub_require:n { #1 }
  \stex_debug:nn{mathhub}{switching~to~archive~#1}
  \tl_set_eq:Nc \l_stex_current_archive {
    c_stex_mathhub_#1_archive
  }
}

\cs_new_protected:Nn \__stex_mathhub_require:n {
  \prop_if_exist:cF { c_stex_mathhub_#1_archive } {
    \seq_if_empty:NTF \c_stex_mathhub_files {
      \msg_fatal:nn{stex}{warning/nomathhub}
    }{
      \stex_debug:nn{mathhub}{Opening~archive:~#1}
      \__stex_mathhub_do_manifest:nn { #1 }{
        \msg_fatal:nnee{stex}{error/noarchive}
        {#1}{\seq_use:Nn \c_stex_mathhub_files ,}
      }
    }
  }
}
\cs_new_protected:Nn \__stex_mathhub_do_manifest:nn {
  \seq_map_inline:Nn \c_stex_mathhub_files {
    \__stex_mathhub_find_manifest:nn {##1}{#1}
    \str_if_empty:NF \l__stex_mathhub_manifest_str \seq_map_break:
  }
  %\exp_args:Ne \__stex_mathhub_find_manifest:n {\stex_file_use:N \c_stex_mathhub_file / #1}
  \str_if_empty:NTF \l__stex_mathhub_manifest_str { #2 }{
    \__stex_mathhub_parse_manifest:n {#1}
  }
}

\cs_new_protected:Nn \__stex_mathhub_find_manifest:nn {
  \str_clear:N \l__stex_mathhub_manifest_str
  \seq_set_split:Nnn \l_tmpa_seq / { #1 }
  \seq_set_split:Nnn \l__stex_mathhub_seq / {#1 / #2}
  \bool_set_true:N \l__stex_mathhub_bool
  \bool_while_do:Nn \l__stex_mathhub_bool {
    \tl_if_eq:NNTF \l__stex_mathhub_seq \l_tmpa_seq {
      \bool_set_false:N \l__stex_mathhub_bool
    }{
      \__stex_mathhub_check_manifest:
      \bool_if:NT \l__stex_mathhub_bool {
        \seq_pop_right:NN \l__stex_mathhub_seq \l__stex_mathhub_tl
      }
    }
  }
}

\cs_new_protected:Nn \__stex_mathhub_check_manifest: {
  \__stex_mathhub_check_manifest:n {MANIFEST.MF}
  \bool_if:NT \l__stex_mathhub_bool {
    \__stex_mathhub_check_manifest:n {META-INF/MANIFEST.MF}
    \bool_if:NT \l__stex_mathhub_bool {
      \__stex_mathhub_check_manifest:n {meta-inf/MANIFEST.MF}
    }
  }
}

\cs_new_protected:Nn \__stex_mathhub_check_manifest:n {
  \stex_debug:nn{mathhub}{Checking~\stex_file_use:N \l__stex_mathhub_seq / #1}
  \file_if_exist:nT {\stex_file_use:N \l__stex_mathhub_seq / #1} {
    \bool_set_false:N \l__stex_mathhub_bool
    \str_set:Ne \l__stex_mathhub_manifest_str {\stex_file_use:N \l__stex_mathhub_seq / #1}
  }
}
\ior_new:N \c__stex_mathhub_manifest_ior

\cs_new_protected:Nn \__stex_mathhub_parse_manifest:n {
  \ior_open:Nn \c__stex_mathhub_manifest_ior \l__stex_mathhub_manifest_str
  \str_set:Ne \l__stex_mathhub_file_str {\stex_file_use:N \l__stex_mathhub_seq}
  \str_set:Nn \l__stex_mathhub_id_str {#1}
  \str_set:Nn \l__stex_mathhub_base_str {http://mathhub.info}

  \ior_map_inline:Nn \c__stex_mathhub_manifest_ior {
    \exp_args:NNNo \exp_args:NNNx
      \seq_set_split:Nnn \l__stex_mathhub_seq \c_colon_str {\tl_to_str:n{##1}}
    \seq_pop_left:NNT \l__stex_mathhub_seq \l__stex_mathhub_key {
      \exp_args:NNo \str_set:Nn \l__stex_mathhub_key \l__stex_mathhub_key
      \str_set:Ne \l__stex_mathhub_val {\seq_use:Nn \l__stex_mathhub_seq :}
      \str_case:Nn \l__stex_mathhub_key {
        {id}              { \str_set_eq:NN \l__stex_mathhub_id_str \l__stex_mathhub_val }
        {url-base}        { \str_set_eq:NN \l__stex_mathhub_base_str \l__stex_mathhub_val }
      }
    }
  }
  \ior_close:N \c__stex_mathhub_manifest_ior
  \tl_gset:ce { c_stex_mathhub_#1_archive } { {\l__stex_mathhub_id_str} {\l__stex_mathhub_base_str} {\l__stex_mathhub_file_str} }
  \stex_debug:nn{mathhub}{Result:~\use:c{c_stex_mathhub_#1_archive}}
  \str_if_eq:nnF {#1}{main}{
    \stex_persist:e {
      \__stex_mathhub_restore:nn{\l__stex_mathhub_id_str}{\l__stex_mathhub_base_str}
    }
  }
}
\cs_set_protected:Nn \__stex_mathhub_restore:nn {
  \__stex_mathhub_do_manifest:nn { #1 }{}
  \tl_if_exist:cF { c_stex_mathhub_#1_archive }{
    \tl_set:ce{ c_stex_mathhub_#1_archive }{
      {\tl_to_str:n{#1}}
      {\tl_to_str:n{#2}}
      {}
    }
  }
}

\str_const:Nn \c_stex_no_archive_str { no/archive }

\tl_const:Ne \c_stex_no_archive_uri {
  {\c_stex_no_archive_str}
  {\tl_to_str:n{http://unknown.source}}
  {}
}

\tl_set_eq:cN {c_stex_mathhub_ no/archive _ archive}\c_stex_no_archive_uri
\seq_map_inline:Nn \c_stex_mathhub_files {
  \seq_set_split:Nnn \l_tmpa_seq / {#1}
  \stex_if_file_starts_with:NNT \c_stex_pwd_file \l_tmpa_seq {
    \seq_set_eq:NN \l_tmpb_seq \c_stex_pwd_file
    \seq_map_inline:Nn \l_tmpa_seq { \seq_pop_left:NN \l_tmpb_seq \l_tmpa_tl }
    \exp_args:Nne \__stex_mathhub_find_manifest:nn {#1} { \stex_file_use:N \l_tmpb_seq }
    \str_if_empty:NTF \l__stex_mathhub_manifest_str {
      \stex_debug:nn{mathhub}{Not~currently~in~a~MathHub~archive}
    }{
      \__stex_mathhub_parse_manifest:n { main }
      \tl_set_eq:NN \c_stex_main_archive \c_stex_mathhub_main_archive
      \cs_undefine:N \c_stex_mathhub_main_archive
      \tl_set_eq:cN { c_stex_mathhub_ \stex_archive_id:N \c_stex_main_archive _archive }
        \c_stex_main_archive
      \prop_set_eq:NN \l_stex_current_archive \c_stex_main_archive
      \stex_debug:nn{mathhub}{Current~archive:~
        \stex_archive_id:N \c_stex_main_archive
      }
      \stex_persist:e {
        \__stex_mathhub_restore:nn{\stex_archive_id:N \c_stex_main_archive}{\stex_archive_base:N \c_stex_main_archive}
        \tl_gset_eq:Nc \exp_not:N \c_stex_main_archive {c_stex_mathhub_ \stex_archive_id:N \c_stex_main_archive _archive }
        \tl_gset_eq:NN \exp_not:N \l_stex_current_archive \exp_not:N \c_stex_main_archive
      }
      %\bool_if:NT \c_stex_persist_write_mode_bool {
      %  \tl_put_right:Ne \_stex_persist_read_now: {
      %    \stex_persist:n {{c_stex_mathhub_ \stex_archive_id:N \c_stex_main_archive _archive }
      %      \tl_gset_eq:cN{c_stex_mathhub_ \stex_archive_id:N \c_stex_main_archive _manifest_prop }\exp_not:N\c_stex_main_archive
      %      \tl_gset_eq:NN \exp_not:N \l_stex_current_archive \exp_not:N\c_stex_main_archive
      %    }
      %  }
      %}
    }
    \seq_map_break:
  }
}
\tl_if_exist:NF \c_stex_main_archive {
  \stex_debug:nn{mathhub}{Not~currently~in~a~MathHub~directory}
}
\cs_new:Nn \stex_source_path:n {
  \tl_if_exist:NTF \l_stex_current_archive {
    \stex_archive_path:N \l_stex_current_archive / source \tl_if_empty:nF{#1}{/ #1}
  }{
    \stex_file_use:N \g_stex_current_file / .. \tl_if_empty:nF{#1}{/ #1}
  }
}
\cs_new:Nn \stex_source_path:nn {
  \tl_if_empty:nTF{#1}{
    \stex_source_path:n {#2}
  }{
    \tl_if_exist:cTF {c_stex_mathhub_ #1 _archive } {
      \stex_archive_path:n {#1} / source \tl_if_empty:nF{#2}{/ #2}
    }{
      \stex_file_use:N \g_stex_current_file / .. \tl_if_empty:nF{#2}{/ #2}
    }
  }
}
\cs_new:Ne \stex_use_archive_uri:n {
  \exp_not:N \stex_archive_base:n{#1} \tl_to_str:n{?a=} #1
}
\cs_new:Nn \stex_use_document_uri:N {
  \exp_after:wN \__stex_uris_doc:nnnnn #1
}
\cs_new:Nn \stex_use_document_uri:n {
  \__stex_uris_doc:nnnnn #1
}
\cs_new:Ne \__stex_uris_doc:nnnnn {
  \exp_not:N \stex_archive_base:n{#1} \tl_to_str:n{?a=} #1
  \exp_not:N \tl_if_empty:nF{#2}{
    \c_ampersand_str\tl_to_str:n{p=}#2
  }
  \c_ampersand_str\tl_to_str:n{d=}#3
  \c_ampersand_str\tl_to_str:n{l=}#4
  \exp_not:N \tl_if_empty:nF{#5}{
    \c_ampersand_str\tl_to_str:n{e=}#5
  }
}
\cs_new:Nn \stex_document_uri_archive:N {
  \exp_after:wN \use_i:nnnnn #1
}
\cs_new:Nn \stex_document_uri_path:N {
  \exp_after:wN \use_ii:nnnnn #1
}
\cs_new:Nn \stex_document_uri_name:N {
  \exp_after:wN \use_iii:nnnnn #1
}
\cs_new:Nn \stex_document_uri_language:N {
  \exp_after:wN \use_iv:nnnnn #1
}
\cs_new:Nn \stex_document_uri_element:N {
  \exp_after:wN \use_v:nnnnn #1
}
\cs_new:Npn \stex_document_uri_with_language:Nn {
  \exp_after:wN \__stex_uris_with_language:nnnnnn
}
\cs_new:Nn \__stex_uris_with_language:nnnnnn {
  {#1}{#2}{#3}{#6}{}
}
\cs_new_protected:Nn \stex_document_uri_from_archive_file:Nn {
  \stex_file_set:Nn \l__stex_uris_file {#2}
  \stex_debug:nn{URI}{relative~path:~\stex_file_use:N \l__stex_uris_file}
  \__stex_uris_doc_from_archive_file:NN #1 \l__stex_uris_file
}

\cs_new_protected:Nn \__stex_uris_doc_from_archive_file:NN {
  \__stex_uris_split_file:N #2
  \prop_if_exist:NTF \l_stex_current_archive {
    \str_set:Ne \l__stex_uris_archive {
      \stex_archive_id:N \l_stex_current_archive
    }
  }{
    \str_set_eq:NN \l__stex_uris_archive \c_stex_no_archive_str
  }
  \tl_set:Ne #1 {
    { \l__stex_uris_archive }
    { \stex_file_use:N \l__stex_uris_path_seq }
    { \l__stex_uris_name_str }
    { \l__stex_uris_lang_str }
    {}
  }
}

\cs_new_protected:Nn \__stex_uris_split_file:N {
  \seq_set_eq:NN \l__stex_uris_path_seq #1
  \seq_pop_right:NN \l__stex_uris_path_seq \l__stex_uris_name_str
  \seq_set_split:NnV \l_tmpa_seq . \l__stex_uris_name_str
  \seq_pop_right:NN \l_tmpa_seq \l__stex_uris_lang_str % .tex?
  \seq_if_empty:NTF \l_tmpa_seq {
    \str_set_eq:NN \l__stex_uris_name_str \l__stex_uris_lang_str
    \str_set_eq:NN \l__stex_uris_lang_str \l_stex_current_language_str
  }{
    \seq_pop_right:NN \l_tmpa_seq \l__stex_uris_lang_str % actual language maybe?
    \cs_if_eq:NNTF \l__stex_uris_lang_str \q_no_value {
      \str_set_eq:NN \l__stex_uris_lang_str \l_stex_current_language_str
    }{
      \prop_if_in:NoF \c_stex_languages_prop \l__stex_uris_lang_str {
        \seq_put_right:No \l_tmpa_seq \l__stex_uris_lang_str
        \str_set:Nn \l__stex_uris_lang_str {en}
      }
    }
    \str_set:Ne \l__stex_uris_name_str {\seq_use:Nn \l_tmpa_seq .}
  }
}
\tl_if_exist:NTF \l_stex_current_archive {
  \str_set:Ne \l_tmpa_str { \stex_archive_path:N \l_stex_current_archive }
  \seq_set_split:NnV \l_tmpa_seq / \l_tmpa_str
  \seq_set_eq:NN \l_tmpb_seq \c_stex_main_file
  \seq_map_inline:Nn \l_tmpa_seq {
    \seq_pop_left:NN \l_tmpb_seq \l_tmpa_tl
  }
  \seq_pop_left:NN \l_tmpb_seq \l_tmpa_tl
  \__stex_uris_doc_from_archive_file:NN \l_stex_current_document_uri \l_tmpb_seq
}{
  \__stex_uris_doc_from_archive_file:NN \l_stex_current_document_uri \c_stex_main_file
}

\tl_set_eq:NN \c_stex_main_document_uri \l_stex_current_document_uri
\str_set:Ne \l_stex_current_language_str { \stex_document_uri_language:N \l_stex_current_document_uri }

\stex_debug:nn{URIs}{Current~document:~ \stex_use_document_uri:N \c_stex_main_document_uri}
\cs_new:Nn \stex_use_module_uri:N {
  \exp_after:wN \__stex_uris_module:nnn #1
}
\cs_new:Nn \stex_use_module_uri:n {
  \__stex_uris_module:nnn #1
}
\cs_new:Ne \__stex_uris_module:nnn {
  \exp_not:N \stex_archive_base:n{#1} \tl_to_str:n{?a=} #1
  \exp_not:N \tl_if_empty:nF{#2}{
    \c_ampersand_str\tl_to_str:n{p=}#2
  }
  \c_ampersand_str\tl_to_str:n{m=}#3
}
\cs_new:Nn \stex_module_uri_archive:N {
  \exp_after:wN \use_i:nnn #1
}
\cs_new:Nn \stex_module_uri_path:N {
  \exp_after:wN \use_ii:nnn #1
}
\cs_new:Nn \stex_module_uri_path:n {
  \use_ii:nnn #1
}
\cs_new:Nn \stex_module_uri_name:N {
  \exp_after:wN \use_iii:nnn #1
}

\cs_new:Nn \stex_module_uri_name:n {
  \use_iii:nnn #1
}
\cs_new_protected:Npn \stex_module_uri_split_name:NNN #1 {
  \exp_after:wN \__stex_uris_parent:NNnnn \exp_after:wN #1 \exp_after:wN
}

\cs_new_protected:Nn \stex_module_uri_split_name:NNn {
  \__stex_uris_parent:NNnnn #1 #2 #3
}

\cs_new_protected:Nn \__stex_uris_parent:NNnnn {
  \seq_set_split:Nnn #1 / {#5}
  \seq_pop_right:NN #1 #2
  \seq_if_empty:NTF #1 {
    \tl_set:Ne #1 { {#3} {#4} {#3}}
    \tl_clear:N #2
  }{
    \tl_set:Ne #1 { {#3} {#4} {\seq_use:Nn #1 /} }
  }
}
\cs_new:Nn \stex_module_uri_as_qm:n {
  \__stex_uris_as_qm:nnn #1
}
\cs_new:Nn \__stex_uris_as_qm:nnn {
  #1 / #2 ? #3
}
\cs_new:Npn \stex_new_module_uri:n {
  \stex_if_in_module:TF {
    \exp_after:wN \__stex_uris_new_nested_mod:nnnn \l_stex_current_module_uri
  }{
    \exp_after:wN \__stex_uris_new_mod:nnnnnn \l_stex_current_document_uri
  }
}

\cs_new:Nn \__stex_uris_new_mod:nnnnnn {
  {#1}
  \str_if_eq:nnTF{#3}{#6}{
    {#2}{#3}
  }{
    {#2 \tl_if_empty:nF{#2}/ #3}{ \tl_to_str:n{ #6 } }
  }
}
\cs_new:Nn \__stex_uris_new_nested_mod:nnnn {
  {#1}
  {#2}
  {#3 / \tl_to_str:n{#4}}
}
\bool_new:N \l_stex_relative_import_bool
\cs_new_protected:Nn \stex_uri_from_pair:Nnn {
  \bool_set_false:N \l_stex_relative_import_bool
  \stex_debug:nn{uri}{resolving~<#2,#3>~in~\stex_use_document_uri:N \l_stex_current_document_uri}
  \seq_set_split:Nne \l_tmpa_seq ? { \tl_to_str:n {#3} }
  \seq_pop_right:NN \l_tmpa_seq \l__stex_uris_name_str
  \str_clear:N \l__stex_uris_path_str
  \seq_if_empty:NF \l_tmpa_seq {
    \seq_pop_right:NN \l_tmpa_seq \l__stex_uris_path_str
  }
  \tl_if_empty:nTF { #2 }{
    \str_if_empty:NTF \l__stex_uris_path_str
      \__stex_uris_maybe_relative:N \__stex_uris_absolute:N
    #1
  }{
    \__stex_uris_pair_in_archive:Nn #1 { #2 }
  }
}

\cs_new_protected:Nn \__stex_uris_maybe_relative:N {
  \tl_set:Ne \l_tmpb_tl {
    \stex_document_uri_path:N \l_stex_current_document_uri
  }
  \tl_set:Ne \l_tmpa_tl {
    {
      \stex_document_uri_archive:N \l_stex_current_document_uri
    }
    {
      \l_tmpb_tl
      \exp_args:NNo \exp_args:Nne \str_if_eq:nnF \l__stex_uris_name_str {
        \stex_document_uri_name:N \l_stex_current_document_uri
      }{
        \str_if_empty:NF \l_tmpb_tl / \stex_document_uri_name:N \l_stex_current_document_uri
      }
    }
    { \l__stex_uris_name_str }
  }
  \stex_if_module_exists:NTF \l_tmpa_tl {
    \tl_set_eq:NN #1 \l_tmpa_tl
    \bool_set_true:N \l_stex_relative_import_bool
    \stex_debug:nn{uri}{returning~relative~\stex_use_module_uri:N #1}
  }{
    \__stex_uris_absolute:N #1
  }
}

\cs_new_protected:Nn \__stex_uris_absolute:N {
  \tl_if_exist:NTF \l_stex_current_archive {
    \tl_set:Ne #1 {
      { \stex_archive_id:N \l_stex_current_archive }
      { \l__stex_uris_path_str }
      { \l__stex_uris_name_str }
    }
    \stex_debug:nn{uri}{returning~\stex_use_module_uri:N #1}
  }{
    \__stex_uris_pair_no_archive:N #1
  }
}

\cs_new_protected:Nn \__stex_uris_pair_no_archive:N {
  \stex_file_resolve:Ne \l_tmpa_seq {
    \stex_file_use:N \g_stex_current_file / .. / \l__stex_uris_path_str
  }
  \tl_set:Ne #1 {
    { \c_stex_no_archive_str }
    { \stex_file_use:N \l_tmpa_seq }
    { \l__stex_uris_name_str }
  }
  \stex_debug:nn{uri}{returning~\stex_use_module_uri:N #1}
}

\cs_new_protected:Nn \__stex_uris_pair_in_archive:Nn {
 \tl_set:Ne #1 {
    { \tl_to_str:n{ #2 } }
    { \l__stex_uris_path_str }
    { \l__stex_uris_name_str }
 }
 \stex_debug:nn{uri}{returning~\stex_use_module_uri:N #1}
}
\cs_new_protected:Nn \stex_uri_from_pair:Nn {
  \peek_charcode:NTF [ {
    \__stex_uris_parse_i:Nw #1
  }{
    \__stex_uris_parse_ii:Nw #1
  } #2 \__stex_uris_end:
}

\cs_new_protected:Npn \__stex_uris_parse_i:Nw #1 [#2] #3 \__stex_uris_end: {
  \stex_uri_from_pair:Nnn #1 {#2} {#3}
}

\cs_new_protected:Npn \__stex_uris_parse_ii:Nw #1 #2 \__stex_uris_end: {
  \stex_uri_from_pair:Nnn #1 {} {#2}
}
\cs_new:Nn \stex_use_symbol_uri:N {
  \exp_after:wN \__stex_uris_symbol:nnnn #1
}
\cs_new:Nn \stex_use_symbol_uri:n {
  \__stex_uris_symbol:nnnn #1
}
\cs_new:Ne \__stex_uris_symbol:nnnn {
  \exp_not:N \stex_archive_base:n{#1} \tl_to_str:n{?a=} #1
  \exp_not:N \tl_if_empty:nF{#2}{
    \c_ampersand_str\tl_to_str:n{p=}#2
  }
  \c_ampersand_str\tl_to_str:n{m=}#3
  \c_ampersand_str\tl_to_str:n{s=}#4
}
\cs_new:Nn \stex_new_symbol_uri:n {
  \l_stex_current_module_uri { \tl_to_str:n{ #1 } }
}
\cs_new:Nn \stex_new_symbol_uri:nn {
  #1 { #2 }
}

\cs_new:Nn \stex_symbol_uri_archive:N {
  \exp_after:wN \use_i:nnnn #1
}
\cs_new:Nn \stex_symbol_uri_path:N {
  \exp_after:wN \use_ii:nnnn #1
}
\cs_new:Nn \stex_symbol_uri_module:N {
  \exp_after:wN \__stex_uris_first_three:nnnn #1
}
\cs_new:Nn \stex_symbol_uri_module:n {
  \__stex_uris_first_three:nnnn #1
}

\cs_new:Nn \__stex_uris_first_three:nnnn {
  {#1}{#2}{#3}
}
\cs_new:Nn \stex_symbol_uri_name:N {
  \exp_after:wN \use_iv:nnnn #1
}
\cs_new:Nn \stex_symbol_uri_name:n {
  \use_iv:nnnn #1
}
\tl_new:N \g__stex_doc_title_tl

\cs_new_protected:Npn \stexdoctitle #1 {
  \tl_gset:Nn \g__stex_doc_title_tl { #1 }
  \global\def\stexdoctitle##1{}
}
\cs_new_protected:Nn \__stex_doc_set_title:n {
  \stex_if_smsmode:F{
    \gdef\stexdoctitle##1{}
    \stex_debug:nn{title}{Setting~title~to:~\tl_to_str:n{#1}}
    \tl_gset:Nn \g__stex_doc_title_tl { #1 }
    \__stex_doc_title_html:
  }
}

\cs_new_protected:Nn \__stex_doc_title_html: {
  \stex_if_do_html:T{
    \stex_annotate_invisible:nn{data-shtml-doctitle={}}{ \hbox{\g__stex_doc_title_tl} }
  }
}

\AtBeginDocument {
  \tl_if_empty:NTF \g__stex_doc_title_tl {
    \cs_set_eq:NN \stexdoctitle \__stex_doc_set_title:n
  }{
    \gdef\stexdoctitle#1{}
    \__stex_doc_title_html:
  }

  \cs_set_eq:NN \__stex_doc_maketitle: \maketitle
  \protected\gdef\maketitle{
    \tl_if_empty:NF \@title {
      \exp_args:No \stexdoctitle \@title
    }
    \__stex_doc_maketitle:
  }
}
\int_new:N \l_stex_current_section_level_int
\str_set:Nn \l_stex_current_section_level_str {document}
\cs_set_protected:Npn \currentsectionlevel {
  \stex_if_do_html:TF{
    \stex_annotate:nn{data-shtml-currentsectionlevel={},data-shtml-capitalize=false}{}
  }{
   \l_stex_current_section_level_str
  }
  \tl_if_exist:NT\xspace\xspace
}

\cs_set_protected:Npn \Currentsectionlevel {
  \stex_if_do_html:TF{
    \stex_annotate:nn{data-shtml-currentsectionlevel={},data-shtml-capitalize=true}{}
  }{
    \exp_after:wN \uppercase \l_stex_current_section_level_str
  }
  \tl_if_exist:NT\xspace\xspace
}
\stex_keys_define:nnnn{ sfragment }{
  \tl_clear:N \l_stex_key_short_tl
}{
  short   .tl_set:N   = \l_stex_key_short_tl
}{id}

\NewDocumentEnvironment{sfragment}{ O{} m}{
  \stex_keys_set:nn{sfragment}{#1}
  \__stex_doc_do_section:n{#2}
  \_stex_do_id: % TODO
}{
  \_sfragment_end:
}

\cs_new_protected:Npn \__stex_doc_do_section:n {
  \int_case:nnF \l_stex_current_section_level_int {
    {0}{\cs_if_exist:NTF \thepart {\_sfragment_do_level:nn{part}}{
      \int_incr:N \l_stex_current_section_level_int
      \__stex_doc_do_section:n
    }}
    {1}{\cs_if_exist:NTF \thechapter {\_sfragment_do_level:nn{chapter}}{
      \int_incr:N \l_stex_current_section_level_int
      \__stex_doc_do_section:n
    }}
    {2}{\_sfragment_do_level:nn{section}}
    {3}{\_sfragment_do_level:nn{subsection}}
    {4}{\_sfragment_do_level:nn{subsubsection}}
    {5}{\_sfragment_do_level:nn{paragraph}}
  }{\_sfragment_do_level:nn{subparagraph}}
}

\stex_if_html_backend:TF {
  \cs_new_protected:Nn \_sfragment_do_level:nn {
    \stexdoctitle{#2}
    \par
    \begin{stex_env_node}{section}{data-shtml-section={\int_use:N \l_stex_current_section_level_int}}
      \noindent\stex_html_node:nnn{h1}{data-shtml-title={}}{
        \_stex_annotate_force_break:n{#2}
      }\par
  }
  \cs_new_protected:Nn \_sfragment_end: {
    \end{stex_env_node}
  }
}{
  \cs_new_protected:Nn \_sfragment_do_level:nn {
    \stexdoctitle{#2}
    \tl_if_empty:NTF \l_stex_key_short_tl {
      \use:c{#1}
    }{
      \exp_args:Nne \use:nn{\use:c{#1}}{[\exp_args:No \exp_not:n \l_stex_key_short_tl]}
    }{#2}
    \int_incr:N \l_stex_current_section_level_int
    \tl_set:Nn\l_stex_current_section_level_str{#1}
  }
  \cs_new_protected:Nn \_sfragment_end: {}
}
\bool_new:N \l__stex_doc_titlefragment_bool

\NewDocumentEnvironment{titlefragment}{ O{} m}{
  \stex_keys_set:nn{sfragment}{#1}
  \cs_if_exist:NTF \maketitle {
    \bool_set_true:N \l__stex_doc_titlefragment_bool
    \title{#2}
    \tl_if_empty:NF \l_stex_key_short_tl {
      \cs_if_exist:NT \shorttitle {
        \exp_args:No \shorttitle \l_stex_key_short_tl
      }
    }
    \stexdoctitle{#2}
    \maketitle
  }{
    \bool_set_false:N \l__stex_doc_titlefragment_bool
    \__stex_doc_do_section:n{#2}
    \_stex_do_id:
  }
}{
    \bool_if:NF \l__stex_doc_titlefragment_bool \_sfragment_end:
}
\cs_new_protected:Nn \__stex_doc_skip_section_i: {
  \int_case:nn \l_stex_current_section_level_int {
    {0}{\cs_if_exist:NF \thepart {
      \int_incr:N \l_stex_current_section_level_int \__stex_doc_skip_section_i:
    }}
    {1}{\cs_if_exist:NF \thechapter {
      \int_incr:N \l_stex_current_section_level_int \__stex_doc_skip_section_i:
    }}
  }
  \int_incr:N \l_stex_current_section_level_int
}

\stex_if_html_backend:TF {
  \cs_new_protected:Nn \__stex_doc_skip_section: {
    \__stex_doc_skip_section_i:
    \begin{stex_annotate_env}{data-shtml-skipsection={\int_use:N \l_stex_current_section_level_int}}
    \_stex_annotate_force_break:n{}
  }
}{
  \cs_set_eq:NN \__stex_doc_skip_section: \__stex_doc_skip_section_i:
}

\NewDocumentEnvironment{blindfragment}{}{
  \__stex_doc_skip_section:
}{
  \stex_if_html_backend:T{
    \stex_annotate_invisible:n{~}
    \end{stex_annotate_env}
  }
}
\cs_new_protected:Npn \skipfragment {
  \int_case:nnF \l_stex_current_section_level_int {
    {0}{\cs_if_exist:NTF \thepart {\stepcounter{part}}{
      \int_incr:N \l_stex_current_section_level_int
      \skipfragment
    }}
    {1}{\cs_if_exist:NTF \thechapter {\stepcounter{chapter}}{
      \int_incr:N \l_stex_current_section_level_int
      \skipfragment
    }}
    {2}{\stepcounter{section}}
    {3}{\stepcounter{subsection}}
    {4}{\stepcounter{subsubsection}}
    {5}{\stepcounter{paragraph}}
  }{\stepcounter{subparagraph}}
}
\cs_new_protected:Npn \setsectionlevel #1 {
  \str_case:nnF{#1}{
    {part}{\int_set:Nn \l_stex_current_section_level_int 0}
    {chapter}{\int_set:Nn \l_stex_current_section_level_int 1}
    {section}{\int_set:Nn \l_stex_current_section_level_int 2}
    {subsection}{\int_set:Nn \l_stex_current_section_level_int 3}
    {subsubsection}{\int_set:Nn \l_stex_current_section_level_int 4}
    {paragraph}{\int_set:Nn \l_stex_current_section_level_int 5}
  }{
    \int_set:Nn \l_stex_current_section_level_int 6
  }
  \cs_if_eq:NNTF\@onlypreamble\@notprerr{
    \stex_annotate_invisible:nn{data-shtml-sectionlevel={\int_use:N\l_stex_current_section_level_int}}{}
  }{}
}
\stex_if_html_backend:T{
  \cs_new_protected:Nn \__stex_doc_check_topsect: {
    \int_case:nnF \l_stex_current_section_level_int {
      {0}{\cs_if_exist:NTF \thepart {
        \stex_annotate_invisible:nn{data-shtml-sectionlevel=0}{}
      }{
        \int_incr:N \l_stex_current_section_level_int
        \__stex_doc_check_topsect:
      }}
      {1}{\cs_if_exist:NTF \thechapter {
        \stex_annotate_invisible:nn{data-shtml-sectionlevel=1}{}
      }{
        \int_incr:N \l_stex_current_section_level_int
        \__stex_doc_check_topsect:
      }}
    }{
      \stex_annotate_invisible:nn{data-shtml-sectionlevel={\int_use:N\l_stex_current_section_level_int}}{}
    }
  }
  \AtBeginDocument{\__stex_doc_check_topsect:}
}
\bool_if:NF \c_stex_no_frontmatter_bool {
  \cs_new_protected:Nn \__stex_doc_x_matter: {
    \cs_if_exist:NTF\frontmatter{
      \let\__stex_doc_orig_frontmatter\frontmatter
      \let\frontmatter\relax
    }{
      \tl_set:Nn\__stex_doc_orig_frontmatter{
        \clearpage
        %\@mainmatterfalse
        \pagenumbering{roman}
      }
    }
    \cs_if_exist:NTF\backmatter{
      \let\__stex_doc_orig_backmatter\backmatter
      \let\backmatter\relax
    }{
      \tl_set:Nn\__stex_doc_orig_backmatter{
        \clearpage
        %\@mainmatterfalse
        \pagenumbering{roman}
      }
    }
    \newenvironment{frontmatter}{
      \__stex_doc_orig_frontmatter
    }{
      \cs_if_exist:NTF\mainmatter{
        \mainmatter
      }{
        \clearpage
        %\@mainmattertrue
        \pagenumbering{arabic}
      }
    }
    \newenvironment{backmatter}{
      \__stex_doc_orig_backmatter
    }{
      \cs_if_exist:NTF\mainmatter{
        \mainmatter
      }{
        \clearpage
        %\@mainmattertrue
        \pagenumbering{arabic}
      }
    }
  }
  \AtBeginDocument \__stex_doc_x_matter:
}
\int_new:N \l__stex_refs_unnamed_counter_int

\cs_new_protected:Nn \_stex_ref_new_id:n {
  \str_if_empty:nTF {#1}{
    \int_gincr:N \l__stex_refs_unnamed_counter_int
    \str_set:Ne \l__stex_refs_str {REF\int_use:N \l__stex_refs_unnamed_counter_int}
  }{
    \str_set:Nn \l__stex_refs_str {#1}
  }
}

\cs_new_protected:Nn \stex_ref_new_doc_target:n {
  \_stex_ref_new_id:n{#1}
}

\NewDocumentCommand \sreflabel {m} {}
\newcommand\srefsetin[3][]{}
\NewDocumentCommand \sref { O{} m O{}}{???}
\NewDocumentCommand \extref { O{} m m}{???}

\cs_new_protected:Nn \stex_ref_new_symbol:n {}
\cs_new_protected:Nn \stex_ref_new_sym_target:n {}
\cs_new_protected:Nn \stex_ref_new_sym_target:nn {}
\NewDocumentCommand \srefsym { m m }{ #2 }
\cs_new_protected:Npn \srefsymuri #1 {}
\NewDocumentCommand \inputref { O{} m}{
  \stex_in_archive:nn{#1}{
    \stex_document_uri_from_archive_file:Nn \l__stex_inputs_uri {#2}
    \__stex_inputs_ref:n{#2}
  }
}

\stex_if_html_backend:TF{
  \str_set:Nn \c__stex_inputs_ref_pre_str {<span~data-shtml-inputref="}
  \str_set:Nn \c__stex_inputs_ref_post_str {"~><!-----></span>}
  \cs_new_protected:Nn \__stex_inputs_ref:n {
    \IfFileExists{\stex_source_path:n {#1}}{
      \relax
      \exp_args:Ne\stex_html_literal:n{
        \c__stex_inputs_ref_pre_str
        \stex_use_document_uri:N\l__stex_inputs_uri
        \c__stex_inputs_ref_post_str
      }
    }{
      \stex_input_with_hooks:Ne\l__stex_inputs_uri {\stex_source_path:n {#1}}
    }
  }
}{
  \cs_new_protected:Nn \__stex_inputs_ref:n {
    \begingroup
      \inputreftrue
      \let \l_stex_metatheory_uri \c_stex_default_metatheory
      %\seq_clear:N \l_stex_all_modules_seq
      \stex_undefine:N \l_stex_current_module_uri
      \stex_debug:nn{inputref}{Inputrefing~document~\stex_use_document_uri:N \l__stex_inputs_uri{}~at~\stex_source_path:n{#1}}
      \stex_input_with_hooks:Ne\l__stex_inputs_uri{\stex_source_path:n {#1}}
    \endgroup
  }
}
\NewDocumentCommand \mhinput { O{} m}{
  \stex_in_archive:nn {#1} {
    \stex_document_uri_from_archive_file:Nn \l__stex_inputs_uri {#2}
    \ifinputref
      \stex_input_with_hooks:Ne\l__stex_inputs_uri{\stex_source_path:n {#2}}
    \else
      \inputreftrue
      \stex_input_with_hooks:Ne\l__stex_inputs_uri{\stex_source_path:n {#2}}
      \inputreffalse
    \fi
  }
}
\newif \ifinputref \inputreffalse
\stex_if_html_backend:TF{
  \newcommand \IfInputref[2]{
    \stex_annotate:nn{data-shtml-ifinputref=true}{#1}
    \stex_annotate:nn{data-shtml-ifinputref=false}{#2}
  }
}{
  \newcommand \IfInputref[2]{
    \ifinputref #1 \else #2 \fi
  }
}
\newcommand \libinput [2][] {
  \stex_in_archive:nn{#1}{
    \__stex_inputs_up_archive:nn{#2}{tex}
    \stex_debug:nn{lib}{Result:~\seq_use:Nn \l__stex_inputs_libinput_files_seq ,}
    \seq_if_empty:NTF \l__stex_inputs_libinput_files_seq {
      \msg_error:nnnn{stex}{error/nofile}{\libinput}{#2.tex}
    }{
      \seq_map_function:NN \l__stex_inputs_libinput_files_seq \input
    }
  }
}
\newcommand\libusepackage[2][]{
  \__stex_inputs_up_archive:nn{#2}{sty}
  \int_compare:nNnTF {\seq_count:N \l__stex_inputs_libinput_files_seq} = 1 {
    \str_set:Ne \l__stex_inputs_tmp_str {\seq_item:Nn \l__stex_inputs_libinput_files_seq 1}
    \exp_args:Nne \use:n {\usepackage[#1]} {
      \str_range:Nnn\l__stex_inputs_tmp_str 1 {-5}
    }
  }{
    \msg_fatal:nnnn{stex}{error/nofile}{\libusepackage}{#1.sty}
  }
}
\newcommand \libusetikzlibrary [2][] {
  \cs_if_exist:NF \usetikzlibrary {
    \msg_error:nnx{stex}{error/notikz}{\tl_to_str:n{\libusetikzlibrary}}
  }
  \tl_if_empty:nTF{#1}{
    \__stex_inputs_usetikzlibrary:n{#2}
  }{
    \stex_in_archive:nn{#1}{\__stex_inputs_usetikzlibrary:n{#2}}
  }
}

\cs_new_protected:Nn \__stex_inputs_usetikzlibrary:n{
  \__stex_inputs_up_archive:nn{tikzlibrary#1}{code.tex}
  \int_compare:nNnTF {\seq_count:N \l__stex_inputs_libinput_files_seq} = 1 {
    \exp_args:Nne \__stex_inputs_usetikzlibrary_i:nn{#1}{ \seq_item:Nn \l__stex_inputs_libinput_files_seq 1 }
  }{
    \msg_fatal:nnnn{stex}{error/nofile}{\libusetikzlibrary}{tikzlibrary#1.code.tex}
  }
}

\cs_new_protected:Nn \__stex_inputs_usetikzlibrary_i:nn {
  \pgfkeys@spdef\pgf@temp{#1}
  \expandafter\ifx\csname tikz@library@\pgf@temp @loaded\endcsname\relax%
  \expandafter\global\expandafter\let\csname tikz@library@\pgf@temp @loaded\endcsname=\pgfutil@empty%
  \expandafter\edef\csname tikz@library@#1@atcode\endcsname{\the\catcode`\@}
  \expandafter\edef\csname tikz@library@#1@barcode\endcsname{\the\catcode`\|}
  \expandafter\edef\csname tikz@library@#1@dollarcode\endcsname{\the\catcode`\$}
  \catcode`\@=11
  \catcode`\|=12
  \catcode`\$=3
  \pgfutil@InputIfFileExists{#2}{}{}
  \catcode`\@=\csname tikz@library@#1@atcode\endcsname
  \catcode`\|=\csname tikz@library@#1@barcode\endcsname
  \catcode`\$=\csname tikz@library@#1@dollarcode\endcsname
}
\newcommand \addmhbibresource [2][] {
  \stex_in_archive:nn{#1}{
    \__stex_inputs_up_archive:nn{#2}{bib}
    \stex_debug:nn{lib}{Result:~\seq_use:Nn \l__stex_inputs_libinput_files_seq ,}
    \seq_if_empty:NTF \l__stex_inputs_libinput_files_seq {
      \msg_error:nnnn{stex}{error/nofile}{\addmhbibresource}{#2.bib}
    }{
      \seq_map_function:NN \l__stex_inputs_libinput_files_seq \addbibresource
    }
  }
}
\cs_new_protected:Nn \__stex_inputs_up_archive:nn {
  \tl_if_exist:NF \l_stex_current_archive {
    \msg_error:nnn{stex}{error/notinarchive}\libinput
  }
  \seq_clear:N \l__stex_inputs_libinput_files_seq
  \seq_set_split:Nne \l__stex_inputs_path_seq / {\stex_archive_path:N \l_stex_current_archive}
  \seq_set_split:Nne \l__stex_inputs_id_seq / {\stex_archive_id:N \l_stex_current_archive}
  \seq_map_inline:Nn \l__stex_inputs_id_seq {
    \seq_pop_right:NN \l__stex_inputs_path_seq \l_tmpa_tl
  }
  \stex_debug:nn{lib}{Checking~#1~in~\seq_use:Nn \l__stex_inputs_path_seq /}

  \bool_while_do:nn { ! \seq_if_empty_p:N \l__stex_inputs_id_seq }{
    \str_set:Ne \l__stex_inputs_path_str {\stex_file_use:N \l__stex_inputs_path_seq / meta-inf / lib / #1.#2}
    \stex_debug:nn{lib}{Checking~\l__stex_inputs_path_str}
    \IfFileExists{ \l__stex_inputs_path_str }{
      \exp_args:NNo \seq_if_in:NnF \l__stex_inputs_libinput_files_seq \l__stex_inputs_path_str {
        \seq_put_right:No \l__stex_inputs_libinput_files_seq \l__stex_inputs_path_str
      }
    }{}
    \seq_pop_left:NN \l__stex_inputs_id_seq \l__stex_inputs_path_str
    \seq_put_right:No \l__stex_inputs_path_seq \l__stex_inputs_path_str
  }

  \str_set:Ne \l__stex_inputs_path_str {\stex_file_use:N \l__stex_inputs_path_seq / lib / #1.#2}
  \stex_debug:nn{lib}{Checking~\l__stex_inputs_path_str}
  \IfFileExists{ \l__stex_inputs_path_str }{
    \exp_args:NNo \seq_if_in:NnF \l__stex_inputs_libinput_files_seq \l__stex_inputs_path_str {
      \seq_put_right:No \l__stex_inputs_libinput_files_seq \l__stex_inputs_path_str
    }
  }{}
}
\ltx@ifpackageloaded{graphicx}{\use:n}{\AtEndOfPackageFile{graphicx}}{
  \define@key{Gin}{archive}{
    \stex_in_archive:nn{#1}{}
    \str_set:Ne \Gin@mhrepos {
      \stex_source_path:nn{#1}{}
    }
  }
  \providecommand\mhgraphics[2][]{
    \str_set:Ne \Gin@mhrepos {
      \stex_source_path:n{}
    }
    \setkeys{Gin}{#1}
    \includegraphics[#1]{ \Gin@mhrepos / #2 }
  }
  \providecommand\cmhgraphics[2][]{\begin{center}\mhgraphics[#1]{#2}\end{center}}
}
\ltx@ifpackageloaded{listings}{\use:n}{\AtEndOfPackageFile{listings}}{
  \define@key{lst}{archive}{
    \stex_in_archive:nn{#1}{}
    \str_set:Ne \lst@mhrepos{
      \stex_source_path:nn{#1}{}
    }
  }
  \newcommand\lstinputmhlisting[2][]{%
    \str_set:Ne \lst@mhrepos{
      \stex_source_path:n{}
    }
    \setkeys{lst}{#1}%
    \lstinputlisting[#1]{\lst@mhrepos / #2}}
  \newcommand\clstinputmhlisting[2][]{\begin{center}\lstinputmhlisting[#1]{#2}\end{center}}
}
\ltx@ifpackageloaded{tikzinput}{\use:n}{\AtEndOfPackageFile{tikzinput}}{
  \define@key{Gin}{archive}{
    \stex_in_archive:nn{#1}{}
    \str_set:Ne \Gin@mhrepos{
      \stex_source_path:nn{#1}{}
    }
    \str_set:Ne \l__stex_inputs_gin_repo_str {#1}
  }
  \newcommand\mhtikzinput[2][]{%
    \str_clear:N \l__stex_inputs_gin_repo_str
    \str_set:Ne \Gin@mhrepos{
      \stex_source_path:n{}
    }
    \setkeys{Gin}{#1}%
    \exp_args:No \stex_in_archive:nn \l__stex_inputs_gin_repo_str {
      \tikzinput[#1]{\Gin@mhrepos / #2}
    }
  }
  \newcommand\cmhtikzinput[2][]{\begin{center}\mhtikzinput[#1]{#2}\end{center}}
}
\cs_new:Nn \__stex_modules_macro_short:nnn {
  #1 ? #2 ? #3
}
\cs_new:Nn \_stex_symbol_macro:N {
  c_stex_module_ \exp_after:wN \__stex_modules_macro_short:nnn #1 _symbols_prop
}
\cs_new:Nn \_stex_symbol_macro:n {
  c_stex_module_ \__stex_modules_macro_short:nnn #1 _symbols_prop
}
\cs_new:Nn \_stex_morphisms_macro:N {
  c_stex_module_ \exp_after:wN \__stex_modules_macro_short:nnn #1 _morphisms_prop
}
\cs_new:Nn \_stex_morphisms_macro:n {
  c_stex_module_ \__stex_modules_macro_short:nnn #1 _morphisms_prop
}
\cs_new:Nn \_stex_notations_macro:N {
  c_stex_module_ \exp_after:wN \__stex_modules_macro_short:nnn #1 _notations_prop
}
\cs_new:Nn \_stex_notations_macro:n {
  c_stex_module_ \__stex_modules_macro_short:nnn #1 _notations_prop
}
\cs_new:Nn \_stex_module_code_macro:N {
  c_stex_module_ \exp_after:wN \__stex_modules_macro_short:nnn #1 _code
}
\cs_new:Nn \_stex_module_code_macro:n {
  c_stex_module_ \__stex_modules_macro_short:nnn #1 _code
}
\seq_new:N \l_stex_all_modules_seq
\tl_new:N \l_stex_metatheory_uri

\stex_keys_define:nnnn{smodule}{
  \str_clear:N \l_stex_key_sig_str
}{
  meta          .code:n       = {
    \tl_if_empty:nTF {#1}{
      \tl_clear:N \l_stex_metatheory_uri
    }{
      \stex_uri_from_pair:Nn \l_stex_metatheory_uri { #1 }
    }
  },
  %ns            .code:n       = {
  %  \stex_uri_resolve:Ne \l_stex_current_ns_uri { #1 }
  %} ,
  %lang          .code:n       = {
  %  \stex_set_language:n { #1 }
  %} ,
  sig           .str_set_x:N  = \l_stex_key_sig_str ,
  %creators      .code:n       = {} , % todo ?
  %contributors  .code:n       = {} , % todo ?
}{id, title, style, deprecate}

\stex_if_html_backend:T {
  \cs_new_protected:Nn \__stex_modules_html_annots: {
    \exp_args:Nne \begin{stex_annotate_env} {
      data-shtml-theory={\stex_module_uri_name:N \l_stex_current_module_uri}
      %data-shtml-language={ \l_stex_current_language_str},
      \str_if_empty:NF\l_stex_key_sig_str {, data-shtml-signature={\l_stex_key_sig_str}}
      \tl_if_empty:NF \l_stex_metatheory_uri {,
        data-shtml-metatheory={\stex_use_module_uri:N \l_stex_metatheory_uri}
      }
    }
    \stex_annotate_invisible:n{}
  }
}

\stex_new_stylable_env:nnnnnnn {module} {O{} m}{
  \stex_keys_set:nn { smodule }{ #1 }
  \tl_set_eq:NN \thistitle \l_stex_key_title_tl
  \tl_if_empty:NF \thistitle {
    \exp_args:No \stexdoctitle \thistitle
  }
  \stex_module_setup:n { #2 }

  \stex_if_do_html:T \__stex_modules_html_annots:
  \stex_if_smsmode:F {
    \str_set:Ne \thismoduleuri {\stex_use_module_uri:N \l_stex_current_module_uri }
    \str_set:Nn \thismodulename {#2}
    \stex_style_apply:
  }
  \stex_smsmode_do:
}{
  \stex_close_module:
  \stex_if_smsmode:F \stex_style_apply:
  \stex_if_do_html:T{ \end{stex_annotate_env} }
}{}{}{s}
\cs_new_protected:Npn \stex_module_setup:n {
  \stex_if_in_module:TF \__stex_modules_nested:n \__stex_modules_top:n
}

\cs_new_protected:Nn \__stex_modules_top:n {
  \str_if_empty:NTF \l_stex_key_sig_str
    \_stex_module_setup_top_nosig:n \__stex_modules_top_sig:n {#1}
  \g_stex_every_module_tl
  \tl_if_empty:NF \l_stex_metatheory_uri {
    \stex_debug:nn{modules}{loading~metatheory~\stex_use_module_uri:N \l_stex_metatheory_uri}
    \__stex_modules_load_meta:
  }
}
\cs_new_protected:Nn \_stex_module_setup_top_nosig:n {
  \stex_metagroup_new:
  \tl_set:Ne \l__stex_modules_uri { \stex_new_module_uri:n {#1} }
  \stex_debug:nn{module}{URI:\stex_use_module_uri:N \l__stex_modules_uri}
  \exp_args:No \stex_if_module_exists:NTF \l__stex_modules_uri {
    \stex_debug:nn{modules}{(already exists)}
  }{
    \tl_gclear:c{ \_stex_module_code_macro:N \l__stex_modules_uri }
    \prop_gclear:c{ \_stex_morphisms_macro:N \l__stex_modules_uri }
    \prop_gclear:c{ \_stex_symbol_macro:N \l__stex_modules_uri }
    \prop_gclear:c{ \_stex_notations_macro:N \l__stex_modules_uri }
  }
  \tl_set_eq:NN \l_stex_current_module_uri \l__stex_modules_uri
  \seq_put_right:No \l_stex_all_modules_seq \l__stex_modules_uri
}
\bool_new:N \l_stex_in_meta_bool

\cs_new_protected:Nn \__stex_modules_load_meta: {
  \exp_after:wN \stex_execute_in_module:n \exp_after:wN {
    \exp_after:wN \__stex_modules_load_meta_i:n \exp_after:wN { \l_stex_metatheory_uri }
  }
}

\cs_new_protected:Nn \__stex_modules_load_meta_i:n {
  \bool_if:NTF \l_stex_in_meta_bool {
    \stex_activate_module:n {#1}
  }{
    \bool_set_true:N \l_stex_in_meta_bool
    \stex_activate_module:n {#1}
    \bool_set_false:N \l_stex_in_meta_bool
  }
}
\cs_new_protected:Nn \__stex_modules_top_sig:n {
  \stex_debug:nn{modules}{Signature:\l_stex_key_sig_str}
  \stex_metagroup_new:
  \tl_set:Ne \l__stex_modules_uri { \stex_new_module_uri:n {#1} }
  \stex_debug:nn{module}{URI:\stex_use_module_uri:N \l__stex_modules_uri}
  \stex_if_module_exists:NTF \l__stex_modules_uri {
    \stex_debug:nn{modules}{(already exists)}
    \stex_activate_module:N \l__stex_modules_uri
  }{
    \stex_debug:nn{modules}{(needs loading)}
    \__stex_modules_load_sig:
  }
  \tl_set_eq:NN \l_stex_current_module_uri \l__stex_modules_uri
}

\cs_new_protected:Nn \__stex_modules_load_sig: {
  \stex_file_split_off_lang:NN \l__stex_modules_sigfile \g_stex_current_file
  \tl_set:Ne \l__stex_modules_sig {
    \exp_args:NNo \stex_document_uri_with_language:Nn
      \l_stex_current_document_uri \l_stex_key_sig_str
  }
  \stex_debug:nn{modules}{Loading~signature~\stex_use_document_uri:N \l__stex_modules_sig;~file~\stex_file_use:N \l__stex_modules_sigfile . \l_stex_key_sig_str . tex}
  \exp_args:NNe \stex_file_in_smsmode:Nn \l__stex_modules_sig {
    \stex_file_use:N \l__stex_modules_sigfile . \l_stex_key_sig_str . tex
  }
  \stex_activate_module:N \l__stex_modules_uri
}
\cs_new_protected:Nn \__stex_modules_nested:n {
  \stex_metagroup_new:
  \stex_debug:nn{module}{Nested~module~#1~in~\stex_use_module_uri:N \l_stex_current_module_uri}
  \tl_set:Ne \l__stex_modules_uri { \stex_new_module_uri:n{#1} }
  \stex_debug:nn{module}{URI:\stex_use_module_uri:N \l__stex_modules_uri}
  \exp_args:No \stex_if_module_exists:NTF \l__stex_modules_uri {
    \stex_debug:nn{modules}{(already exists)}
  }{
    \tl_gclear:c{ \_stex_module_code_macro:N \l__stex_modules_uri }
    \prop_gclear:c{ \_stex_morphisms_macro:N \l__stex_modules_uri }
    \prop_gclear:c{ \_stex_symbol_macro:N \l__stex_modules_uri }
    \prop_gclear:c{ \_stex_notations_macro:N \l__stex_modules_uri }
  }
  \tl_set_eq:NN \l_stex_current_module_uri \l__stex_modules_uri
  \seq_put_right:No \l_stex_all_modules_seq \l__stex_modules_uri
}
\cs_new_protected:Nn \stex_close_module: {
  \bool_if:NT \c_stex_persist_write_mode_bool \__stex_modules_persist_module:
  \stex_debug:nn{module}{
    Closing~module~\stex_use_module_uri:N \l_stex_current_module_uri^^J
    Code:~\cs_meaning:c{ \_stex_module_code_macro:N \l_stex_current_module_uri }^^J
    Imports:~ \exp_after:wN \prop_to_keyval:N \cs:w \_stex_morphisms_macro:N \l_stex_current_module_uri \cs_end:^^J
    Declarations:~ \exp_after:wN \prop_to_keyval:N \cs:w \_stex_symbol_macro:N \l_stex_current_module_uri \cs_end:^^J
    Notations:~ \exp_after:wN \prop_to_keyval:N \cs:w \_stex_notations_macro:N \l_stex_current_module_uri \cs_end:^^J
  }
}
\cs_new_protected:Nn \__stex_modules_persist_module: {
  \stex_persist:e {
    \__stex_modules_restore_module:nnnn {\l_stex_current_module_uri}{
      \exp_after:wN \prop_to_keyval:N \cs:w
        \_stex_morphisms_macro:N \l_stex_current_module_uri
      \cs_end:
    }{
      \exp_after:wN \prop_to_keyval:N \cs:w
        \_stex_symbol_macro:N \l_stex_current_module_uri
      \cs_end:
    }{
      \exp_after:wN \exp_after:wN \exp_after:wN \exp_not:n
      \exp_after:wN \exp_after:wN \exp_after:wN
      { \cs:w \_stex_module_code_macro:N \l_stex_current_module_uri \cs_end: }
    }{}
    \prop_map_function:cN{\_stex_notations_macro:N \l_stex_current_module_uri}
      \__stex_modules_persist_nots_i:nn
    \exp_not:N \STEXRestoreNotsEnd {}
  }
}

\cs_new:Nn \__stex_modules_persist_nots_i:nn {
  \exp_not:n{#2}
}

\cs_new:Nn \__stex_modules_stringify_uri:nnn {
  {\tl_to_str:n{#1}}
  {\tl_to_str:n{#2}}
  {\tl_to_str:n{#3}}
}
\cs_new:Nn \__stex_modules_stringify_uri:nnnn {
  {\tl_to_str:n{#1}}
  {\tl_to_str:n{#2}}
  {\tl_to_str:n{#3}}
  {\tl_to_str:n{#4}}
}

\cs_new_protected:Nn \__stex_modules_restore_module:nnnn {
  \tl_set:Ne \l__stex_modules_uri { \__stex_modules_stringify_uri:nnn #1 }
  \stex_debug:nn{persist}{restoring~\stex_use_module_uri:N \l__stex_modules_uri}
  \prop_gset_from_keyval:cn{ \_stex_morphisms_macro:N \l__stex_modules_uri }{#2}
  \prop_gset_from_keyval:cn{\_stex_symbol_macro:N \l__stex_modules_uri}{#3}
  \prop_map_inline:cn{\_stex_symbol_macro:N \l__stex_modules_uri}{
    \stex_ref_new_symbol:n{#1?##1}
  }
  \def \l_tmpa_tl { #4 }
  \exp_args:Nno \tl_gset:cn{\_stex_module_code_macro:N \l__stex_modules_uri}\l_tmpa_tl
  \prop_gclear:c{\_stex_notations_macro:N \l__stex_modules_uri}
  \group_begin:
    \catcode`_=8\relax
    \catcode`:=12\relax
    \__stex_modules_restore_nots:n
}

\quark_new:N \STEXRestoreNotsEnd

\cs_new_protected:Nn \__stex_modules_restore_nots:n {
  \__stex_modules_restore_nots_i:n
}

\cs_new_protected:Nn \__stex_modules_restore_nots_i:n {
  \tl_if_eq:nnTF{#1}{\STEXRestoreNotsEnd}{
    \group_end:
  }{
    \__stex_modules_restore_nots_ii:nnnnn {#1}
  }
}

\cs_new_protected:Nn \__stex_modules_restore_nots_ii:nnnnn {
  \tl_set:Nn \l__stex_modules_tl {{#4}{#5}}
  % eliminate ## => #
  \exp_after:wN \def \exp_after:wN \l__stex_modules_tl \exp_after:wN {\l__stex_modules_tl}
  \exp_args:NNe\use:nn\prop_gput:cnn{
    {\_stex_notations_macro:N \l__stex_modules_uri}
    {\stex_use_symbol_uri:n{#1}\tl_to_str:n{?#2}}{
      {\__stex_modules_stringify_uri:nnnn #1}{\tl_to_str:n{#2}}{#3}
      \exp_args:No \exp_not:n \l__stex_modules_tl
    }
  }
  \__stex_modules_restore_nots_i:n
}
\tl_new:N \g_stex_every_module_tl
\cs_new_protected:Nn \stex_every_module:n {
  \tl_gput_right:Nn \g_stex_every_module_tl { #1 }
}
\cs_new_protected:Nn \stex_do_up_to_module:n {
  \stex_metagroup_do_in:n {#1}
}
\cs_generate_variant:Nn \stex_do_up_to_module:n {e}
\cs_new_protected:Nn \stex_execute_in_module:n { \stex_if_in_module:TF {
  \tl_gput_right:cn { \_stex_module_code_macro:N \l_stex_current_module_uri } { #1 }
  \stex_debug:nn{modules}{extending~activation~for~\stex_use_module_uri:N \l_stex_current_module_uri^^J\tl_to_str:n{#1}}
  \stex_do_up_to_module:n { #1 }
}{ #1 }}
\cs_generate_variant:Nn \stex_execute_in_module:n {e}
\prg_new_conditional:Nnn \stex_if_in_module: {p, T, F, TF} {
  \tl_if_exist:NTF \l_stex_current_module_uri
    \prg_return_true: \prg_return_false:
}
\prg_new_conditional:Nnn \stex_if_module_exists:N {p, T, F, TF} {
  \tl_if_exist:cTF { \_stex_module_code_macro:N #1 }
    \prg_return_true: \prg_return_false:
}
\prg_new_conditional:Nnn \stex_if_module_exists:n {p, T, F, TF} {
  \tl_if_exist:cTF { \_stex_module_code_macro:n {#1} }
    \prg_return_true: \prg_return_false:
}
\cs_new_protected:Nn \stex_activate_module:N {
  \exp_args:No \stex_activate_module:n #1
}

\cs_new_protected:Nn \stex_activate_module:n {
  \seq_if_in:NnF \l_stex_all_modules_seq {#1} {
    \stex_debug:nn{modules}{Activating~module~\stex_use_module_uri:n{#1}}
    \seq_put_right:Nn \l_stex_all_modules_seq {#1}
    \stex_pseudogroup:nn{
      \tl_set:Nn \l_stex_current_module_uri {#1}
      \tl_if_exist:cF { \_stex_module_code_macro:N \l_stex_current_module_uri }{
        \msg_error:nnx{stex}{error/unknownmodule}{\stex_use_module_uri:n {#1} }
      }
      \_stex_activate_symbols:
      \_stex_activate_notations:
      \stex_debug:nn{modules}{Executing:~\expandafter\meaning\csname\_stex_module_code_macro:N \l_stex_current_module_uri \endcsname}
      \use:c{ \_stex_module_code_macro:N \l_stex_current_module_uri }
    }{
      \stex_pseudogroup_restore:N \l_stex_current_module_uri
    }
    \stex_debug:nn{modules}{Activated~module~\stex_use_module_uri:n {#1} }
  }
}
\NewDocumentCommand \setmetatheory {O{} m}{
  \stex_debug:nn{metatheory}{Setting~metatheory~[#1]#2}
  \stex_uri_from_pair:Nnn \l_stex_import_uri { #1 }{ #2 }
  \stex_debug:nn{metatheory}{Here:\stex_use_module_uri:N \l_stex_import_uri
  }
  \tl_set_eq:NN \l_stex_metatheory_uri \l_stex_import_uri
  \begingroup
    \stex_require_module:N \l_stex_metatheory_uri
  \endgroup
  \stex_smsmode_do:
}
\cs_new_protected:Npn \STEXexport {
  \ExplSyntaxOn
  \__stex_modules_export:n
}
\cs_new_protected:Nn \__stex_modules_export:n {
  \stex_ignore_spaces_and_pars:#1\ExplSyntaxOff
  \tl_gput_right:cn { \_stex_module_code_macro:N \l_stex_current_module_uri } {
    \stex_ignore_spaces_and_pars: #1
  }
  \stex_smsmode_do:
}

\stex_deactivate_macro:Nn \STEXexport {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \STEXexport}
\cs_new_protected:Nn \stex_structural_feature_module:nn {
  \stex_if_do_html:TF {
    \exp_args:Nne \begin{stex_annotate_env} {
      data-shtml-feature-#2={#1}
      \str_if_empty:NF \l_stex_macroname_str {,
        data-shtml-macroname={\l_stex_macroname_str}
      }
    }
    \stex_annotate_invisible:n{}
  }\group_begin:
  \stex_module_setup:n {#1}
}

\cs_new_protected:Nn \stex_structural_feature_module_end: {
  \tl_gset_eq:NN \g_stex_last_feature_str \l_stex_current_module_str
  \stex_close_module:
  \stex_if_do_html:TF{
    \end{stex_annotate_env}
  }\group_end:
}
\tl_new:N \g__stex_smsmode_allowed_tl

\cs_new_protected:Nn \stex_sms_allow:N {
  \tl_gput_right:Nn \g__stex_smsmode_allowed_tl {#1}
}
\tl_new:N \g__stex_smsmode_allowed_escape_tl

\cs_new_protected:Nn \stex_sms_allow_escape:N {
  \tl_gput_right:Nn \g__stex_smsmode_allowed_escape_tl {#1}
}
\seq_new:N \g__stex_smsmode_allowedenvs_seq

\cs_new_protected:Nn \stex_sms_allow_env:n {
  \seq_gput_right:Ne \g__stex_smsmode_allowedenvs_seq {\tl_to_str:n{#1}}
}
\stex_sms_allow:N \makeatletter
\stex_sms_allow:N \makeatother
\stex_sms_allow:N \ExplSyntaxOn
\stex_sms_allow:N \ExplSyntaxOff
\stex_sms_allow:N \rustexBREAK
\stex_sms_allow_env:n{smodule}
\stex_sms_allow_escape:N \setmetatheory
\stex_sms_allow_escape:N \STEXexport
\tl_new:N \g__stex_smsmode_allowed_import_tl
\tl_new:N \g__stex_smsmode_import_setup_tl

\cs_new_protected:Nn \stex_sms_allow_import:Nn {
  \tl_gput_right:Nn \g__stex_smsmode_allowed_import_tl {#1}
  \tl_gput_right:Nn \g__stex_smsmode_import_setup_tl {#2}
}
\seq_new:N \g__stex_smsmode_allowed_import_env_seq

\cs_new_protected:Nn \stex_sms_allow_import_env:nn {
  \seq_gput_right:Ne \g__stex_smsmode_allowed_import_env_seq {\tl_to_str:n{#1}}
  \tl_gput_right:Nn \g__stex_smsmode_import_setup_tl {#2}
}

\tl_new:N \g_stex_sms_import_code
\bool_new:N \g__stex_smsmode_bool

\prg_new_conditional:Nnn \stex_if_smsmode: { p, T, F, TF } {
  \bool_if:NTF \g__stex_smsmode_bool \prg_return_true: \prg_return_false:
}

\seq_new:N \l__stex_smsmode_cycles_seq

\cs_new_protected:Nn \stex_file_in_smsmode:Nn {
  \seq_gclear:N \l__stex_smsmode_importmodules_seq
  \seq_gclear:N \l__stex_smsmode_sigmodules_seq
  \tl_clear:N \g_stex_sms_import_code
  \seq_if_in:NnF \l__stex_smsmode_cycles_seq {#2} {
  \group_begin:
    \seq_push:Nn \l__stex_smsmode_cycles_seq {#2}
    \let \l_stex_metatheory_uri \c_stex_default_metatheory
    \seq_clear:N \l_stex_all_modules_seq
    \stex_undefine:N \l_stex_current_module_uri
    \cs_set:Npn \stex_check_term:nn ##1 ##2 {}
    \stex_debug:nn{sms}{Loading~#2~in~\stex_use_document_uri:N #1}
    \stex_with_file_hooks:Nnn #1 {#2}{
      \__stex_smsmode_in_smsmode:n {
        \group_begin:
          \let \__stex_smsmode_do_aux_curr:N \__stex_smsmode_do_aux_imports:N
          \g__stex_smsmode_import_setup_tl
          \__stex_smsmode_start_smsmode:n{#2}
        \group_end:
        %{
          \g_stex_sms_import_code
        %}
        %\group_begin:
          \let \__stex_smsmode_do_aux_curr:N \__stex_smsmode_do_aux_normal:N
          \__stex_smsmode_start_smsmode:n{#2}
        %\group_end:
      }
    }
  \group_end:
  }
}

\cs_new_protected:Nn \__stex_smsmode_in_smsmode:n {
  \stex_suppress_html:n {
    \vbox_set:Nn \l_tmpa_box {
      \bool_set_true:N \g__stex_smsmode_bool
      #1
    }
  }
}

\quark_new:N \q__stex_smsmode_break

\cs_new_protected:Nn \__stex_smsmode_start_smsmode:n {
  \everyeof{\q__stex_smsmode_break\exp_not:N}
  \let\stex_smsmode_do:\__stex_smsmode_smsmode_do:
  \exp_after:wN \exp_after:wN \exp_after:wN
  \stex_smsmode_do:
  \cs:w @ @ input\cs_end: "#1" \relax
}
\let\stex_smsmode_do:\relax

\cs_new_protected:Nn \__stex_smsmode_smsmode_do: { \__stex_smsmode_do:w }

\cs_new_protected:Npn \__stex_smsmode_do:w #1 {
  \exp_args:Ne \tl_if_empty:nTF { \tl_tail:n{ #1 }}{
    \__stex_smsmode_check_cs:NNn \__stex_smsmode_do_aux:N \__stex_smsmode_do:w { #1 }
  }{
    \__stex_smsmode_do:w
  }
}

\cs_new:Nn \__stex_smsmode_check_cs:NNn {
  \exp_after:wN\if\exp_after:wN\relax\exp_not:N#3
  \exp_after:wN#1\exp_after:wN#3\else
  \exp_after:wN#2\fi
}

\cs_new_protected:Nn \__stex_smsmode_do_aux:N {
  \cs_if_eq:NNF #1 \q__stex_smsmode_break {
    \__stex_smsmode_do_aux_curr:N #1
  }
}

\cs_new_protected:Nn \__stex_smsmode_do_aux_normal:N {
  \tl_if_in:NnTF \g__stex_smsmode_allowed_tl {#1} {
    \stex_debug:nn{sms}{Executing~\tl_to_str:n{#1}}
    #1\__stex_smsmode_do:w
  }{
    \tl_if_in:NnTF \g__stex_smsmode_allowed_escape_tl {#1} {
      \stex_debug:nn{sms}{Executing~escaped~\tl_to_str:n{#1}}
      #1
    }{
      \cs_if_eq:NNTF \begin #1 {
        \__stex_smsmode_check_begin:Nn \g__stex_smsmode_allowedenvs_seq
      }{
        \cs_if_eq:NNTF \end #1 {
          \__stex_smsmode_check_end:Nn \g__stex_smsmode_allowedenvs_seq
        }{
          \__stex_smsmode_do:w
        }
      }
    }
  }
}

\cs_new_protected:Nn \__stex_smsmode_do_aux_imports:N {
  \tl_if_in:NnTF \g__stex_smsmode_allowed_import_tl {#1} {
    \stex_debug:nn{sms}{Executing~\tl_to_str:n{#1}~in~import}
    #1
  }{
    \cs_if_eq:NNTF \begin #1 {
      \__stex_smsmode_check_begin:Nn \g__stex_smsmode_allowed_import_env_seq
    }{
      \cs_if_eq:NNTF \end #1 {
        \__stex_smsmode_check_end:Nn \g__stex_smsmode_allowed_import_env_seq
      }{
        \__stex_smsmode_do:w
      }
    }
  }
}

\cs_new_protected:Nn \__stex_smsmode_check_begin:Nn {
  \seq_if_in:NeTF #1 { \tl_to_str:n{#2} }{
    \stex_debug:nn{sms}{Environment~#2}
    \begin{#2}
  }{
    \__stex_smsmode_do:w
  }
}
\cs_new_protected:Nn \__stex_smsmode_check_end:Nn {
  \seq_if_in:NeTF #1 { \tl_to_str:n{#2} }{
    \stex_debug:nn{sms}{End~Environment~#2}
    \end{#2}\__stex_smsmode_do:w
  }{
    \__stex_smsmode_do:w
  }
}
\cs_new_protected:Nn \stex_require_module:N {
  \stex_if_module_exists:NF #1 {
    \__stex_import_load_module:NF #1 {
      \msg_error:nnx{stex}{error/unknownmodule}{\stex_use_module_uri:N #1}
    }
  }
  \stex_activate_module:N #1
}

\cs_new_protected:Nn \stex_require_module_noerr:N {
  \stex_if_module_exists:NF #1 {
    \__stex_import_load_module:NF #1 {}
    \str_if_empty:NF \l__stex_import_file_str {
      \stex_activate_module:N #1
    }
  }
}

\cs_new_protected:Nn \stex_require_module_noerr:n {
  \tl_set:Nn \l__stex_import_uri { #1 }
  \stex_require_module_noerr:N \l__stex_import_uri
}

\cs_new_protected:Npn \__stex_import_load_module:NF #1 #2 {
    \tl_set_eq:NN \l__stex_import_uri #1
    \tl_set:Ne \l__stex_import_archive_str { \stex_module_uri_archive:N #1 }
    \tl_set:Ne \l__stex_import_path_str { \stex_module_uri_path:N #1 }
    \tl_set:Ne \l__stex_import_name_str { \stex_module_uri_name:N #1 }
    \str_if_eq:NNTF \l__stex_import_archive_str \c_stex_no_archive_str {
      \str_set_eq:NN \l__stex_import_pre_str \l__stex_import_path_str
      \__stex_import_load_check:n {#2}
    }{
      \exp_args:No \stex_in_archive:nn \l__stex_import_archive_str {
        \str_set:Ne \l__stex_import_pre_str {
          \exp_args:Ne \stex_source_path:n{ \l__stex_import_path_str }
        }
        \exp_args:No \__stex_import_load_check:n {#2}
      }
    }
}

\cs_new_protected:Nn \__stex_import_load_check:n {
  \str_clear:N \l__stex_import_file_str
  \str_set_eq:NN \l__stex_import_language_str \l_stex_current_language_str
  \__stex_import_check_file:nnn{ / \l__stex_import_name_str .tex }{}{
    \__stex_import_check_file:nnn{/ \l__stex_import_name_str . \l_stex_current_language_str .tex}{}{
      \__stex_import_check_file:nnn{/ \l__stex_import_name_str .en.tex}{
        \str_set:Nn \l__stex_import_language_str {en}
      }{
        \exp_args:NNNo \seq_set_split:Nnn \l_tmpa_seq / \l__stex_import_path_str
        \seq_pop_right:NN \l_tmpa_seq \l__stex_import_name_str
        \str_set:Ne \l__stex_import_path_str { \seq_use:Nn \l_tmpa_seq /}
        \__stex_import_check_file:nnn{.tex}{}{
          \__stex_import_check_file:nnn{. \l_stex_current_language_str .tex}{}{
            \__stex_import_check_file:nnn{.en.tex}{
              \str_set:Nn \l__stex_import_language_str {en}
            }{
              #1
            }
          }
        }
      }
    }
  }
  \str_if_empty:NF \l__stex_import_file_str {
    \stex_if_smsmode:TF{
      \exp_args:NNo \exp_args:Nne \str_if_eq:nnTF{\l__stex_import_file_str}{\stex_file_use:N \g_stex_current_file}{
        \stex_debug:nn{imports}{Skipping~current~file}
      }{
        \IfFileExists{ \l__stex_import_file_str }{
          \__stex_import_load_file:
        }{}
      }
    }{
      \IfFileExists{ \l__stex_import_file_str }{
        \__stex_import_load_file:
      }{}
    }
  }
}

\cs_new_protected:Npn \__stex_import_check_file:nnn #1 #2 {
  \stex_debug:nn{imports}{Checking~ \l__stex_import_pre_str #1}
  \IfFileExists{ \l__stex_import_pre_str #1 }{
    \stex_debug:nn{imports}{Success}
    \str_set:Ne \l__stex_import_file_str { \l__stex_import_pre_str #1 }
    #2
  }
}

\cs_new_protected:Nn \__stex_import_load_file: {
  \tl_set:Ne \l__stex_import_doc_uri {
    { \l__stex_import_archive_str }
    { \l__stex_import_path_str }
    { \l__stex_import_name_str }
    { \l__stex_import_language_str }
    {}
  }
  \exp_args:NNo \stex_file_in_smsmode:Nn \l__stex_import_doc_uri \l__stex_import_file_str
  \stex_if_module_exists:NF \l__stex_import_uri {
    \msg_error:nnx{stex}{error/unknownmodule}{\stex_use_module_uri:N \l__stex_import_uri}
  }
}
\stex_new_stylable_cmd:nnnn {usemodule} { O{} m } {
  \stex_uri_from_pair:Nnn \l_stex_import_uri { #1 }{ #2 }
  \stex_require_module:N \l_stex_import_uri
  \stex_debug:nn{usemodule}{Done.}
  \stex_if_do_html:T {
    \hbox{\stex_annotate_invisible:nn
      {data-shtml-usemodule=\stex_use_module_uri:N \l_stex_import_uri } {}}
  }
  \stex_if_smsmode:F{
    \group_begin:
    \str_set:Ne \thismoduleuri {\stex_use_module_uri:N \l_stex_import_uri }
    \str_set:Ne \thismodulename {\stex_module_uri_name:N \l_stex_import_uri}
    \tl_clear:N \thisstyle
    \stex_style_apply:
    \group_end:
  }
}{}%{\aftergroup\ignorespaces}
\stex_new_stylable_cmd:nnnn{importmodule} { O{} m } {
  \__stex_import_import_module:nn {#1}{#2}
  \stex_smsmode_do:
}{\aftergroup\ignorespaces}

\stex_deactivate_macro:Nn \importmodule {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \importmodule}
\stex_sms_allow_escape:N \importmodule

\cs_new_protected:Nn \__stex_import_import_module:nn {
  \stex_uri_from_pair:Nnn \l_stex_import_uri { #1 }{ #2 }
  \stex_require_module:N \l_stex_import_uri
  \stex_execute_in_module:e{
    \stex_activate_module:n { \l_stex_import_uri }
  }
  \stex_add_morphism:nonn
    {}{\l_stex_import_uri}{import}{}
  \stex_if_do_html:T {
    \stex_annotate_invisible:nn
      {data-shtml-import=\stex_use_module_uri:N \l_stex_import_uri } {}
  }
  \stex_if_smsmode:F{
    \group_begin:
    \tl_set:Nn \thisarchive {#1}
    \str_set:Ne \thismoduleuri {\stex_use_module_uri:N \l_stex_import_uri }
    \str_set:Ne \thismodulename {\stex_module_uri_name:N \l_stex_import_uri}
    \tl_clear:N \thisstyle
    \stex_style_apply:
    \group_end:
  }
}
\cs_new_protected:Nn \__stex_import_import_module_presms:nn {
  \stex_uri_from_pair:Nnn \l_stex_import_uri { #1 }{ #2 }
  \bool_if:NF \l_stex_relative_import_bool {
    \tl_gput_right:Ne \g_stex_sms_import_code {
      \stex_require_module_noerr:n { \l_stex_import_uri }
    }
  }
}

\stex_sms_allow_import:Nn \importmodule {
  \stex_reactivate_macro:N \importmodule
  \let \__stex_import_import_module:nn \__stex_import_import_module_presms:nn
}
\cs_new_protected:Nn \stex_add_morphism:nnnn {
  \exp_args:Nne \prop_gput:cnn{ \_stex_morphisms_macro:N \l_stex_current_module_uri }{
    \tl_if_empty:nTF{#1}{[\stex_use_module_uri:n {#2}]}{#1}
  }{{#1}{#2}{#3}{#4}}
}
\cs_generate_variant:Nn \stex_add_morphism:nnnn {nonn,oooe}
\tl_new:N \l_stex_current_domain_uri
\bool_new:N \l__stex_morphisms_with_macros_bool

\cs_new_protected:Npn \stex_structural_feature_morphism_with_macros:nnnnn {
  \bool_set_true:N \l__stex_morphisms_with_macros_bool
  \__stex_morphisms_morphism:nnnnn
}
\cs_new_protected:Npn \stex_structural_feature_morphism:nnnnn {
  \bool_set_false:N \l__stex_morphisms_with_macros_bool
  \__stex_morphisms_morphism:nnnnn
}

\cs_new_protected:Nn \__stex_morphisms_morphism:nnnnn {
  \tl_clear:N \l_stex_current_domain_uri
  \tl_if_empty:nT{#3}{
    \stex_get_mathstructure:n{#4}
    \tl_set_eq:NN \l_stex_current_domain_uri \l_stex_get_structure_module_uri
  }
  \tl_if_empty:NT \l_stex_current_domain_uri {
    \stex_uri_from_pair:Nnn \l_stex_import_uri { #3 }{ #4 }
    \group_begin:
    \stex_require_module:N \l_stex_import_uri
    \exp_args:Nne \use:nn \group_end: {
      \tl_set:Nn \exp_not:N\l_stex_current_domain_uri {\l_stex_import_uri}
    }
  }
  \tl_if_empty:nT{#1}{
    \msg_error:nn{stex}{error/morphism-needs-name}
  }
  \str_set:Nn \l_tmpa_str {#1}

  \stex_debug:nn{morphisms}{#2:~\l_tmpa_str;~for~\stex_use_module_uri:N \l_stex_current_domain_uri}

  \str_set:Nn \l__stex_morphisms_feature_str {#2}
  \str_set_eq:NN \l_stex_feature_name_str \l_tmpa_str

  \stex_if_do_html:TF {
    \begin{stex_annotate_env} {
      data-shtml-feature-#2={\l_tmpa_str},
      data-shtml-domain={\stex_use_module_uri:N \l_stex_current_domain_uri}
      #5
    }
    \stex_annotate_invisible:n{}
  }\group_begin:
  \__stex_morphisms_setup:
  \__stex_morphisms_reactivate:
  \stex_metagroup_new:
}

\cs_new_protected:Nn \__stex_morphisms_setup: {
  \seq_clear:N \l_stex_morphism_symbols_seq
  \seq_clear:N \l_stex_morphism_renames_seq
  \seq_clear:N \l_stex_morphism_morphisms_seq
  \seq_clear:N \l_stex_morphism_assigns_seq
  \__stex_morphisms_do_decls:
  \exp_args:No \__stex_morphisms_do:n \l_stex_current_domain_uri
}

\cs_new_protected:Nn \__stex_morphisms_do_decls: {
  \exp_args:No \stex_iterate_symbols:nn \l_stex_current_domain_uri {
    \exp_args:NNe \seq_put_right:Nn \l_stex_morphism_symbols_seq {
      { \stex_new_symbol_uri:nn{##1}{##3} }
      { {##2}{##4}{##5}{##6}{##7}{##8}##9 }
    }
  }
}

\cs_new_protected:Nn \__stex_morphisms_do:n {
  %\seq_clear:N \l__stex_morphisms_dones_seq
    \prop_map_inline:cn {\_stex_morphisms_macro:n{#1}}{
      %\seq_if_in:NnF \l__stex_morphisms_dones_seq {##2}{
      %  \seq_push:Nn \l__stex_morphisms_dones_seq {##2}
        \stex_debug:nn{morphisms}{Doing ~ \tl_to_str:n{##2}}
        \__stex_morphisms_do_morph:nnnn ##2
     % }
    }
}

\cs_new_protected:Nn \__stex_morphisms_do_morph:nnnn {
    \tl_if_empty:nF{#3}{
      \seq_put_right:Nn \l_stex_morphism_morphisms_seq {{#1}{#2}{#3}}
    }
    \__stex_morphisms_do:n{#2}
}

\cs_new_protected:Nn \stex_structural_feature_morphism_end: {
  \tl_gset_eq:NN \l_stex_current_domain_uri \l_stex_current_domain_uri
  \seq_gset_eq:NN \l_stex_morphism_symbols_seq \l_stex_morphism_symbols_seq
  \seq_gset_eq:NN \l_stex_morphism_renames_seq \l_stex_morphism_renames_seq
  \seq_gset_eq:NN \l_stex_morphism_assigns_seq \l_stex_morphism_assigns_seq
  \seq_gset_eq:NN \l_stex_morphism_morphisms_seq \l_stex_morphism_morphisms_seq
  \bool_gset_eq:NN \l__stex_morphisms_with_macros_bool \l__stex_morphisms_with_macros_bool
  \stex_if_do_html:TF{
    \end{stex_annotate_env}
  }\group_end:
  \__stex_morphisms_do_elaboration:
}

\cs_new_protected:Nn \__stex_morphisms_do_elaboration: {
  \stex_debug:nn{morphisms}{
    Elaborating:^^J\meaning \l_stex_morphism_symbols_seq
    ^^J^^J
    Renamings:^^J
    \meaning \l_stex_morphism_renames_seq
    ^^J^^J
    Assignments:^^J
    \meaning \l_stex_morphism_assigns_seq
  }

  \seq_map_inline:Nn \l_stex_morphism_symbols_seq {
    \__stex_morphisms_elab:nn ##1
  }

  \stex_add_morphism:oooe
    \l_stex_feature_name_str
    \l_stex_current_domain_uri
    \l__stex_morphisms_feature_str
    {\seq_map_function:NN \l_stex_morphism_renames_seq \__stex_morphisms_rename:n}
}

\cs_new:Nn \__stex_morphisms_rename:n{
  \__stex_morphisms_rename:nn #1
}

\cs_new:Nn \__stex_morphisms_rename:nn{
  {#1}{\use_ii:nn#2}
}

\cs_new_protected:Nn \__stex_morphisms_elab:nn {
  \tl_clear:N \l__stex_morphisms_tmp
  \seq_map_inline:Nn \l_stex_morphism_renames_seq {
    \__stex_morphisms_elab_check_rename:nnn{#1}##1
  }
  \tl_if_empty:NTF \l__stex_morphisms_tmp {
    \exp_args:Ne \__stex_morphisms_elab_i:nnn {\stex_symbol_uri_name:n {#1}}{#1}
  }{
    \stex_debug:nn{morphisms}{Generating~1~\l__stex_morphisms_tmp}
    \use_i:nn{ \exp_args:Nno \use:nn {\__stex_morphisms_add_symbol:nnnnnnnnN {#1}} \l__stex_morphisms_tmp}
  }#2

  \exp_args:No\stex_iterate_notations:nn\l_stex_current_domain_uri {
    \str_if_eq:nnT{#1}{##1}{
      \exp_args:Ne \stex_add_notation:nnnnn {
        \exp_args:Ne \stex_new_symbol_uri:n {\exp_after:wN \use_ii:nn \l__stex_morphisms_tmp }
      }{##2}{##3}{##4}{##5}
    }
  }
}

\cs_new_protected:Nn \__stex_morphisms_elab_i:nnn {
  \tl_set:Ne \l__stex_morphisms_tmp {{}{\l_stex_feature_name_str / #1}}
  \stex_debug:nn{morphisms}{Generating~2~\l_stex_feature_name_str / #1}
  \bool_if:NTF \l__stex_morphisms_with_macros_bool {
    \exp_args:Nnno \__stex_morphisms_add_symbol:nnnnnnnnN {#2} {#3}
  }{
    \exp_args:Nnno \__stex_morphisms_add_symbol:nnnnnnnnN {#2} {}
  }
  {\l_stex_feature_name_str / #1}
}

\cs_new_protected:Npn \__stex_morphisms_add_symbol:nnnnnnnnN #1 {
  \tl_clear:N \l__stex_morphisms_tmp_b
  \seq_map_inline:Nn \l_stex_morphism_assigns_seq {
    \__stex_morphisms_elab_check_assign:nnnnn{#1}##1
  }
  \tl_if_empty:NTF \l__stex_morphisms_tmp_b
  \stex_add_symbol:nnnnnnnN
  \__stex_morphisms_add_symbol_i:nnnnnnnN
}

\cs_new_protected:Npn \__stex_morphisms_add_symbol_i:nnnnnnnN #1 #2 #3 #4 #5 {
  \stex_add_symbol:nnnnnnnN {#1}{#2}{#3}{#4}{assigned}
}

\cs_new_protected:Nn \__stex_morphisms_elab_check_assign:nnnnn {
  \tl_if_eq:nnT{#1}{{#2}{#3}{#4}{#5}}{
    \seq_map_break:n{
      \tl_set:Nn \l__stex_morphisms_tmp_b {assigned}
    }
  }
}

\cs_new_protected:Nn \__stex_morphisms_elab_check_rename:nnn {
  \tl_if_eq:nnT{#1}{#2}{
    \seq_map_break:n{
      \tl_set:Nn \l__stex_morphisms_tmp {#3}
    }
  }
}

\cs_new_protected:Nn \__stex_morphisms_do_for_list: {
  \seq_clear:N \l_stex_fors_seq
  \clist_map_inline:Nn \l_stex_key_for_clist {
    \exp_args:Ne\stex_get_in_morphism:n{\tl_to_str:n{##1}}
    \seq_put_right:No \l_stex_fors_seq
      {\l_stex_get_symbol_uri}
  }
}

\cs_new_protected:Nn \__stex_morphisms_add_definiens:nn {
  \tl_set:Nn \l_stex_get_symbol_uri {#1}
  \stex_debug:nn{morphisms}{Adding~definiens~\tl_to_str:n{#1~#2}}
  %\__stex_morphisms_set_definiens_macros: #1\__stex_morphisms_break:
  \_stex_assign_do:n{#2}
  #2
}



\cs_new_protected:Nn \__stex_morphisms_rename_all: {
    % TODO
}

\cs_new_protected:Nn \stex_structural_feature_morphism_check_total: {
  \seq_map_inline:Nn \l_stex_morphism_symbols_seq {
    \__stex_morphisms_total_check:nn ##1
  }
}

\cs_new_protected:Nn \__stex_morphisms_total_check:nn {
  \__stex_morphisms_total_check:nnnnnnnN {#1} #2
}

\cs_new_protected:Nn \__stex_morphisms_total_check:nnnnnnnN {
  \tl_if_empty:nT{#5}{
    \seq_if_in:NnF \l_stex_morphism_assigns_seq {#1} {
      \msg_error:nnxx{stex}{error/needsdefiniens}{\stex_use_symbol_uri:n {#1}}{total~morphism}
    }
  }
}

\cs_new:Npn \__stex_morphisms_split_qm:w #1 ? #2 ? #3 { #3 }

\cs_new_protected:Npn \__stex_morphisms_reactivate: {
  \stex_deactivate_macro:Nn \symdecl {module~environments}
  \stex_deactivate_macro:Nn \textsymdecl {module~environments}
  \stex_deactivate_macro:Nn \symdef {module~environments}
  \stex_deactivate_macro:Nn \notation {module~environments}
  \stex_deactivate_macro:Nn \importmodule {module~environments}
  \stex_deactivate_macro:Nn \requiremodule {module~environments}
  \stex_deactivate_macro:Nn \smodule {outside~of~morphisms}
  \stex_reactivate_macro:N \assign
  \stex_reactivate_macro:N \assignMorphism
  \stex_reactivate_macro:N \renamedecl
  \cs_set_eq:NN \_stex_do_for_list: \__stex_morphisms_do_for_list:
  \cs_set_eq:NN \_stex_add_definiens:nn \__stex_morphisms_add_definiens:nn
}
\cs_new_protected:Nn \stex_iterate_morphisms:nn {
  \seq_clear:N \l__stex_morphisms_mods_seq
  \bool_set_true:N \l__stex_morphisms_continue_bool
  \cs_set:Npn \__stex_morphisms_cs:nnnn ##1 ##2 ##3 ##4 ##5 {
    #2
    \bool_if:NT \l__stex_morphisms_continue_bool {
      \str_if_eq:nnTF{##1}{[##2]}{
        \tl_put_right:Nn \l__stex_morphisms_todo_tl {
          \__stex_morphisms_iterate:nn{##5}{##2}
        }
      }{
        \tl_put_right:Nn \l__stex_morphisms_todo_tl {
          \__stex_morphisms_iterate:nn{##5 / ##1}{##2}
        }
      }
    }
  }
  \cs_set:Npn \stex_iterate_break:n ##1 {
    \bool_set_false:N \l__stex_morphisms_continue_bool
    \prop_map_break:n{##1}
  }
  \__stex_morphisms_iterate:nn{}{#1}
}
\cs_new_protected:Nn \__stex_morphisms_iterate:nn {
  \tl_clear:N \l__stex_morphisms_todo_tl
  \seq_if_in:NnF \l__stex_morphisms_mods_seq {#1 #2}{
    \seq_put_right:Nn \l__stex_morphisms_mods_seq {#1 #2}
    \prop_map_inline:cn{\_stex_morphisms_macro:n{#2}}{
      \__stex_morphisms_cs:nnnn ##2 {#1}
      % TODO
      % ##1: name or [mpath]
      % ##2 = {####1}{####2}{####3}{####4}
      % ####1 = name
      % ####2 = mpath
      % ####3 = type
      % ####4 = {origname}{newname}*
    }
    \bool_if:NT \l__stex_morphisms_continue_bool \l__stex_morphisms_todo_tl
  }
}
\cs_new_protected:Nn \stex_get_in_morphism:n {
  \stex_debug:nn{morphisms}{Getting~in~morphism:~#1}
  \tl_clear:N \l_stex_get_symbol_uri
  \str_set:Nn \l__stex_morphisms_get_str {#1}
  \seq_map_inline:Nn \l_stex_morphism_symbols_seq {
    \__stex_morphisms_get_check:nn ##1
  }
  \tl_if_empty:NT \l_stex_get_symbol_uri {
    \seq_map_inline:Nn \l_stex_morphism_renames_seq {
      \__stex_morphisms_renamed_check:nn##1
    }
    \tl_if_empty:NT \l_stex_get_symbol_uri {
      \msg_error:nnxx{stex}{error/unknownsymbolin}{#1}{
        morphism~\l_stex_feature_name_str
      }
    }
  }
}

\cs_new_protected:Nn \__stex_morphisms_get_check:nn {
  \__stex_morphisms_check_name:nnnn #1 #2
}

\cs_new_protected:Nn \__stex_morphisms_check_name:nnnn {
  % TODO module name, path, archive, macroname ?
  \exp_args:No \str_if_eq:nnTF \l__stex_morphisms_get_str {#4} {
    \tl_set:Nn \l_stex_get_symbol_uri {{#1}{#2}{#3}{#4}}
    \__stex_morphisms_set:nnnnnnN
  }{
    \__stex_morphisms_macro:nnnnnnnN{{#1}{#2}{#3}{#4}}
  }
}

\cs_new_protected:Nn \__stex_morphisms_set:nnnnnnN {
  \seq_map_break:n{
    \str_set:Nn \l_stex_get_symbol_macro_str{#1}
    \int_set:Nn \l_stex_get_symbol_arity_int {#2}
    \tl_set:Nn \l_stex_get_symbol_args_tl {#3}
    \tl_set:Nn \l_stex_get_symbol_def_tl {#4}
    \tl_set:Nn \l_stex_get_symbol_type_tl {#5}
    \tl_set:Nn \l_stex_get_symbol_return_tl {#6}
    \tl_set:Nn \l_stex_get_symbol_invoke_cs {#7}
  }
}

\cs_new_protected:Npn \__stex_morphisms_macro:nnnnnnnN #1 #2 {
  \exp_args:No \str_if_eq:nnTF \l__stex_morphisms_get_str {#2}{
    \tl_set:Nn \l_stex_get_symbol_uri{#1}
    \__stex_morphisms_set:nnnnnnN
  }\__stex_morphisms_gobble:nnnnnnN
  {#2}
}

\cs_new_protected:Nn \__stex_morphisms_gobble:nnnnnnN {}

\cs_new_protected:Nn \__stex_morphisms_renamed_check:nn {
  \stex_debug:nn{here}{\tl_to_str:n{{#1}{#2}}:~\l__stex_morphisms_get_str}
  \__stex_morphisms_renamed_check:nnnnnn #1 #2
}

\cs_new_protected:Nn \__stex_morphisms_renamed_check:nnnnnn {
  \exp_args:No \str_if_eq:nnTF \l__stex_morphisms_get_str{#5}{
    \seq_map_break:n{
      \str_set:Nn \l__stex_morphisms_get_str {#4}
      \seq_map_inline:Nn \l_stex_morphism_symbols_seq {
        \__stex_morphisms_get_check:nn ##1
      }
    }
  }{
    \exp_args:No \str_if_eq:nnT \l__stex_morphisms_get_str{#6}{
      \seq_map_break:n{
        \str_set:Nn \l__stex_morphisms_get_str {#4}
        \seq_map_inline:Nn \l_stex_morphism_symbols_seq {
          \__stex_morphisms_get_check:nn ##1
        }
      }
    }
  }
}
\stex_new_stylable_env:nnnnnnn {copymodule}{m O{} m}{
  \__stex_morphisms_begin_copy:Nnnn\stex_structural_feature_morphism:nnnnn {#1}{#2}{#3}
}{
  \stex_if_smsmode:F {
    \stex_style_apply:
  }
  \stex_structural_feature_morphism_end:
}{}{}{}

\stex_new_stylable_env:nnnnnnn {copymodule*}{m O{} m}{
  \cs_set:Npn \stex_style_apply: {
    \_stex_apply_patch_begin:n{copymodule}
  }
  \__stex_morphisms_begin_copy:Nnnn\stex_structural_feature_morphism_with_macros:nnnnn {#1}{#2}{#3}
}{
  \cs_set:Npn \stex_style_apply: {
    \_stex_apply_patch_end:n{copymodule}
  }
  \stex_if_smsmode:F {
    \stex_style_apply:
  }
  \stex_structural_feature_morphism_end:
}{}{}{}

\cs_new_protected:Nn \__stex_morphisms_begin_copy:Nnnn {
  #1{#2}{morphism}{#3}{#4}{,data-shtml-total=false}
  \stex_if_smsmode:F {
    \tl_set:Nn \thiscopyname { #2 }
    \tl_set:Nn \thismoduleuri {\stex_use_module_uri:N \l_stex_current_domain_uri}
    \stex_style_apply:
  }
  \stex_smsmode_do:
}

\stex_deactivate_macro:Nn \copymodule {module~environments}
\stex_every_module:n {
  \stex_reactivate_macro:N \copymodule
}
\stex_sms_allow_env:n{copymodule}

\exp_after:wN \stex_deactivate_macro:Nn \csname copymodule*\endcsname {module~environments}
\stex_every_module:n {
  \exp_after:wN\stex_reactivate_macro:N \csname copymodule*\endcsname
}
\stex_sms_allow_env:n{copymodule*}

\stex_new_stylable_cmd:nnnn{copymod}{s m O{} m m}{
  \IfBooleanTF#1\stex_structural_feature_morphism_with_macros:nnnnn
  \stex_structural_feature_morphism:nnnnn{#2}{morphism}{#3}{#4}{,data-shtml-total={false}}
  \clist_map_function:nN{#5}\__stex_morphisms_parse_assign:n
  \stex_if_smsmode:F {
    \tl_set:Nn \thiscopyname { #2 }
    \tl_set:Nn \thismoduleuri {\stex_use_module_uri:N \l_stex_current_domain_uri}
    \stex_style_apply:
  }
  \stex_structural_feature_morphism_end:
  \stex_smsmode_do:
}{}

\stex_deactivate_macro:Nn \copymod {module~environments}
\stex_every_module:n {
  \stex_reactivate_macro:N \copymod
}
\stex_sms_allow_escape:N\copymod
\stex_new_stylable_env:nnnnnnn {interpretmodule}{m O{} m}{
  \__stex_morphisms_begin_interpret:Nnnn\stex_structural_feature_morphism:nnnnn {#1}{#2}{#3}
}{
  \stex_structural_feature_morphism_check_total:
  \stex_if_smsmode:F {
    \stex_style_apply:
  }
  \stex_structural_feature_morphism_end:
}{}{}{}

\stex_new_stylable_env:nnnnnnn {interpretmodule*}{m O{} m}{
  \cs_set:Npn \stex_style_apply: {
    \_stex_apply_patch_begin:n{interpretmodule}
  }
  \__stex_morphisms_begin_interpret:Nnnn\stex_structural_feature_morphism_with_macros:nnnnn {#1}{#2}{#3}
}{
  \cs_set:Npn \stex_style_apply: {
    \_stex_apply_patch_end:n{interpretmodule}
  }
  \stex_structural_feature_morphism_check_total:
  \stex_if_smsmode:F {
    \stex_style_apply:
  }
  \stex_structural_feature_morphism_end:
}{}{}{}

\cs_new_protected:Nn \__stex_morphisms_begin_interpret:Nnnn {
  #1{#2}{morphism}{#3}{#4}{,data-shtml-total=true}
  \stex_if_smsmode:F {
    \tl_set:Nn \thiscopyname { #2 }
    \tl_set:Nn \thismoduleuri {\stex_use_module_uri:N \l_stex_current_domain_uri}
    \stex_style_apply:
  }
  \stex_smsmode_do:
}

\stex_deactivate_macro:Nn \interpretmodule {module~environments}
\stex_every_module:n {
  \stex_reactivate_macro:N \interpretmodule
}
\stex_sms_allow_env:n{interpretmodule}

\exp_after:wN \stex_deactivate_macro:Nn \csname interpretmodule*\endcsname {module~environments}
\stex_every_module:n {
  \exp_after:wN \stex_reactivate_macro:N \csname interpretmodule*\endcsname
}
\stex_sms_allow_env:n{interpretmodule*}

\stex_new_stylable_cmd:nnnn{interpretmod}{s m O{} m m}{
  \IfBooleanTF#1\stex_structural_feature_morphism_with_macros:nnnnn
  \stex_structural_feature_morphism:nnnnn{#2}{morphism}{#3}{#4}{,data-shtml-total=true}
  \clist_map_function:nN{#5}\__stex_morphisms_parse_assign:n
  \stex_if_smsmode:F {
    \tl_set:Nn \thiscopyname { #2 }
    \tl_set:Nn \thismoduleuri {\stex_use_module_uri:N \l_stex_current_domain_uri}
    \stex_style_apply:
  }
  \stex_structural_feature_morphism_check_total:
  \stex_structural_feature_morphism_end:
  \stex_smsmode_do:
}{}

\stex_deactivate_macro:Nn \interpretmod {module~environments}
\stex_every_module:n {
  \stex_reactivate_macro:N \interpretmod
}
\stex_sms_allow_escape:N\interpretmod
\stex_new_stylable_cmd:nnnn {assign} { m m }{
  \stex_get_in_morphism:n{#1}
  \_stex_assign_do:n{#2}
  \stex_smsmode_do:
}{}
\stex_sms_allow_escape:N\assign
\stex_deactivate_macro:Nn \assign {morphism~environments}

\cs_new_protected:Nn \_stex_assign_do:n{
  \stex_debug:nn{assign}{Assigning~\stex_use_symbol_uri:N \l_stex_get_symbol_uri~to~\tl_to_str:n{#1}}
  \stex_check_term:nn{assignment}{#1}
  \stex_if_do_html:T{
    \stex_annotate_invisible:nn{data-shtml-assign={\stex_use_symbol_uri:N \l_stex_get_symbol_uri}}{
      \_stex_annotate_force_break:n{
        \mode_if_math:T\hbox{$\stex_annotate:nn{data-shtml-definiens={}}{#1}$}
      }
    }
  }
  \exp_after:wN \stex_metagroup_do_in:n \exp_after:wN {
    \exp_after:wN \seq_put_right:Nn \exp_after:wN  \l_stex_morphism_assigns_seq
    \exp_after:wN { \l_stex_get_symbol_uri }
  }
}

\cs_new_protected:Nn \__stex_morphisms_parse_assign:n {
  \str_clear:N \l__stex_morphisms_name_str
  \str_clear:N \l__stex_morphisms_newname_str
  \tl_clear:N \l__stex_morphisms_ass_tl
  \stex_debug:nn{morphisms}{Parsing~#1}
  \exp_args:NNe \seq_set_split:Nnn \l__stex_morphisms_seq {\tl_to_str:n{@}} {#1}
  \int_compare:nNnTF {\seq_count:N \l__stex_morphisms_seq} = 1 {
    \stex_debug:nn{morphisms}{No~@}
    \seq_pop_left:NN \l__stex_morphisms_seq \l__stex_morphisms_next_tl
  }{
    \seq_pop_left:NN \l__stex_morphisms_seq \l__stex_morphisms_name_str
    \stex_debug:nn{morphisms}{Name:~\l__stex_morphisms_name_str}
    \exp_args:NNo \str_set:Nn \l__stex_morphisms_name_str \l__stex_morphisms_name_str
    \tl_set:Ne \l__stex_morphisms_next_tl {\seq_use:Nn \l__stex_morphisms_seq @}
  }
  \exp_args:NNNo \seq_set_split:Nnn \l__stex_morphisms_seq = \l__stex_morphisms_next_tl
  \str_if_empty:NTF \l__stex_morphisms_name_str {
    \seq_pop_left:NN \l__stex_morphisms_seq \l__stex_morphisms_name_str
    \exp_args:NNo \str_set:Nn \l__stex_morphisms_name_str \l__stex_morphisms_name_str
    \tl_set:Ne \l__stex_morphisms_ass_tl {\seq_use:Nn \l__stex_morphisms_seq =}
  }{
    \seq_pop_left:NN \l__stex_morphisms_seq \l__stex_morphisms_newname_str
    \exp_args:NNo \str_set:Nn \l__stex_morphisms_newname_str \l__stex_morphisms_newname_str
    \tl_set:Ne \l__stex_morphisms_ass_tl {\seq_use:Nn \l__stex_morphisms_seq =}
  }
  \__stex_morphisms_do_parsed_assign:
}

\cs_new_protected:Nn \__stex_morphisms_do_parsed_assign: {
  \exp_args:No \stex_get_in_morphism:n \l__stex_morphisms_name_str
  \str_if_empty:NF \l__stex_morphisms_newname_str {
    \stex_debug:nn{morphisms}{renaming~\l__stex_morphisms_name_str;~to~\l__stex_morphisms_newname_str}
    \exp_after:wN \__stex_morphisms_do_parsed_newname: \l__stex_morphisms_newname_str \__stex_morphisms_end:
  }
  \tl_if_empty:NF \l__stex_morphisms_ass_tl {
    \stex_debug:nn{morphisms}{assigning~\l__stex_morphisms_name_str;~to~\exp_args:No \tl_to_str:n \l__stex_morphisms_ass_tl}
    \exp_args:No \_stex_assign_do:n \l__stex_morphisms_ass_tl
  }
}

\cs_new_protected:Nn \__stex_morphisms_do_parsed_newname: {
  \peek_charcode:NTF [ {
    \__stex_morphisms_do_parsed_newname:w
  }{
    \__stex_morphisms_do_parsed_newname:w []
  }
}

\cs_new_protected:Npn \__stex_morphisms_do_parsed_newname:w [#1] #2 \__stex_morphisms_end: {
  \_stex_renamedecl_do:nn{#1}{#2}
}
\stex_new_stylable_cmd:nnnn {renamedecl} { m O{} m }{
  \stex_get_in_morphism:n{#1}
  \_stex_renamedecl_do:nn{#2}{#3}
  \stex_smsmode_do:
}{}
\stex_sms_allow_escape:N\renamedecl
\stex_deactivate_macro:Nn \renamedecl {morphism~environments}

\cs_new_protected:Nn \_stex_renamedecl_do:nn {
  \stex_debug:nn{renamedecl}{Renaming~\stex_use_symbol_uri:N \l_stex_get_symbol_uri~to~[#1]{#2}}
  \stex_if_do_html:T{
    \exp_args:Ne \stex_annotate_invisible:nn{
      data-shtml-rename={\stex_use_symbol_uri:N \l_stex_get_symbol_uri},
      data-shtml-macroname={#2}
      \str_if_empty:nF{#1}{ ,data-shtml-to={#1} }
    }{}
  }
  \stex_metagroup_do_in:e {
    \seq_push:Nn \exp_not:N \l_stex_morphism_renames_seq
    {{\l_stex_get_symbol_uri}{{#2}{
      \tl_if_empty:nTF{#1}{
        \l_stex_feature_name_str/\stex_symbol_uri_name:N \l_stex_get_symbol_uri
      }{#1}
    }}}
  }
}
\stex_new_stylable_cmd:nnnn {assignMorphism} { m m }{
  \str_clear:N \l__stex_morphisms_morphism_dom_str
  \exp_args:No \stex_iterate_morphisms:nn\l_stex_current_domain_uri{
    \stex_debug:nn{assignMorphism}{
      Checking:~#1~vs:^^J##1^^J##2^^J##3^^J##4
    }
    \str_if_eq:nnTF{#1}{##1}{
      \__stex_morphisms_do_morph_assign:nnn{##1}{##2}{##4}
    }{
      \stex_str_if_ends_with:nnT{##2}{#1}{
        \__stex_morphisms_do_morph_assign:nnn{##1}{##2}{##4}
      }
    }
  }
  \str_if_empty:NT \l__stex_morphisms_morphism_dom_str {
    \msg_error:nnn{stex}{error/nomorphism}{#1}
  }
  \bool_set_false:N \l_tmpa_bool
  \stex_iterate_morphisms:nn \l_stex_current_module_str {
    \stex_debug:nn{assignMorphism}{
      Checking:~#2~vs:^^J##1^^J##2^^J##3^^J##4
    }
    \str_if_eq:nnTF{#2}{##1}{
      \stex_debug:nn{assignMorphism}{match!}
      \stex_iterate_break:n{
        \stex_annotate_invisible:nn{
          data-shtml-assignmorphismfrom={\l__stex_morphisms_morphism_dom_str}
          data-shtml-assignmorphismto={\l_stex_current_module_str?##1}
        }{}
        \bool_set_true:N \l_tmpa_bool
      }
    }{
      \stex_str_if_ends_with:nnT{##2}{#2}{
        \stex_debug:nn{assignMorphism}{match!}
        \stex_iterate_break:n{
          \stex_annotate_invisible:nn{
            data-shtml-assignmorphismfrom={\l__stex_morphisms_morphism_dom_str},
            data-shtml-assignmorphismto={\l_stex_current_module_str?##1}
          }{}
          \bool_set_true:N \l_tmpa_bool
        }
      }
    }
  }
  \bool_if:NF \l_tmpa_bool {
    \msg_error:nnn{stex}{error/nomorphism}{#2}
  }
}{}
\stex_sms_allow_escape:N \assignMorphism
\stex_deactivate_macro:Nn \assignMorphism {morphism~environments}

\cs_new_protected:Nn \__stex_morphisms_do_morph_assign:nnn {
  \stex_iterate_break:n{
    \str_set:Ne \l__stex_morphisms_morphism_dom_str { \l_stex_current_domain_str ? #1 }
    \stex_debug:nn{assignMorphism}{match!}
    \stex_iterate_symbols:nn{#2}{
      \stex_debug:nn{assignMorphism}{removing~##1?##3}
      % TODO: non-trivial assignments
      \prop_remove:Nn \l_stex_morphism_symbols_prop {
        [##1]/[##3]
      }
    }
  }
}
\stex_keys_define:nnnn{symargs}{
  \str_clear:N \l_stex_key_args_str
  \str_clear:N \l_stex_key_role_str
  \str_clear:N \l_stex_key_reorder_str
  \str_clear:N \l_stex_key_assoc_str
}{
  args      .str_set:N  = \l_stex_key_args_str ,
  reorder   .str_set:N  = \l_stex_key_reorder_str ,
  assoc     .choices:nn = {bin,binl,binr,pre,conj,pwconj}
    {\str_set:Ne \l_stex_key_assoc_str \l_keys_choice_tl},
  role      .str_set:N  = \l_stex_key_role_str
}{}

\stex_keys_define:nnnn{decl}{
  \str_clear:N \l_stex_key_name_str
  \str_clear:N \l_stex_key_args_str
  \tl_clear:N \l_stex_key_type_tl
  \tl_clear:N \l_stex_key_def_tl
  \tl_clear:N \l_stex_key_return_tl
  \str_clear:N \l_stex_key_wikidata_str
  \clist_clear:N \l_stex_key_argtypes_clist
}{
  name      .str_set:N    = \l_stex_key_name_str ,
  return    .tl_set:N     = \l_stex_key_return_tl ,
  argtypes  .clist_set:N  = \l_stex_key_argtypes_clist ,
  wikidata  .str_set:N    = \l_stex_key_wikidata_str ,
  type      .tl_set:N     = \l_stex_key_type_tl  ,
  def       .tl_set:N     = \l_stex_key_def_tl   ,
  align     .code:n       = {},
  gf        .code:n       = {}
}{style,deprecate,symargs}
\str_new:N \l_stex_macroname_str

\stex_new_stylable_cmd:nnnn {symdecl} { s m O{}} {
  \stex_keys_set:nn{decl}{#3}
  \IfBooleanTF #1 {
    \str_clear:N \l_stex_macroname_str
  }{
    \str_set:Ne \l_stex_macroname_str { #2 }
  }
  \__stex_syms_top:n{#2}
  \stex_if_smsmode:F \__stex_syms_style:
  \stex_smsmode_do:
}{}

\stex_deactivate_macro:Nn \symdecl {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \symdecl}
\stex_sms_allow_escape:N \symdecl

\cs_new_protected:Nn \__stex_syms_style: {
  \group_begin:
    \tl_set:Ne \thisdecluri {\stex_use_symbol_uri:N \l_stex_current_symbol_uri}
    \tl_set_eq:NN \thisdeclname \l_stex_key_name_str
    \tl_set_eq:NN \thistype \l_stex_key_type_tl
    \tl_set_eq:NN \thisdefiniens \l_stex_key_def_tl
    \tl_set_eq:NN \thisargs \l_stex_key_args_str
    \tl_clear:N \thisstyle
    \stex_style_apply:
  \group_end:
}
\stex_new_stylable_cmd:nnnn {symdef} { m O{} m} {
  \stex_keys_set:nn{symdef}{#2}
  \str_set:Ne \l_stex_macroname_str { #1 }
  \__stex_syms_top:n{#1}
  \stex_debug:nn{symdef}{Doing~\stex_use_symbol_uri:N \l_stex_current_symbol_uri}
  \str_set_eq:NN \l_stex_get_symbol_uri \l_stex_current_symbol_uri
  \stex_notation_parse:n{#3}
  \stex_if_check_terms:T{ \_stex_notation_check: }
  \_stex_notation_add:
  \stex_if_do_html:T{
    \_stex_notation_do_html:n{\stex_use_symbol_uri:N \l_stex_current_symbol_uri}
  }
  \stex_if_smsmode:F \__stex_syms_def_style:
  \stex_smsmode_do:
}{}

\stex_deactivate_macro:Nn \symdef {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \symdef}
\stex_sms_allow_escape:N \symdef

\cs_new_protected:Nn \__stex_syms_def_style: {
  \group_begin:
  \tl_set:Nx \thisdecluri {\stex_use_symbol_uri:N \l_stex_current_symbol_uri}
  \tl_set_eq:NN \thisdeclname \l_stex_key_name_str
  \tl_set_eq:NN \thistype \l_stex_key_type_tl
  \tl_set_eq:NN \thisdefiniens \l_stex_key_def_tl
  \tl_set_eq:NN \thisargs \l_stex_key_args_str
  \tl_clear:N \thisstyle
  \str_set_eq:NN\thisnotationvariant\l_stex_key_variant_str
  \def\thisnotation{
    \exp_args:Nne \use:nn{\l_stex_notation_macrocode_cs{}}{
      \_stex_notation_make_args:
    }
  }
  \stex_style_apply:
  \group_end:
}
\stex_keys_define:nnnn{textsymdecl}{
  \str_clear:N \l_stex_key_name_str
  \tl_clear:N \l_stex_key_type_tl
  \tl_clear:N \l_stex_key_def_tl
}{
  name      .str_set:N  = \l_stex_key_name_str ,
  type      .tl_set:N     = \l_stex_key_type_tl ,
  def       .tl_set:N     = \l_stex_key_def_tl,
  gf        .code:n       = {}
}{style,deprecate}

\stex_new_stylable_cmd:nnnn {textsymdecl} {m O{} m} {
  \stex_keys_set:nn{symdef}{}
  \stex_keys_set:nn{textsymdecl}{#2}
  \str_set:Ne \l_stex_macroname_str { #1 }
  \str_if_empty:NT \l_stex_key_name_str {
    \str_set:Nn \l_stex_key_name_str {#1}
  }%{
  %  \str_set:Ne \l_stex_key_name_str {\l_stex_key_name_str-sym}
  %}
  \str_set:Nn \l_stex_key_role_str {textsymdecl}
  \tl_set:Ne \l_stex_current_symbol_uri {
    \exp_args:No \stex_new_symbol_uri:n \l_stex_key_name_str
  }
  \stex_symdecl_do:
  \_stex_check_terms:
  \exp_args:Nne \use:nn {\stex_add_symbol:nnnnnnnN}{
    {\l_stex_macroname_str}
    {\l_stex_key_name_str}
    {0}{}
    {\tl_if_empty:NF \l_stex_key_def_tl{DEFED} }
    {}% type
    {\use:c{#1name_nospace}}% return
    \stex_invoke_text_symbol:
  }
  \exp_args:Ne \stex_ref_new_symbol:n
    { \stex_use_symbol_uri:N \l_stex_current_symbol_uri }
  \stex_if_do_html:T {
    \_stex_symdecl_html:
  }

  \int_set:Nn \l_stex_get_symbol_arity_int 0
  \tl_clear:N \l_stex_key_op_tl
  \str_clear:N \l_stex_key_intent_str
  \str_clear:N \l_stex_key_prec_str
  \tl_set_eq:NN \l_stex_get_symbol_uri \l_stex_current_symbol_uri
  \stex_notation_parse:n{\hbox{#3}}
  \_stex_notation_add:
  \stex_if_do_html:T {
    \def\comp{\_comp}
    \_stex_notation_do_html:n{ \stex_use_symbol_uri:N \l_stex_current_symbol_uri }
  }
  \stex_execute_in_module:e{
    \__stex_syms_set_textsymdecl_macro:nnn{#1}{ \stex_use_symbol_uri:N \l_stex_current_symbol_uri }
    \exp_not:n{{#3}}
  }

  \stex_if_smsmode:F{
    \group_begin:
    \tl_set:Ne \thisdecluri {\stex_use_symbol_uri:N \l_stex_current_symbol_uri}
    \tl_set_eq:NN \thisdeclname \l_stex_key_name_str
    \tl_clear:N \thisstyle
    \stex_style_apply:
    \group_end:
  }
  \stex_smsmode_do:
}{}

\stex_deactivate_macro:Nn \textsymdecl {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \textsymdecl}
\stex_sms_allow_escape:N \textsymdecl

\cs_new_protected:Nn \__stex_syms_set_textsymdecl_macro:nnn {
  \cs_set_protected:cpn{#1name_nospace}{#3}
  \cs_set_protected:cpn{#1name}{
    \mode_if_vertical:T{\hbox_unpack:N\c_empty_box}
    \mode_if_math:T\hbox{\let\xspace\relax #3}
    \mode_if_math:F{\cs_if_exist:NT\xspace\xspace}
  }
}
\cs_new_protected:Nn \__stex_syms_top:n {
  \str_if_empty:NT \l_stex_key_name_str {
    \str_set:Ne \l_stex_key_name_str { #1 }
  }
  \tl_set:Ne \l_stex_current_symbol_uri {
    \exp_args:No \stex_new_symbol_uri:n \l_stex_key_name_str
  }

  \stex_symdecl_do:
  \_stex_check_terms:
  \__stex_syms_add_decl:
  \stex_if_do_html:T \_stex_symdecl_html:
}
\cs_new_protected:Nn \__stex_syms_add_decl: {
  \exp_args:Nne \use:nn {\stex_add_symbol:nnnnnnnN}{
    {\l_stex_macroname_str}
    {\l_stex_key_name_str}
    {\int_use:N \l_stex_get_symbol_arity_int}
    {\l_stex_get_symbol_args_tl}
    {\tl_if_empty:NF \l_stex_key_def_tl{DEFED} }
    {}
    {\exp_args:No \exp_not:n \l_stex_key_return_tl}
    \stex_invoke_symbol:
  }
  \exp_args:Ne \stex_ref_new_symbol:n
    {\stex_use_symbol_uri:N \l_stex_current_symbol_uri}
}
\cs_new_protected:Nn \stex_symdecl_do: {
  \_stex_do_deprecation:n \l_stex_key_name_str
  \__stex_syms_parse_arity:
  \__stex_syms_do_args:
}

\cs_new:Nn \_stex_return_args:nn {
  {\svar{ARGUMENT_#1}\_stex_eat_exclamation_point:}
}

\cs_new_protected:Nn \__stex_syms_do_args: {
  \tl_clear:N \l_stex_get_symbol_args_tl
  \int_step_inline:nn \l_stex_get_symbol_arity_int {
    \tl_put_right:Nn \l_stex_get_symbol_args_tl {##1}
    \tl_put_right:Ne \l_stex_get_symbol_args_tl {
      \str_item:Nn \l_stex_key_args_str {##1}
    }
  }
}
\int_new:N \l_stex_assoc_args_count

\cs_new_protected:Nn \__stex_syms_parse_arity: {
  \int_zero:N \l_stex_get_symbol_arity_int
  \int_zero:N \l_stex_assoc_args_count
  \str_map_inline:Nn \l_stex_key_args_str {
    \str_case:nnF ##1 {
      0 { \str_map_break: }
      1 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {1}
        \str_set:Nn \l_stex_key_args_str {i}
      } }
      2 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {2}
        \str_set:Nn \l_stex_key_args_str {ii}
      } }
      3 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {3}
        \str_set:Nn \l_stex_key_args_str {iii}
      } }
      4 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {4}
        \str_set:Nn \l_stex_key_args_str {iiii}
      } }
      5 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {5}
        \str_set:Nn \l_stex_key_args_str {iiiii}
      } }
      6 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {6}
        \str_set:Nn \l_stex_key_args_str {iiiiii}
      } }
      7 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {7}
        \str_set:Nn \l_stex_key_args_str {iiiiiii}
      } }
      8 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {8}
        \str_set:Nn \l_stex_key_args_str {iiiiiiii}
      } }
      9 { \str_map_break:n{
        \int_set:Nn \l_stex_get_symbol_arity_int {9}
        \str_set:Nn \l_stex_key_args_str {iiiiiiiii}
      } }
      i {\int_incr:N \l_stex_get_symbol_arity_int}
      b {\int_incr:N \l_stex_get_symbol_arity_int}
      a {\int_incr:N \l_stex_get_symbol_arity_int \int_incr:N \l_stex_assoc_args_count}
      B {\int_incr:N \l_stex_get_symbol_arity_int \int_incr:N \l_stex_assoc_args_count}
    }{
      \msg_error:nnxx{stex}{error/wrongargs}{}{##1}
    }
  }
}
\cs_new_protected:Nn \_stex_symdecl_html: {
  \stex_annotate_invisible:n{
    \hbox{\exp_args:Ne \stex_annotate:nn {
      data-shtml-symdecl = { \l_stex_key_name_str},
      data-shtml-args = {\l_stex_key_args_str}
      \str_if_empty:NF \l_stex_macroname_str {,
        data-shtml-macroname={\l_stex_macroname_str}
      }
      \str_if_empty:NF \l_stex_key_wikidata_str {,
        data-shtml-wikidata={\l_stex_key_wikidata_str}
      }
      \str_if_empty:NF \l_stex_key_assoc_str {,
        data-shtml-assoctype={\l_stex_key_assoc_str}
      }
      \str_if_empty:NF \l_stex_key_reorder_str {,
        data-shtml-reorderargs={\l_stex_key_reorder_str}
      }
      \str_if_empty:NF \l_stex_key_role_str {,
        data-shtml-role={\l_stex_key_role_str}
      }
    }{\_stex_annotate_force_break:n{
      \bool_set_true:N \stex_in_invisible_html_bool
      \tl_if_empty:NF \l_stex_key_type_tl {
        $\stex_annotate:nn{data-shtml-type={}}{\l_stex_key_type_tl}$
      }
      \tl_if_empty:NF \l_stex_key_def_tl {
        $\stex_annotate:nn{data-shtml-definiens={}}{\l_stex_key_def_tl}$
      }
      \tl_if_empty:NF \l_stex_key_return_tl{
        \exp_args:Nno \use:n{
        \cs_generate_from_arg_count:NNnn \l__stex_syms_cs
        \cs_set:Npn \l_stex_get_symbol_arity_int} \l_stex_key_return_tl
        \tl_set:Ne \l__stex_syms_args_tl {\_stex_map_args:N \_stex_return_args:nn}
        $\stex_annotate:nn{data-shtml-returntype={}}{
          \exp_after:wN \l__stex_syms_cs \l__stex_syms_args_tl!
        }$
      }
      \clist_if_empty:NF \l_stex_key_argtypes_clist {
        \stex_annotate:nn{data-shtml-argtypes={}}{\_stex_annotate_force_break:n{
          \clist_map_inline:Nn \l_stex_key_argtypes_clist {
              $\stex_annotate:nn{data-shtml-type={}}{##1}$
          }
        }}
      }
    }}
  }}
}
\cs_new_protected:Nn \stex_add_symbol:nnnnnnnN {
  \stex_debug:nn{declaration}{New~declaration:~\stex_use_module_uri:N \l_stex_current_module_uri :~ #2^^J
    Macro:#1^^JArity:#3~(#4)^^J
    Def:~\tl_to_str:n{#5}^^J
    Type:~\tl_to_str:n{#6}^^J
    Returns:~\tl_to_str:n{#7}^^J
    Invokes:~\tl_to_str:n{#8}
  }
  \prop_gput:cnn{ \_stex_symbol_macro:N \l_stex_current_module_uri }
  {#2}{{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}
  \tl_if_empty:nF{#1}{
    \stex_do_up_to_module:n {
      \__stex_syms_activate_i:nnnnnnnn{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}
    }
  }
}
\cs_new_protected:Nn \_stex_activate_symbols: {
  \stex_debug:nn{activating}{All~symbols:~\cs_meaning:c{ \_stex_symbol_macro:N \l_stex_current_module_uri }}
  \prop_map_inline:cn{ \_stex_symbol_macro:N \l_stex_current_module_uri }{
    \__stex_syms_maybe_activate:nnnnnnnn ##2
  }
}

\cs_new_protected:Nn \__stex_syms_maybe_activate:nnnnnnnn {
  \str_if_empty:nF{#1}{
    \__stex_syms_activate_i:nnnnnnnn {#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}
  }
}

\cs_new_protected:Nn \__stex_syms_activate_i:nnnnnnnn {
  \stex_debug:nn{activating}{macro~#1:\stex_use_module_uri:N \l_stex_current_module_uri ? #2^^J
    \tl_to_str:n{{#3}{#4}{#5}{#6}{#7}#8}
  }
  \cs_set:cpe{#1} {
    \_stex_invoke_symbol:nnnnnnN
    {\exp_args:No \stex_new_symbol_uri:nn {\l_stex_current_module_uri} {#2} }
    \exp_not:n{{#3}{#4}{#5}{#6}{#7}{#8}}
  }
}
\prg_new_conditional:Nnn \stex_has_definiens:N { p, T, F, TF } {
  \exp_args:No \stex_has_definiens:nTF #1 \prg_return_true: \prg_return_false:
}
\prg_new_conditional:Nnn \stex_has_definiens:n { p, T, F, TF } {
  \exp_args:Nne \use:nn{\__stex_syms_has_definiens:nnnnnnnN}{\exp_args:Nne \prop_item:cn{
    \exp_args:Ne \_stex_symbol_macro:n {\stex_symbol_uri_module:n{#1}}
  }{
    \stex_symbol_uri_name:n {#1}
  }}
}

\cs_new:Nn \__stex_syms_has_definiens:nnnnnnnN {
  \tl_if_empty:nTF{#5}\prg_return_false:\prg_return_true:
}
\cs_new_protected:Nn \stex_iterate_symbols:n {
  \stex_pseudogroup_with:nn{\__stex_syms_sym_cs:nnnnnnnnN\stex_iterate_break:\stex_iterate_break:n}{
    \cs_set:Npn \__stex_syms_sym_cs:nnnnnnnnN
    ##1 ##2 ##3 ##4 ##5 ##6 ##7 ##8 ##9 { #1 }
    \cs_set:Npn \stex_iterate_break: {
      \prop_map_break:n{\seq_map_break:}
    }
    \cs_set:Npn \stex_iterate_break:n ##1 {
      \prop_map_break:n{\seq_map_break:n{##1}}
    }
    \seq_map_inline:Nn \l_stex_all_modules_seq {
      \prop_map_inline:cn{\_stex_symbol_macro:n {##1}}{
        \__stex_syms_sym_cs:nnnnnnnnN {##1} ####2
      }
    }
  }
}
\cs_new_protected:Nn \stex_iterate_symbols:nn {
  \seq_clear:N \l__stex_syms_mods_seq
  \stex_pseudogroup_with:nn{\__stex_syms_sym_cs:nnnnnnnnN}{
    \cs_set:Npn \__stex_syms_sym_cs:nnnnnnnnN
    ##1 ##2 ##3 ##4 ##5 ##6 ##7 ##8 ##9 { #2 }
    \clist_map_function:nN {#1} \__stex_syms_it_decl_i:n
  }
}

\cs_new_protected:Nn \__stex_syms_it_decl_i:n {
  \seq_if_in:NnF \l__stex_syms_mods_seq {#1} {
    \seq_put_left:Nn \l__stex_syms_mods_seq {#1}
    \prop_map_inline:cn{\_stex_morphisms_macro:n {#1} }{
      \__stex_syms_it_decl_check:nnnn ##2
    }
    \prop_map_inline:cn{\_stex_symbol_macro:n {#1} }{
      \__stex_syms_sym_cs:nnnnnnnnN {#1} ##2
    }
  }
}

\cs_new_protected:Nn \__stex_syms_it_decl_check:nnnn {
  \tl_if_empty:nT{#1}{
    \__stex_syms_it_decl_i:n {#2}
  }
}
\int_new:N \l_stex_get_symbol_arity_int

\cs_new_protected:Nn \stex_get_symbol:n {
  \stex_get_symbol:nF{ #1 }{
    \msg_error:nnn{stex}{error/unknownsymbol}{#1}
  }
}

\cs_new_protected:Npn \stex_get_symbol:nF #1 #2 {
  \tl_clear:N \l_stex_get_symbol_uri
  \cs_if_exist:cTF { #1 }{
    \cs_set_eq:Nc \l__stex_syms_cs { #1 }
    % command name
    \exp_args:Ne \tl_if_empty:nTF { \cs_argument_spec:N \l__stex_syms_cs }{
      % ...that takes no arguments
      \exp_args:Ne \cs_if_eq:NNTF {\tl_head:N \l__stex_syms_cs}
        \_stex_invoke_symbol:nnnnnnN
        \__stex_syms_get_symbol_from_cs:
        {\__stex_syms_get_symbol_from_string:n { #1 }}
    }{
      \__stex_syms_get_symbol_from_string:n { #1 }
    }
  }{
    \__stex_syms_get_symbol_from_string:n { #1 }
  }
  \tl_if_empty:NT \l_stex_get_symbol_uri { #2 }
}

\cs_new_protected:Nn \__stex_syms_get_symbol_from_cs: {
  \stex_pseudogroup_with:nn{\_stex_invoke_symbol:nnnnnnN}{
    \cs_set:Npn \_stex_invoke_symbol:nnnnnnN ##1 ##2 ##3 ##4 ##5 ##6 ##7 {
      \tl_set:Nn \l_stex_get_symbol_uri { ##1 }
      \int_set:Nn \l_stex_get_symbol_arity_int {##2}
      \tl_set:Nn \l_stex_get_symbol_args_tl {##3}
      \tl_set:Nn \l_stex_get_symbol_def_tl {##4}
      \tl_set:Nn \l_stex_get_symbol_type_tl {##5}
      \tl_set:Nn \l_stex_get_symbol_return_tl {##6}
      \tl_set:Nn \l_stex_get_symbol_invoke_cs {##7}
    }
    \l__stex_syms_cs
  }
}

\cs_new_protected:Nn \__stex_syms_get_symbol_from_string:n {
  \stex_debug:nn{symbols}{Getting~from~string~#1...}
  \seq_set_split:Nnn \l__stex_syms_seq ? {#1}
  \seq_pop_right:NN \l__stex_syms_seq \l__stex_syms_name
  \seq_if_empty:NTF \l__stex_syms_seq {
    \exp_args:No \__stex_syms_get_from_one_string:n {#1}
  }{
    \exp_args:NNe \exp_args:Nno \__stex_syms_get_symbol_from_modules:nn {
      \seq_use:Nn \l__stex_syms_seq ?
    } \l__stex_syms_name
  }
}

\cs_new_protected:Nn \__stex_syms_sym_from_str_i:nnnn {
  \bool_lazy_any:nTF{
    {\str_if_eq_p:nn{#2}{#3}}
    {\str_if_eq_p:nn{#2}{#4}}
    {\stex_str_if_ends_with_p:nn{#4}{/#2}}
    }{
      \__stex_syms_sym_i_finish:nnnnnnnN{#1}{#4}
    }{
      \__stex_syms_sym_i_gobble:nnnnnn
    }
}
\cs_new_protected:Nn \__stex_syms_sym_i_gobble:nnnnnn {}

\cs_new_protected:Nn \__stex_syms_sym_i_finish:nnnnnnnN {
  \prop_map_break:n{\seq_map_break:n{
    \tl_set:Ne \l_stex_get_symbol_uri { \stex_new_symbol_uri:nn {#1} {#2}}
    \int_set:Nn \l_stex_get_symbol_arity_int {#3}
    \tl_set:Nn \l_stex_get_symbol_args_tl {#4}
    \tl_set:Nn \l_stex_get_symbol_def_tl {#5}
    \tl_set:Nn \l_stex_get_symbol_type_tl {#6}
    \tl_set:Nn \l_stex_get_symbol_return_tl {#7}
    \tl_set:Nn \l_stex_get_symbol_invoke_cs {#8}
  }}
}

\cs_new_protected:Nn \__stex_syms_get_symbol_from_modules:nn {
  %\seq_set_split:Nnn \l_tmpa_seq ? {#1}
  %\seq_pop_right:NN \l_tmpa_seq \l__stex_syms_name_str
  %\str_set:Ne \l__stex_syms_path_str {\seq_use:Nn \l_tmpa_seq ?}
  \stex_debug:nn{symbols}{Getting~#2~in~#1...}
  \seq_map_inline:Nn \l_stex_all_modules_seq {
    %\stex_debug:nn{symbols}{comparing~\stex_module_uri_as_qm:n{##1}~and~#1}
    \exp_args:Ne \stex_str_if_ends_with:nnT{\stex_module_uri_as_qm:n{##1}}{#1}{
      \prop_map_inline:cn{\_stex_symbol_macro:n {##1} }{
        \__stex_syms_sym_from_str_i:nnnn{##1}{#2} ####2
      }
    }

    %\str_if_empty:NTF \l__stex_syms_path_str {
    %  \exp_args:NNe \exp_args:Nno \stex_str_if_ends_with:nnT {\stex_module_uri_name:n{##1}} \l__stex_syms_name_str
    %}{
    %  \exp_args:NNNe \exp_args:No \str_if_eq:nnT\l__stex_syms_name_str{
    %    \stex_module_uri_name:n {##1}
    %  }
    %}{
    %  \str_if_empty:NTF \l__stex_syms_path_str {
    %    \prop_map_inline:cn{\_stex_symbol_macro:n {##1} }{
    %      \__stex_syms_sym_from_str_i:nnnn{##1}{#2} ####2
    %    }
    %  }{
    %    \stex_debug:nn{symbols}{Comparing~\l__stex_syms_path_str;~with~\tl_to_str:n{##1}}
    %    \exp_args:NNe \exp_args:Nno \stex_str_if_ends_with:nnT{\stex_module_uri_path:n {##1}}\l__stex_syms_path_str {
    %      \prop_map_inline:cn{\_stex_symbol_macro:n {##1} }{
    %        \__stex_syms_sym_from_str_i:nnnn{##1}{#2} ####2
    %      }
    %    }
    %  }
    %}
  }
}

\prg_new_conditional:Nnn \__stex_syms_uri_match:n {T,F,TF} {
  \str_if_eq:nnT
}

\cs_new_protected:Nn \__stex_syms_get_from_one_string:n {
  \stex_debug:nn{symbols}{Getting~#1~anywhere...}
  \stex_iterate_symbols:n{
    %\stex_debug:nn{symbols}{>#1==##2~|~#1==##3<...}
    \bool_lazy_any:nT{
      {\str_if_eq_p:nn{#1}{##2}}
      {\str_if_eq_p:nn{#1}{##3}}
      {\stex_str_if_ends_with_p:nn{##3}{/#1}}
      }{
        \stex_iterate_break:n{
          \tl_set:Ne \l_stex_get_symbol_uri { \stex_new_symbol_uri:nn {##1} {##3}}
          \int_set:Nn \l_stex_get_symbol_arity_int {##4}
          \tl_set:Nn \l_stex_get_symbol_args_tl {##5}
          \tl_set:Nn \l_stex_get_symbol_def_tl {##6}
          \tl_set:Nn \l_stex_get_symbol_type_tl {##7}
          \tl_set:Nn \l_stex_get_symbol_return_tl {##8}
          \tl_set:Nn \l_stex_get_symbol_invoke_cs {##9}
        }
    }
  }
}
\stex_if_html_backend:TF {
  \prg_new_conditional:Nnn \stex_if_check_terms: {p, T, F, TF} {
    \prg_return_false:
  }
}{
  \stex_get_env:Nn\__stex_check_env_str{STEX_CHECKTERMS}
  \str_if_empty:NF\__stex_check_env_str{
    \exp_args:No \str_if_eq:nnF \__stex_check_env_str{false}{
      \bool_set_true:N \c_stex_check_terms_bool
    }
  }
  \bool_if:NTF \c_stex_check_terms_bool {
    \prg_new_conditional:Nnn \stex_if_check_terms: {p, T, F, TF} {
      \prg_return_true:
    }
  }{
    \prg_new_conditional:Nnn \stex_if_check_terms: {p, T, F, TF} {
      \prg_return_false:
    }
  }
}
\stex_if_check_terms:TF{
  \cs_new_protected:Nn \stex_check_term:nn {
    \marginpar {\tiny Checking~#1:~
      \group_begin:
        $#2$
      \group_end:
    }
  }
}{
  \cs_new_protected:Nn \stex_check_term:nn {}
}
\stex_if_check_terms:TF{
  \cs_new_protected:Nn \_stex_check_terms: {
    \stex_debug:nn{check_terms}{Checking~type...}
    \tl_if_empty:NF \l_stex_key_type_tl {
      \stex_check_term:nn{type}\l_stex_key_type_tl
    }
    \stex_debug:nn{check_terms}{Checking~definiens...}
    \tl_if_empty:NF \l_stex_key_def_tl {
      \stex_check_term:nn{definiens}\l_stex_key_def_tl
    }
    \stex_debug:nn{check_terms}{Checking~return...}
    \tl_if_empty:NF \l_stex_key_return_tl {
      \stex_check_term:nn{return}{\l_stex_key_return_tl!}
    }
    \stex_debug:nn{check_terms}{Checking~argument~types...}
    \group_begin:\l_stex_key_argtypes_clist\group_end:
    \tl_if_empty:NF \l_stex_key_argtypes_clist {
      \stex_check_term:nn{argument~types}{\l_stex_key_argtypes_clist}
    }
  }
}{
  \cs_new_protected:Nn \_stex_check_terms: {}
}

\prop_new:N \l_stex_variables_prop
\bool_new:N \l__stex_vars_bind_bool
\cs_new_protected:Nn \_stex_variable:nnnnnnnN {}

\stex_new_stylable_cmd:nnnn {vardef} { m O{} m} {
  \stex_keys_set:nn{vardef}{#2}
  \str_set:Ne \l_stex_macroname_str { #1 }
  \str_if_empty:NT \l_stex_key_name_str {
    \str_set:Ne \l_stex_key_name_str { #1 }
  }

  \stex_symdecl_do:
  \stex_if_check_terms:T \_stex_check_terms:
  \__stex_vars_add:
  \__stex_vars_macro:
  \stex_if_do_html:T \__stex_vars_html:

  \int_set:Nn \l_stex_get_symbol_arity_int {\l_stex_get_symbol_arity_int}
  \stex_debug:nn{vardef}{Doing~\l_stex_key_name_str}
  \tl_set_eq:NN \l_stex_get_symbol_return_tl \l_stex_key_return_tl
  \stex_notation_parse:n{#3}
  \stex_if_check_terms:T{ \_stex_notation_check: }
  \_stex_var_notation_macro:
  \stex_if_do_html:T {
    \def\comp{\_varcomp}
    \_stex_notation_do_html:n \l_stex_key_name_str
  }
  \group_begin:
  \tl_set_eq:NN \thisvarname \l_stex_key_name_str
  \tl_clear:N \thisstyle
  \str_set_eq:NN\thisnotationvariant\l_stex_key_variant_str
  \def\thisnotation{
    \exp_args:Nne \use:nn{\l_stex_notation_macrocode_cs{}}{
      \_stex_notation_make_args:
    }
  }
  \stex_style_apply:
  \group_end:\ignorespaces
}{}
\cs_new_protected:Nn \__stex_vars_add: {
  \exp_args:NNNo \exp_args:NNne
  \prop_put:Nnn \l_stex_variables_prop \l_stex_key_name_str {
    {\l_stex_macroname_str}
    {\l_stex_key_name_str}
    {\int_use:N \l_stex_get_symbol_arity_int}
    {\l_stex_get_symbol_args_tl}
    {\exp_args:No \exp_not:n \l_stex_key_def_tl}
    {\exp_args:No \exp_not:n \l_stex_key_type_tl}
    {\exp_args:No \exp_not:n \l_stex_key_return_tl}
    \stex_invoke_symbol:
  }
}
\cs_new_protected:Nn \__stex_vars_macro: {
  \tl_set:ce{\l_stex_macroname_str}{
    \_stex_invoke_variable:nnnnnnN
      {\l_stex_key_name_str}
      {\int_use:N \l_stex_get_symbol_arity_int}
      {\l_stex_get_symbol_args_tl}
      {\exp_args:No \exp_not:n \l_stex_key_def_tl}
      {\exp_args:No \exp_not:n \l_stex_key_type_tl}
      {\exp_args:No \exp_not:n \l_stex_key_return_tl}
      \stex_invoke_symbol:
  }
}

\cs_new_protected:Nn \__stex_vars_html: {
  \stex_if_do_html:T {
    \hbox\bgroup\exp_args:Ne \stex_annotate_invisible:nn {
      data-shtml-vardef = {\l_stex_key_name_str},
      data-shtml-args = {\l_stex_key_args_str}
      \str_if_empty:NF \l_stex_macroname_str {,
        data-shtml-macroname={\l_stex_macroname_str}
      }
      \str_if_empty:NF \l_stex_key_assoc_str {,
        data-shtml-assoctype={\l_stex_key_assoc_str}
      }
      \str_if_empty:NF \l_stex_key_role_str {,
        data-shtml-role={\l_stex_key_role_str}
      }
      \str_if_empty:NF \l_stex_key_reorder_str {,
        data-shtml-reorderargs={\l_stex_key_reorder_str}
      }
      \bool_if:NT \l__stex_vars_bind_bool {,
        data-shtml-bind={}
      }
    }{
      \_stex_annotate_force_break:n{
        \bool_set_true:N \stex_in_invisible_html_bool
        \tl_if_empty:NF \l_stex_key_type_tl {
          \stex_annotate:nn{data-shtml-type={}}{$\l_stex_key_type_tl$}
        }
        \tl_if_empty:NF \l_stex_key_def_tl {
          \stex_annotate:nn{data-shtml-definiens={}}{$\l_stex_key_def_tl$}
        }
        \tl_if_empty:NF \l_stex_key_return_tl{
          \exp_args:Nno \use:n{
          \cs_generate_from_arg_count:NNnn \l__stex_vars_cs
          \cs_set:Npn \l_stex_get_symbol_arity_int} \l_stex_key_return_tl
          \tl_set:Ne \l__stex_vars_args_tl {\_stex_map_args:N \_stex_return_args:nn}
          $\stex_annotate:nn{data-shtml-returntype={}}{
            \exp_after:wN \l__stex_vars_cs \l__stex_vars_args_tl!}$
        }
        \tl_if_empty:NF \l_stex_key_argtypes_clist {
          \stex_annotate:nn{data-shtml-argtypes={}}{
            \_stex_annotate_force_break:n{
              \clist_map_inline:Nn \l_stex_key_argtypes_clist {
                $\stex_annotate:nn{data-shtml-type={}}{##1}$
              }
            }
          }
        }
      }
    }\egroup
  }
}
\cs_new_protected:Nn \stex_get_var:n {
  \str_clear:N \l_stex_get_variable_str
  \__stex_vars_get_var:n{#1}
  \str_if_empty:NT \l_stex_get_variable_str {
    \msg_error:nnn{stex}{error/unknownsymbol}{#1}
  }
}

\cs_new_protected:Nn \__stex_vars_get_var:n {
  \prop_map_inline:Nn \l_stex_variables_prop {
    \__stex_vars_check_var:nnnnnnnnN {#1} ##2
  }
}

\cs_new_protected:Nn \__stex_vars_check_var:nnnnnnnnN {
  \str_if_eq:nnTF{#1}{#2}{
    \prop_map_break:n{\__stex_vars_set_vars:nnnnnnN {#3}{#4}{#5}{#6}{#7}{#8}#9}
  }{
    \str_if_eq:nnT{#1}{#3}{
      \prop_map_break:n{\__stex_vars_set_vars:nnnnnnN {#3}{#4}{#5}{#6}{#7}{#8}#9}
    }
  }
}

\cs_new_protected:Nn \__stex_vars_set_vars:nnnnnnN {
  \stex_debug:nn{symbols}{Variable~#1~found}
  \cs_set:Npn \_stex_variable:nnnnnnnN ##1 ##2 ##3 ##4 ##5 ##6 ##7 ##8 {}
  \str_set:Nn \l_stex_get_variable_str {#1}
  \int_set:Nn \l_stex_get_symbol_arity_int {#2}
  \tl_set:Nn \l_stex_get_symbol_args_tl {#3}
  \tl_set:Nn \l_stex_get_symbol_def_tl {#4}
  \tl_set:Nn \l_stex_get_symbol_type_tl {#5}
  \tl_set:Nn \l_stex_get_symbol_return_tl {#6}
  \tl_set:Nn \l_stex_get_symbol_invoke_cs {#7}
}
\stex_new_stylable_cmd:nnnn {varseq}{m O{} m m} {
  \stex_keys_set:nn{symdef}{#2}
  \str_set:Ne \l_stex_macroname_str { #1 }
  \str_if_empty:NT \l_stex_key_name_str {
    \str_set:Ne \l_stex_key_name_str { #1 }
  }
  \str_if_empty:NT \l_stex_key_args_str {
    \str_set:Nn \l_stex_key_args_str {1}
  }
  \stex_symdecl_do:

  \tl_set_eq:NN \l_stex_get_symbol_return_tl \l_stex_key_return_tl
  \clist_set:Nn \l__stex_seqs_range_clist {#3}
  \tl_if_empty:NTF \l_stex_key_op_tl {
    \stex_notation_parse:n{#4}
    \tl_clear:N \l_stex_key_op_tl
  }{
    \stex_notation_parse:n{#4}
  }
  \stex_if_do_html:T \__stex_seqs_html:
  \stex_if_check_terms:T \_stex_check_terms:
  \__stex_seqs_add:
  \__stex_seqs_macro:
  \stex_if_check_terms:T \_stex_notation_check:
  \_stex_var_notation_macro:
  \group_begin:
  \tl_set_eq:NN \thisvarname \l_stex_key_name_str
  \tl_clear:N \thisstyle
  \str_set_eq:NN\thisnotationvariant\l_stex_key_variant_str
  \def\thisnotation{
    \l_stex_notation_macrocode_cs{}!
  }
  \stex_style_apply:
  \group_end:\ignorespaces
}{}

\cs_new_protected:Nn \__stex_seqs_add: {
  \exp_args:NNNo \exp_args:NNne
  \prop_put:Nnn \l_stex_variables_prop \l_stex_key_name_str {
    {\l_stex_macroname_str}
    {\l_stex_key_name_str}
    {\int_use:N \l_stex_get_symbol_arity_int}
    {\l_stex_get_symbol_args_tl}
    {\exp_args:No \exp_not:n \l_stex_key_def_tl}
    {\exp_args:No \exp_not:n \l__stex_seqs_range_clist}
    {\exp_args:No \exp_not:n \l_stex_key_return_tl}
    \stex_invoke_sequence:
  }
}

\cs_new_protected:Nn \__stex_seqs_macro: {
  \tl_set:ce{\l_stex_macroname_str}{
    \_stex_invoke_variable:nnnnnnN
      {\l_stex_key_name_str}
      {\int_use:N \l_stex_get_symbol_arity_int}
      {\l_stex_get_symbol_args_tl}
      {\exp_args:No \exp_not:n \l_stex_key_def_tl}
      {\exp_args:No \exp_not:n \l__stex_seqs_range_clist}
      {\exp_args:No \exp_not:n \l_stex_key_return_tl}
      \stex_invoke_sequence:
  }
}

\cs_new_protected:Nn \__stex_seqs_html: {
    \exp_args:Ne \stex_annotate_invisible:nn {
      data-shtml-varseq = {\l_stex_key_name_str},
      data-shtml-args = {\l_stex_key_args_str}
      \str_if_empty:NF \l_stex_macroname_str {,
        data-shtml-macroname={\l_stex_macroname_str}
      }
      \str_if_empty:NF \l_stex_key_assoc_str {,
        data-shtml-assoctype={\l_stex_key_assoc_str}
      }
      \str_if_empty:NF \l_stex_key_role_str {,
        data-shtml-role={\l_stex_key_role_str}
      }
      \str_if_empty:NF \l_stex_key_reorder_str {,
        data-shtml-reorderargs={\l_stex_key_reorder_str}
      }
    }{\hbox\bgroup
      \_stex_annotate_force_break:n{
        \tl_if_empty:NF \l_stex_key_type_tl {
          \stex_annotate:nn{data-shtml-type={}}{$\l_stex_key_type_tl$}
        }
        \tl_if_empty:NF \l_stex_key_def_tl {
          \stex_annotate:nn{data-shtml-definiens={}}{$\l_stex_key_def_tl$}
        }
        \tl_if_empty:NF \l_stex_key_return_tl{
          \exp_args:Nno \use:n{
          \cs_generate_from_arg_count:NNnn \l__stex_seqs_cs
          \cs_set:Npn \l_stex_get_symbol_arity_int} \l_stex_key_return_tl
          \tl_set:Nx \l__stex_seqs_args_tl {\_stex_map_args:N \_stex_return_args:nn}
          \stex_annotate:nn{data-shtml-returntype={}}{
            $\exp_after:wN \l__stex_seqs_cs \l__stex_seqs_args_tl!$}
        }
        \tl_if_empty:NF \l_stex_key_argtypes_clist {
          \stex_annotate:nn{data-shtml-argtypes={}}{
            \_stex_annotate_force_break:n{
              \clist_map_inline:Nn \l_stex_key_argtypes_clist {
                \stex_annotate:nn{data-shtml-type={}}{$##1$}
              }
            }
          }
        }
      }
    \egroup}
}
\stex_keys_define:nnnn{notation}{
  \str_clear:N \l_stex_key_variant_str
  \str_clear:N \l_stex_key_prec_str
  \str_clear:N \l_stex_key_op_tl
  \str_clear:N \l_stex_key_intent_str
  \clist_clear:N \l_stex_key_intent_args_clist
}{
  variant    .str_set_x:N  = \l_stex_key_variant_str ,
  prec       .str_set_x:N  = \l_stex_key_prec_str ,
  op         .tl_set:N     = \l_stex_key_op_tl ,
  intent     .str_set:N    = \l_stex_key_intent_str ,
  argnames   .clist_set:N  = \l_stex_key_intent_args_clist ,
  unknown    .code:n       = {
    \str_if_empty:NTF \l_keys_key_str {
        \str_set:Ne \l_stex_key_variant_str {\l_keys_key_tl}
    }{
        \str_set_eq:NN \l_stex_key_variant_str \l_keys_key_str
    }
  }
}{style}

\stex_keys_define:nnnn{symdef}{}{}{decl,notation}

\stex_keys_define:nnnn{vardef}{
  \bool_set_false:N \l__stex_notations_bind_bool
}{
  bind  .bool_set:N  = \l__stex_notations_bind_bool
}{symdef}

\stex_new_stylable_cmd:nnnn {notation} { s m O{} m} {
  \stex_keys_set:nn{notation}{#3}
  \stex_get_symbol:n{#2}
  \stex_notation_parse:n{#4}
  \stex_if_check_terms:T{ \_stex_notation_check: }
  \_stex_notation_add:
  \stex_if_do_html:T {
    \def\comp{\_comp}
    \_stex_notation_do_html:n{\stex_use_symbol_uri:N \l_stex_get_symbol_uri}
  }
  \IfBooleanTF#1{
    \_stex_notation_set_default:n{
      \l_stex_get_symbol_uri
    }
  }{}
  \stex_if_smsmode:F{
    \group_begin:
    \__stex_notations_styledefs:
    \stex_style_apply:
    \group_end:
  }
  \stex_smsmode_do:
}{}

\stex_deactivate_macro:Nn \notation {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \notation}
\stex_sms_allow_escape:N \notation

\cs_new_protected:Nn \__stex_notations_styledefs: {
  \str_set_eq:NN\thisnotationvariant\l_stex_key_variant_str
  \str_set:Nn \thisdeclname {\stex_symbol_uri_name:N \l_stex_get_symbol_uri}
  \tl_set:Ne \thisdecluri {\stex_use_symbol_uri:N \l_stex_get_symbol_uri}
  \def\thisnotation{
    \exp_args:Nne \use:nn{\l_stex_notation_macrocode_cs{}}{
      \_stex_notation_make_args:
    }
  }
}
\stex_new_stylable_cmd:nnnn {varnotation} { s m O{} m} {
  \stex_keys_set:nn{notation}{#3}
  \stex_get_var:n{#2}
  \str_set_eq:NN \l_stex_key_name_str \l_stex_get_variable_str
  \stex_notation_parse:n{#4}
  \stex_if_check_terms:T{ \_stex_notation_check: }
  \_stex_var_notation_macro:
  \IfBooleanTF#1{
    \_stex_notation_set_default:n{\l_stex_get_variable_str}
  }{}
  \group_begin:
  \tl_set_eq:NN \thisvarname \l_stex_get_variable_str
  \tl_clear:N \thisstyle
  \str_set_eq:NN\thisnotationvariant\l_stex_key_variant_str
  \def\thisnotation{
    \exp_args:Nne \use:nn{\l_stex_notation_macrocode_cs{}}{
      \_stex_notation_make_args:
    }
  }
  \stex_style_apply:
  \group_end:
}{}
\cs_new_protected:Nn \stex_notation_parse:n {
  \tl_if_empty:NF \l_stex_key_op_tl {
    \tl_set:Ne \l_stex_key_op_tl { \exp_not:N\maincomp {
      \exp_args:No \exp_not:n \l_stex_key_op_tl
    } }
  }
  \seq_clear:N \l__stex_notations_precs_seq
  \tl_clear:N \l_stex_notation_args_tl
  \int_compare:nNnTF \l_stex_get_symbol_arity_int = 0 {
    \__stex_notations_const_precs:
    \tl_if_empty:NT \l_stex_key_op_tl {
      \tl_set:Nn \l_stex_key_op_tl { \maincomp{#1} }
    }
  }{
    \__stex_notations_fun_precs:
    \__stex_notations_do_missing_args:n{#1}
    \tl_if_empty:NT \l_stex_key_op_tl {
      \hbox_set:Nn \l_tmpa_box {
        \tl_clear:N \l_stex_current_full_tl
        \tl_clear:N \l_stex_current_display_tl
        \cs_set:Npn \l_tmpa_cs ##1 ##2 ##3 ##4 ##5 ##6 ##7 ##8 ##9 { #1 }
        \cs_set:Npn \maincomp ##1 {
          \tl_gset:Nn \l_stex_key_op_tl { \maincomp{##1} }
          ##1
        }
        \cs_set:Npn \argsep ##1 ##2 {##1 ##2}
        \cs_set:Npn \argmap ##1 ##2 ##3 {##1 ##3}
        \cs_set:Npn \argarraymap ##1 ##2 ##3 ##4 {
          ##1 ##2
        }
        \stex_suppress_html:n{$\l_tmpa_cs abcdefghj$}
      }
    }
  }
  \exp_args:NNe
  \tl_set:Nn \l_stex_notation_macrocode_cs {
    \STEXInternalNotation
      { \l_stex_key_variant_str }
      { \l__stex_notations_opprec_tl }
      { \l_stex_key_intent_str }
      { \l_stex_notation_args_tl }
      {
        \int_compare:nNnTF \l_stex_get_symbol_arity_int = 0
        { \exp_not:n { \maincomp{ #1 } } }
        { \exp_not:n { #1 } \l__stex_notations_missing_tl }
      }
  }
  \stex_debug:nn{notation}{Notation:~\meaning\l_stex_notation_macrocode_cs}
}
\cs_new_protected:Nn \__stex_notations_const_precs: {
  \str_if_empty:NTF \l_stex_key_prec_str {
    \tl_set:No \l__stex_notations_opprec_tl { \neginfprec }
  }{
    \str_if_eq:onTF \l_stex_key_prec_str {nobrackets}{
      \tl_set:No \l__stex_notations_opprec_tl { \neginfprec }
    }{
      \tl_set_eq:NN \l__stex_notations_opprec_tl \l_stex_key_prec_str
    }
  }
}

\cs_new_protected:Nn \__stex_notations_fun_precs: {
  \str_if_empty:NTF \l_stex_key_prec_str {
    \tl_set:No \l__stex_notations_opprec_tl { \neginfprec }
  }{
    \str_if_eq:onTF \l_stex_key_prec_str {nobrackets}{
      \tl_set:No \l__stex_notations_opprec_tl { \neginfprec }
    }{
      \tl_set_eq:NN \l__stex_notations_opprec_tl \l_stex_key_prec_str
    }
  }
  \str_if_empty:NTF \l_stex_key_prec_str {
    \tl_set:Nn \l__stex_notations_opprec_tl { 0 }
    \int_step_inline:nn \l_stex_get_symbol_arity_int {
      \seq_put_right:Nn \l__stex_notations_precs_seq {0}
    }
  }{
    \str_if_eq:onTF \l_stex_key_prec_str {nobrackets}{
      \stex_debug:nn{notation}{No~brackets}
      \tl_set:No \l__stex_notations_opprec_tl { \neginfprec }
      \int_step_inline:nn \l_stex_get_symbol_arity_int {
        \exp_args:NNo \seq_put_right:Nn \l__stex_notations_precs_seq \infprec
      }
    }\__stex_notations_parse_precs:
  }
  \__stex_notations_do_argnames:
}

\cs_new_protected:Nn \__stex_notations_parse_precs: {
  \stex_debug:nn{notation}{parsing~precedence~\l_stex_key_prec_str}
  \seq_set_split:NnV \l__stex_notations_seq ; \l_stex_key_prec_str
  \seq_pop_left:NNTF \l__stex_notations_seq \l__stex_notations_str {
    \tl_set_eq:NN \l__stex_notations_opprec_tl \l__stex_notations_str
    \seq_pop_left:NNT \l__stex_notations_seq \l__stex_notations_str {
      \exp_args:NNo \seq_set_split:NnV \l__stex_notations_seq
        {\tl_to_str:n{x}} \l__stex_notations_str
    }
  }{
    \tl_set:No \l__stex_notations_opprec_tl { 0 }
  }
  \int_step_inline:nn \l_stex_get_symbol_arity_int {
    \seq_pop_left:NNTF \l__stex_notations_seq \l__stex_notations_str {
      \seq_put_right:No \l__stex_notations_precs_seq \l__stex_notations_str
    }{
      \seq_put_right:No \l__stex_notations_precs_seq \l__stex_notations_opprec_tl
    }
  }
}
\cs_new_protected:Nn \__stex_notations_do_argnames: {
  \tl_clear:N \l_stex_notation_args_tl
  \_stex_map_args:N \__stex_notations_do_argname:nn
}

\cs_new_protected:Nn \__stex_notations_do_argname:nn {
  \clist_if_empty:NTF \l_stex_key_intent_args_clist {
    \tl_put_right:Ne \l_stex_notation_args_tl {
      #1#2{\seq_item:Nn \l__stex_notations_precs_seq #1}{
        \str_if_empty:NF \l_stex_key_intent_str {#1}
      }
    }
  }{
    \tl_put_right:Ne \l_stex_notation_args_tl {
      #1#2{\seq_item:Nn \l__stex_notations_precs_seq #1}
      {\c_dollar_str\clist_item:Nn \l_stex_key_intent_args_clist 1}
    }
    \clist_pop:NN \l_stex_key_intent_args_clist \l_tmpa_tl
  }
}
\cs_new:Nn \__stex_notations_do_missing_args:n {
  \str_set:Nn \l__stex_notations_missing_str {#1}
  \exp_args:NNe \seq_set_split:NnV \l_tmpa_seq {\c_hash_str\c_hash_str\c_hash_str\c_hash_str} \l__stex_notations_missing_str
  \str_clear:N \l__stex_notations_missing_str
  \seq_map_inline:Nn \l_tmpa_seq {
    \tl_put_right:Nn \l__stex_notations_missing_str { ##1 }
  }
  \tl_clear:N \l__stex_notations_missing_tl
  \_stex_map_args:N \__stex_notations_add_missing_args:nn
}

\cs_new:Nn \__stex_notations_add_missing_args:nn {
  % TODO this skips arguments if e.g. ##1 occurs rather than #1!!
  \exp_args:NNe \str_if_in:NnF \l__stex_notations_missing_str {\c_hash_str\c_hash_str#1}{
    \tl_put_right:Nn \l__stex_notations_missing_tl{\STEXinvisible{## #1}}
  }
}
\cs_new_protected:Nn \_stex_notation_add: {
  \stex_add_notation:ooeoo
    {\l_stex_get_symbol_uri}
    \l_stex_key_variant_str
    {\int_use:N \l_stex_get_symbol_arity_int}
    \l_stex_notation_macrocode_cs
    \l_stex_key_op_tl
}
\cs_new:Nn \__stex_notations_macro:nn {
  l_stex_notation_ #1?#2 _cs
}
\cs_new:Nn \__stex_notations_op_macro:nn {
  l_stex_notation_ #1?#2 _op_cs
}

\cs_new_protected:Nn \stex_add_notation:nnnnn {
  \exp_args:Nne \stex_debug:nn{notations}{Adding~notation:^^J
    #1~\c_hash_str#2~#3^^J
    \tl_to_str:n{#4}^^J\tl_to_str:n{#5}^^J
    to~\stex_use_module_uri:N \l_stex_current_module_uri
  }
  \prop_gput:cen{ \_stex_notations_macro:N \l_stex_current_module_uri }
  {\stex_use_symbol_uri:n{#1}?#2}{{#1}{#2}{#3}{#4}{#5}}
  \stex_do_up_to_module:n {
    \__stex_notations_set_macro:nnnnn{#1}{#2}{#3}{#4}{#5}
    %\__stex_notations_activate_not:nn{#1}{#2}
  }
}
\cs_generate_variant:Nn \stex_add_notation:nnnnn {ooeoo}

\cs_new_protected:Nn \_stex_activate_notations: {
  \stex_debug:nn{activating}{All~notations:~\cs_meaning:c{ \_stex_notations_macro:N \l_stex_current_module_uri }}
  \prop_map_inline:cn{ \_stex_notations_macro:N \l_stex_current_module_uri }{
    \__stex_notations_set_macro:nnnnn ##2
  }
}

\cs_new_protected:Nn \__stex_notations_activate_not:nn {
  \bool_set_false:N \l_tmpa_bool
  \stex_debug:nn{notations}{activating~\stex_use_symbol_uri:n{#1}?#2}
  \prop_map_inline:cn{ \_stex_notations_macro:N \l_stex_current_module_uri }{
    %\stex_debug:nn{notations}{##1?}
    \exp_args:Ne \str_if_eq:nnT{\stex_use_symbol_uri:n{#1}?#2}{##1}{
      \prop_map_break:n{
        %\stex_debug:nn{notations}{Found:~\tl_to_str:n{##2}}
        \bool_set_true:N \l_tmpa_bool
        \__stex_notations_set_macro:nnnnn ##2
      }
    }
  }
  \bool_if:NF \l_tmpa_bool {
    \errmessage{Woop}
  }
}

\cs_new_protected:Nn \__stex_notations_set_macro:nnnnn {
  \tl_set:cn {\__stex_notations_macro:nn{\stex_use_symbol_uri:n{#1}}{#2}}{#4}
  \cs_if_exist:cF{\__stex_notations_macro:nn{\stex_use_symbol_uri:n{#1}}{}}{
    \tl_set:cn {\__stex_notations_macro:nn{\stex_use_symbol_uri:n{#1}}{}}{#4}
  }
  \tl_if_empty:nF{#5}{
    \tl_set:cn{\__stex_notations_op_macro:nn{\stex_use_symbol_uri:n{#1}}{#2}}{#5}
    \cs_if_exist:cF{\__stex_notations_op_macro:nn{\stex_use_symbol_uri:n{#1}}{}}{
      \tl_set:cn{\__stex_notations_op_macro:nn{\stex_use_symbol_uri:n{#1}}{}}{#5}
    }
  }
}
\cs_new:Nn \_stex_map_args:N {
  \tl_if_empty:NF \l_stex_get_symbol_args_tl {
    \exp_after:wN \__stex_notations_map_args_i:w \exp_after:wN
    #1 \l_stex_get_symbol_args_tl \__stex_notations_args_end:
  }
}
\cs_new:Npn \__stex_notations_map_args_i:w #1 #2 #3 #4 \__stex_notations_args_end: {
  #1 {#2} {#3}
  \tl_if_empty:nF{#4}{
    \__stex_notations_map_args_i:w #1 #4 \__stex_notations_args_end:
  }
}

\cs_new:Nn \_stex_map_notation_args:N {
  \tl_if_empty:NF \l_stex_notation_args_tl {
    \exp_after:wN \__stex_notations_map_args_ii:w \exp_after:wN
    #1 \l_stex_notation_args_tl \__stex_notations_args_end:
  }
}
\cs_new:Npn \__stex_notations_map_args_ii:w #1 #2 #3 #4 #5 #6 \__stex_notations_args_end: {
  #1 {#2} {#3} {#4} {#5}
  \tl_if_empty:nF{#6}{
    \__stex_notations_map_args_ii:w #1 #6 \__stex_notations_args_end:
  }
}
\cs_new_protected:Nn \_stex_var_notation_macro: {
  \tl_set_eq:cN {\__stex_notations_macro:nn{\l_stex_key_name_str}{\l_stex_key_variant_str}}\l_stex_notation_macrocode_cs
  \cs_if_exist:cF {\__stex_notations_macro:nn{\l_stex_key_name_str}{}}{
    \tl_set_eq:cN{\__stex_notations_macro:nn{\l_stex_key_name_str}{}}
      \l_stex_notation_macrocode_cs
  }
  \tl_if_empty:NF \l_stex_key_op_tl {
    \tl_set_eq:cN {\__stex_notations_op_macro:nn{\l_stex_key_name_str}{\l_stex_key_variant_str}}\l_stex_key_op_tl
    \cs_if_exist:cF{\__stex_notations_op_macro:nn{\l_stex_key_name_str}{}}{
      \cs_set_eq:cN{\__stex_notations_op_macro:nn{\l_stex_key_name_str}{}}
      \l_stex_key_op_tl
    }
  }
}
\cs_new_protected:Nn \_stex_notation_set_default:n{
  \stex_if_in_module:TF{
    \stex_add_notation:ooeoo{#1}{}
      {\int_use:N \l_stex_get_symbol_arity_int}
      \l_stex_notation_macrocode_cs
      \l_stex_key_op_tl
  }{
    \cs_set_eq:cN {\__stex_notations_macro:nn {\stex_use_symbol_uri:N \l_stex_get_symbol_uri}{}}
      \l_stex_notation_macrocode_cs
    \tl_if_empty:NF \l_stex_key_op_tl {
      \cs_set_eq:cN{\__stex_notations_op_macro:nn{\stex_use_symbol_uri:N \l_stex_get_symbol_uri}{}}
        \l_stex_key_op_tl
    }
  }
}

\cs_new_protected:Npn \setnotation #1 #2 {
  \stex_get_symbol:n{#1}
  \cs_if_exist:cTF{\__stex_notations_macro:nn{\stex_use_symbol_uri:N \l_stex_get_symbol_uri}{#2}}{
    \tl_set_eq:Nc \l_stex_notation_macrocode_cs {\__stex_notations_macro:nn{\stex_use_symbol_uri:N \l_stex_get_symbol_uri}{#2}}
    \cs_if_exist:cTF{\__stex_notations_op_macro:nn{\stex_use_symbol_uri:N \l_stex_get_symbol_uri}{#2}}{
      \tl_set_eq:Nc \l_stex_key_op_tl {\__stex_notations_op_macro:nn{\stex_use_symbol_uri:N \l_stex_get_symbol_uri}{#2}}
    }{
      \tl_clear:N \l_stex_key_op_tl
    }
    \_stex_notation_set_default:n{
      \l_stex_get_symbol_uri
    }
  }{
    \msg_error:nnxx{stex}{error/unknownnotation}{#2}{
      \stex_use_symbol_uri:N \l_stex_get_symbol_uri
    }
  }
}
\cs_new_protected:Nn \stex_iterate_notations:nn {
  \seq_clear:N \l__stex_notations_mods_seq
  \stex_pseudogroup_with:nn{\__stex_notations_not_cs:nnnnn}{
    \cs_set:Npn \__stex_notations_not_cs:nnnnn
    ##1 ##2 ##3 ##4 ##5 { #2 }
    \clist_map_function:nN {#1} \__stex_notations_it_not_i:n
  }
}

\cs_new_protected:Nn \__stex_notations_it_not_i:n {
  \seq_if_in:NnF \l__stex_notations_mods_seq {#1} {
    \seq_put_left:Nn \l__stex_notations_mods_seq {#1}
    \prop_map_inline:cn{\_stex_notations_macro:n{#1}}{
      \__stex_notations_not_cs:nnnnn ##2
    }
    \prop_map_inline:cn{\_stex_morphisms_macro:n{#1}}{
      \__stex_notations_it_not_check:nnnn ##2
    }
  }
}
\cs_new_protected:Nn \__stex_notations_it_not_check:nnnn {
  \tl_if_empty:nT{#1}{
    \__stex_notations_it_not_i:n {#2}
  }
}
\cs_new_protected:Npn \stex_use_notation:nnTF #1 #2 #3 #4 {
  \cs_if_exist:cTF{\__stex_notations_macro:nn{#1}{#2}}{
    \cs_set_eq:Nc \l_stex_notation_cs {\__stex_notations_macro:nn{#1}{#2}}
    #3
  }{#4}
}
\cs_new_protected:Npn \stex_use_op_notation:nnTF #1 #2 #3 #4 {
  \cs_if_exist:cTF{\__stex_notations_op_macro:nn{#1}{#2}}{
    \cs_set_eq:Nc \l_stex_notation_cs {\__stex_notations_op_macro:nn{#1}{#2}}
    #3
  }{#4}
}
\cs_new_protected:Nn \_stex_notation_check: {
  \stex_check_term:nn{notation}{
    \cs_set:Npn \comp ##1 {##1}
    \stex_debug:nn{check}{Checking~notation:~\cs_meaning:N \l_stex_notation_macrocode_cs ^^J \cs_meaning:N\l_stex_notation_args_tl}
    \exp_args:Nne \use:nn{\l_stex_notation_macrocode_cs{}}{
      \_stex_notation_make_args:
    }
  }
}
\cs_new_protected:Nn \_stex_notation_do_html:n {
  \stex_annotate_invisible:n{\_stex_annotate_force_break:n{\hbox{\stex_annotate:nn {
    data-shtml-notation={#1},
    data-shtml-notationfragment={\l_stex_key_variant_str},
    data-shtml-precedence={\l__stex_notations_opprec_tl},
    data-shtml-argprecs={\seq_use:Nn \l__stex_notations_precs_seq ,}
  }{
    \cs_set_protected:Npn \argsep ##1 ##2 {
      \stex_annotate:nn{data-shtml-argsep={}}{
        ##1 ##2
      }
    }
    \cs_set_protected:Npn \argmap ##1 ##2 ##3 {
      \cs_set:Npn \__stex_notations_map_cs: ####1 { ##2 }
      \stex_annotate:nn{data-shtml-argmap={}}{
        \__stex_notations_map_cs:{##1} \stex_annotate:nn{data-shtml-argmap-sep={}}{##3}
      }
    }
    \cs_set_protected:Npn \maincomp {
      \_do_comp:nnNn {maincomp}{}\compemph@uri
    }
    \stex_debug:nn{notation}{Doing~notation~HTML:\meaning\l_stex_get_symbol_args_tl}
    $
      \tl_clear:N \l_stex_current_full_tl
      \stex_annotate:nn{data-shtml-notationcomp={}}{
        \exp_args:Nne \use:nn {
          \l_stex_notation_macrocode_cs {}
        }{
          \_stex_map_args:N \__stex_notations_make_arg_html:nn
        }
      }
    $
    \tl_if_empty:NF \l_stex_key_op_tl {
      $
      \tl_clear:N \l_stex_current_full_tl
      \stex_annotate:nn{data-shtml-notationopcomp={}}{
        \_stex_term_oms:nn{\l_stex_key_variant_str}{\l_stex_key_op_tl}
      }
      $
    }
  }}
  }}
}

\cs_new:Nn \__stex_notations_make_arg_html:nn {
  {\stex_annotate:nn{data-shtml-argnum=#1}{x}}
}
\cs_new:Nn \_stex_notation_make_args: {
  \_stex_map_notation_args:N \__stex_notations_make_arg:nnnn
}

\cs_new:Nn \__stex_notations_make_arg:nnnn  {
  \str_case:nnF #2 {
    a {{
        a\c_math_subscript_token{#1,1},
        a\c_math_subscript_token{#1,2}
      }}
    B {{
        B\c_math_subscript_token{#1,1},
        B\c_math_subscript_token{#1,2}
      }}
  }{{
    \_stex_term_arg:nnnnn{#1}{#2}{#3}{#4}
      {{#2}\c_math_subscript_token{#1}}
  }}
}
\cs_new_protected:Nn \stex_do_default_notation: {
  \stex_do_default_notation_op:
  \tl_if_empty:NTF \l_stex_current_args_tl {
    \tl_clear:N \l__stex_notations_args_tl
  }\__stex_notations_default_args:
  \tl_set:Ne \l_stex_default_notation {\STEXInternalNotation{}{0}{}{\l__stex_notations_args_tl}{
    \exp_args:No \exp_not:n \l_stex_default_notation
  }}
}

\cs_new_protected:Nn \stex_do_default_notation_op: {
  \__stex_notations_make_name:
  \tl_set:Ne \l_stex_default_notation {\exp_not:N \maincomp{ \exp_not:N \mathrm {\l__stex_notations_name_str} }}
}

\cs_new_protected:Nn \__stex_notations_default_args: {
  \__stex_notations_make_name:
  \tl_set_eq:NN \l_stex_get_symbol_args_tl \l_stex_current_args_tl
  \tl_set:Ne \l__stex_notations_args_tl {
    \_stex_map_args:N \__stex_notations_augment_arg:nn
  }
  \tl_put_right:Nn \l_stex_default_notation {\comp(}
  \seq_clear:N \l_tmpa_seq
  \int_step_inline:nn \l_stex_current_arity_str {
    \seq_put_right:Nn \l_tmpa_seq {#### ##1}
  }
  \tl_put_right:Ne \l_stex_default_notation {
    \seq_use:Nn \l_tmpa_seq {\mathpunct{\comp{,}}}
  }
  \tl_put_right:Nn \l_stex_default_notation {\comp)}
}

\cs_new:Nn \__stex_notations_augment_arg:nn {
  #1#2{0}{}
}

\cs_new_protected:Nn \__stex_notations_make_name: {
  \exp_args:NNNe \seq_set_split:Nnn \l_tmpa_seq / \l_stex_current_display_tl
  \seq_pop_right:NN \l_tmpa_seq \l__stex_notations_name_str
}
\cs_new_protected:Npn \STEXInternalNotation #1 #2 #3 #4 #5 #6 {
  \__stex_notations_process:nnnnnn{#1}{#2}{#3}{#4}{#5}{
    \l__stex_notations_code_tl
    #6
  }
}

\cs_new_protected:Npn \__stex_notations_process:nnnnnn #1 #2 #3 #4 {
  \tl_if_empty:nTF{#4}{
    \__stex_notations_simple:nnnnn{#1}{#2}{#3}
  }{
    \__stex_notations_complex:nnnnnn{#1}{#2}{#3}{#4}
  }
}

\cs_new_protected:Nn \__stex_notations_simple:nnnnn {
  \stex_debug:nn{Notation~code}{\tl_to_str:n{#4}}
  \tl_set:Nn \l__stex_notations_code_tl {
    \cs_set:Npn \l__stex_notations_cs {
      \_stex_maybe_brackets:nn{#2}{
        \_stex_term_oms_or_omv:nn{#1}{#4}
      }
    }
    \l__stex_notations_cs
  }
  #5
}

\cs_new_protected:Nn \__stex_notations_complex:nnnnnn {
  \stex_debug:nn{Notation~code}{\tl_to_str:n{#5}}
  \int_zero:N \l_tmpa_int
  \tl_set:Nn \l__stex_notations_pre_tl {\cs_set_eq:NN \_stex_term_oma_or_omb:nn \_stex_term_oma:nn}
  \tl_set:Nn \l__stex_notations_code_tl {
    \cs_generate_from_arg_count:NNnn \l__stex_notations_cs \cs_set:Npn \l_tmpa_int
    {
      \_stex_maybe_brackets:nn{#2}{
        \_stex_term_oma_or_omb:nn{#1}{
          \bool_set_false:N \l_stex_brackets_dones_bool
          #5
        }
      }
    }
    \l__stex_notations_cs
  }
  \tl_set:Nn \l__stex_notations_after_tl{
    \exp_args:NNo
    \tl_put_left:Nn \l__stex_notations_code_tl \l__stex_notations_pre_tl
    \tl_put_left:Ne \l__stex_notations_code_tl {
      \int_set:Nn \l_tmpa_int {\int_use:N \l_tmpa_int}
    }
    #6
  }
  \__stex_notations_parse_args:nnnnw #4 \__stex_notations_args_end:
}

\cs_new_protected:Npn \__stex_notations_parse_args:nnnnw #1 #2 #3 #4 #5 \__stex_notations_args_end: {
  \tl_if_empty:nTF{#5}{
    \__stex_notations_add_last:nnnnn{#1}{#2}{#3}{#4}
  }{
    \__stex_notations_add_next:nnnnnn{#1}{#2}{#3}{#4}{#5}
  }
}

\cs_new_protected:Nn \__stex_notations_add_next:nnnnnn {
  \__stex_notations_add:nnnnn{#1}{#2}{#3}{#4}{#6}
  \__stex_notations_parse_args:nnnnw #5 \__stex_notations_args_end:
}

\cs_new_protected:Nn \__stex_notations_add_last:nnnnn {
  \__stex_notations_add:nnnnn{#1}{#2}{#3}{#4}{#5}
  \stex_debug:nn{sequences}{Executing~notation:~\meaning\l__stex_notations_code_tl}
  \l__stex_notations_after_tl
}

\cs_new_protected:Nn \__stex_notations_add:nnnnn {
  \int_incr:N \l_tmpa_int
  \str_case:nn{#2}{
    i {
      \tl_put_right:Nn \l__stex_notations_code_tl {
        {\_stex_term_arg:nnnnn{#1}{#2}{#3}{#4}{#5}}
      }
    }
    b {
      \tl_set:Nn \l__stex_notations_pre_tl {
        \cs_set_eq:NN \_stex_term_oma_or_omb:nn \_stex_term_omb:nn
      }
      \tl_put_right:Nn \l__stex_notations_code_tl {
        {\_stex_term_arg:nnnnn{#1}{#2}{#3}{#4}{#5}}
      }
    }
    a {
      \tl_put_right:Nn \l__stex_notations_code_tl {
        {\_stex_term_arg_aB:nnnnn{#1}{#2}{#3}{#4}{#5}}
      }
    }
    B  {
      \tl_set:Nn \l__stex_notations_pre_tl {
        \cs_set_eq:NN \_stex_term_oma_or_omb:nn \_stex_term_omb:nn
      }
      \tl_put_right:Nn \l__stex_notations_code_tl {
        {\_stex_term_arg_aB:nnnnn{#1}{#2}{#3}{#4}{#5}}
      }
    }
  }
}
\cs_new_protected:Npn \argsep #1 #2 {
  \__stex_notations_check_aB_arg:Nn\argsep{#1}
  \stex_pseudogroup_with:nn{\_stex_term_do_aB_clist:}{
    \tl_set:Nn \_stex_term_do_aB_clist: {
      \seq_use:Nn \l_stex_aB_args_seq {#2}
    }
    #1
  }
}

\cs_new_protected:Nn \__stex_notations_check_aB_arg:Nn {
  \exp_args:Ne \cs_if_eq:NNF {\tl_head:n{#2}}
    \_stex_term_arg_aB:nnnnn {
    \msg_error:nnx{stex}{error/assocarg}{\tl_to_str:n{#1}}
  }
}
\cs_new_protected:Npn \seqmap #1 #2 {
  \symuse{Metatheory?sequence~expression}{\seqmap{#1}{#2}}%\l_tmpa_tl {#2}
}
\cs_new_protected:Npn \argmap #1 #2 #3 {
  \__stex_notations_check_aB_arg:Nn\argmap{#1}
  \stex_pseudogroup_with:nn{
    \_stex_term_do_aB_clist:
    \__stex_notations_map_cs:
  }{
    \cs_set:Npn \__stex_notations_map_cs: ##1 { #2 }
    \tl_set:Nn \_stex_term_do_aB_clist: {
      \seq_clear:N \l_tmpa_seq
      \seq_map_inline:Nn \l_stex_aB_args_seq {
        \tl_if_eq:nnTF{##1}{\ellipses}{
          \seq_put_right:Nn \l_tmpa_seq \ellipses
        }{
          \seq_put_right:Nx \l_tmpa_seq {
            \exp_after:wN \exp_not:n \exp_after:wN { \__stex_notations_map_cs: {##1} }
          }
        }
      }
      \seq_set_eq:NN \l_stex_aB_args_seq \l_tmpa_seq
      \seq_use:Nn \l_stex_aB_args_seq {#3}
    }
    #1
  }
}
\int_new:N \l__stex_notations_clist_count_int
\cs_new_protected:Npn \argarraymap #1 #2 #3 #4 {
  \__stex_notations_check_aB_arg:Nn\argarraymap{#1}
  \stex_pseudogroup_with:nn{
    \_stex_term_do_aB_clist:
    \__stex_notations_map_cs:
  }{
    \cs_set:Npn \__stex_notations_map_cs: ##1 { #3 }
    \int_set:Nn \l__stex_notations_clist_count_int {\exp_args:No\clist_count:n{\tl_to_str:n{#4}}}
    \tl_set:Nn \_stex_term_do_aB_clist: {
      \tl_clear:N \l_tmpa_tl
      \int_zero:N \l_tmpa_int
      \seq_map_inline:Nn \l_stex_aB_args_seq {
        \int_incr:N \l_tmpa_int
        \int_compare:nNnT \l_tmpa_int > \l__stex_notations_clist_count_int {
          \int_set:Nn \l_tmpa_int 1
        }
        \tl_put_right:Ne \l_tmpa_tl {
          \exp_after:wN \exp_not:n \exp_after:wN { \__stex_notations_map_cs: {##1} }
          \clist_item:nn{#4}\l_tmpa_int
        }
      }
      \seq_set_eq:NN \l_stex_aB_args_seq \l_tmpa_seq
      \begin{array}{#2}
          \l_tmpa_tl
      \end{array}
    }
    #1
  }
}
\int_new:N \l_stex_notation_downprec
\tl_set:Nn \l__stex_notations_left_bracket_str (
\tl_set:Nn \l__stex_notations_right_bracket_str )
\bool_new:N \l_stex_brackets_dones_bool
\tl_const:Ne \infprec {\int_use:N \c_max_int}
\tl_const:Ne \neginfprec {-\int_use:N \c_max_int}

\int_set:Nn \l_stex_notation_downprec \infprec
\cs_new_protected:Nn \_stex_maybe_brackets:nn {
  \bool_if:NTF \l_stex_brackets_dones_bool {
    \bool_set_false:N \l_stex_brackets_dones_bool
    #2
  } {
    \stex_debug:nn{brackets}{#1>\int_eval:n \l_stex_notation_downprec?}
    \int_compare:nNnTF { #1 } > \l_stex_notation_downprec {
      %\bool_if:NTF \l_stex_inparray_bool { #2 }{
        \dobrackets {
          #2
        }
      %}
    }{
      #2
    }
  }
}
\cs_new_protected:Npn \dobrackets #1 {
  \group_begin:
    \bool_set_true:N \l_stex_brackets_dones_bool
    \mathopen{\tl_if_exist:NT\l_stex_current_symbol_uri\comp
      \l__stex_notations_left_bracket_str
    }
    #1
  \group_end:
  \mathclose{\tl_if_exist:NT\l_stex_current_symbol_uri\comp
    \l__stex_notations_right_bracket_str
  }
}
\cs_new_protected:Npn \withbrackets #1 #2 #3 {
  \stex_pseudogroup:nn{
    \tl_set:Nn \l__stex_notations_left_bracket_str { #1 }
    \tl_set:Nn \l__stex_notations_right_bracket_str { #2 }
    #3
  }{
    \stex_pseudogroup_restore:N \l__stex_notations_left_bracket_str
    \stex_pseudogroup_restore:N \l__stex_notations_right_bracket_str
  }
}
\cs_new_protected:Npn \dowithbrackets #1 #2 #3 {
  \withbrackets{#1}{#2}{\dobrackets{#3}}
}
\cs_new_protected:Npn \symuse #1 {
  \stex_get_symbol:n{#1}
  \exp_args:Nno \use:n {\_stex_invoke_symbol:NeooooN
  \l_stex_get_symbol_uri
  {\int_use:N \l_stex_get_symbol_arity_int}
  \l_stex_get_symbol_args_tl
  \l_stex_get_symbol_def_tl
  \l_stex_get_symbol_type_tl
  \l_stex_get_symbol_return_tl}
  \l_stex_get_symbol_invoke_cs
}
\tl_new:N \l__stex_expr_reset_tl

\cs_new_protected:Nn \_stex_next_symbol:n {
  \tl_set:Ne \l_stex_every_symbol_tl {
    \tl_gset:Nn \exp_not:N \l__stex_expr_reset_tl {
      \tl_set:Nn \exp_not:N \l_stex_every_symbol_tl  {
        \exp_args:No \exp_not:n \l_stex_every_symbol_tl
      }
      \tl_gset:Nn \exp_not:N \l__stex_expr_reset_tl {
        \exp_args:No \exp_not:n \l__stex_expr_reset_tl
      }
    }
    \tl_set:Nn \exp_not:N \l_stex_every_symbol_tl  {
      \exp_args:No \exp_not:n \l_stex_every_symbol_tl
    }
    \exp_not:n{ \aftergroup \l__stex_expr_reset_tl }
    \exp_not:N \l_stex_every_symbol_tl
    \exp_not:n{ #1 }
  }
}
\cs_generate_variant:Nn \_stex_next_symbol:n {e}
\cs_new_protected:Nn \_stex_invoke_symbol:nnnnnnN {
  \bool_if:NTF \l_stex_allow_semantic_bool{
    \group_begin:
    \tl_set:Nn \l_stex_current_symbol_uri {#1}
    \tl_set:Nn \l_stex_current_full_tl { \stex_use_symbol_uri:N \l_stex_current_symbol_uri }
    \tl_set:Nn \l_stex_current_display_tl {
      \stex_symbol_uri_name:N \l_stex_current_symbol_uri
    }
    \__stex_expr_invoke:nnnnN{#2}{#3}{#5}{#6}{#7}
  }{
    \msg_error:nnxx{stex}{error/notallowed}{
      \stex_use_symbol_uri:n{#1}
    }{
      \l_stex_current_full_tl
    }
  }
}

\cs_new_protected:Npn \_stex_invoke_symbol:NnnnnnN {
  \exp_args:No \_stex_invoke_symbol:nnnnnnN
}
\cs_generate_variant:Nn \_stex_invoke_symbol:NnnnnnN {NeooooN}
\bool_new:N \l_stex_allow_semantic_bool
\bool_set_true:N \l_stex_allow_semantic_bool
\tl_set:Nn \l_stex_every_symbol_tl {
  \bool_set_false:N \l_stex_allow_semantic_bool
}
\tl_new:N \l_stex_current_term_tl
\tl_new:N \l_stex_current_redo_tl
\cs_new_protected:Nn \__stex_expr_invoke:nnnnN {
  \stex_if_html_backend:T{\relax\ifvmode\indent\fi}
  \__stex_expr_setup:nnnnn{\_comp}{#1}{#2}{#4}{#3}
  \cs_set_eq:NN \_stex_term_oms_or_omv:nn \_stex_term_oms:nn
  \tl_put_right:Nn \l_stex_current_redo_tl{
    \cs_set_eq:NN \_stex_term_oms_or_omv:nn \_stex_term_oms:nn
  }
  #5
}
\cs_new_protected:Nn \__stex_expr_setup:nnnnn {
  \tl_clear:N \l_stex_return_notation_tl
  \tl_set:Nn \l_stex_current_redo_tl {
    \let \this \stex_current_this:
    \def\comp{#1}
    \def\maincomp{\comp}
    \str_set:Nn \l_stex_current_arity_str{ #2 }
    \tl_set:Nn \l_stex_current_args_tl{ #3 }
    \tl_set:Nn \l_stex_current_return_tl{ #4 }
    \tl_set:Nn \l_stex_current_type_tl{ #5 }
    \tl_clear:N \l_stex_current_term_tl
  }
  \tl_put_right:No \l_stex_current_redo_tl \l_stex_every_symbol_tl
  \tl_put_left:Ne \l_stex_current_redo_tl {
    \tl_set:Nn \exp_not:N \l_stex_current_full_tl { \l_stex_current_full_tl}
  }
  \l_stex_current_redo_tl
}
\cs_new_protected:Nn \stex_invoke_symbol: {
  \stex_debug:nn{expressions}{Invoking~ \l_stex_current_full_tl}
  \mode_if_math:TF \__stex_expr_math: \__stex_expr_text:
}
\cs_new_protected:Nn \stex_invoke_text_symbol: {
  \stex_if_html_backend:T{\relax\ifvmode\indent\fi}
  \_stex_term_oms_or_omv:nn{}{\maincomp{\let\xspace\relax\l_stex_current_return_tl}}
  \group_end:\mode_if_math:F{\cs_if_exist:NT\xspace\xspace}
}
\cs_new_protected:Nn \stex_invoke_sequence: {
  \peek_charcode_remove:NTF ! {
    \peek_charcode:NTF [ \__stex_expr_seq_op:w { \__stex_expr_seq_op:w [] }
  }\__stex_expr_seq_first:
}

\cs_new_protected:Npn \__stex_expr_seq_op:w [#1] {
  \stex_use_op_notation:nnTF \l_stex_current_full_tl{#1}{
    %\stex_debug:nn{vars}{Here: \meaning\l_stex_notation_cs}
    \_stex_maybe_brackets:nn{\neginfprec}{
      \_stex_term_oms_or_omv:nn{#1}
      {\l_stex_notation_cs}\group_end:
    }
  }{
    \__stex_expr_get_index_notation:n{#1}
    \peek_charcode:NTF [ \__stex_expr_range:w { \__stex_expr_range:w[] }
  }
}

\cs_new_protected:Nn \__stex_expr_get_index_notation:n {
  \stex_use_notation:nnTF \l_stex_current_full_tl{#1}{}{
    \stex_do_default_notation:
    \cs_set_eq:NN \l_stex_notation_cs \l_stex_default_notation
  }
}

\cs_new_protected:Npn \__stex_expr_range:w [#1] {
  \bool_set_true:N \l_stex_allow_semantic_bool
  \clist_clear:N \l__stex_expr_clist
  \clist_map_function:NN \l_stex_current_type_tl \__stex_expr_seq_arg:n
    \stex_annotate:nn{
      data-shtml-term=OMV,
      data-shtml-head={\l_stex_current_full_tl},
      data-shtml-notationid={}
    }{
      \l__stex_expr_clist
    }
    \group_end:
}

\cs_new_protected:Nn \__stex_expr_seq_arg:n {
  \tl_if_eq:nnTF{#1}{\ellipses}{
    \clist_put_right:Nn \l__stex_expr_clist {
        \ellipses
    }
  }{
    \clist_put_right:Nn \l__stex_expr_clist {
      \exp_args:No \str_if_eq:nnTF \l_stex_current_arity_str {1}{
        \group_begin:
          \l_stex_notation_cs \group_end: {#1}

      }{
        \group_begin:
          \l_stex_notation_cs \group_end: #1
      }
    }
  }
}

\cs_new_protected:Nn \__stex_expr_seq_first: {
  \exp_args:Nne \use:nn{
  \cs_generate_from_arg_count:NNnn \l_stex_notation_cs \cs_set:Npn
  \l_stex_current_arity_str} {{
    \tl_set:Nn \exp_not:N \l__stex_expr_first_args_tl {
      \int_step_function:nN \l_stex_current_arity_str \__stex_expr_do_first_arg:n
    }
    \exp_not:N \__stex_expr_do_first_next:
  }}
  \l_stex_notation_cs
}

\cs_new:Nn \__stex_expr_do_first_arg:n {{\exp_not:n{## #1}}}

\cs_new_protected:Nn \__stex_expr_do_first_next: {
  \peek_charcode_remove:NTF ! {
    \peek_charcode:NTF [ \__stex_expr_do_one:w {\__stex_expr_do_one:w []}
  }{
    \peek_charcode:NTF [ \__stex_expr_do_all:w {\__stex_expr_do_all:w []}
  }
}

\cs_new_protected:Npn \__stex_expr_do_one:w [#1] {
  \__stex_expr_get_index_notation:n{#1}
  \exp_args:Nno\use:nn{\l_stex_notation_cs\group_end:}\l__stex_expr_first_args_tl
}

\cs_new_protected:Npn \__stex_expr_do_all:w [#1] {
  \exp_args:Nno\use:nn{\__stex_expr_notation:w [#1]}\l__stex_expr_first_args_tl
}
\cs_new_protected:Nn \stex_invoke_structure: {
  \tl_set:Nn \l__stex_expr_set_comp_tl {\__stex_expr_set_thiscomp:}
  \__stex_expr_struct_top:n {}
}

\cs_new_protected:Nn \__stex_expr_set_thiscomp: {
  \exp_args:Ne \tl_if_eq:NNF {\tl_head:N \maincomp} \_thiscomp {
    \edef\maincomp {\_thiscomp{\comp}}
  }
}

\cs_new_protected:Nn \__stex_expr_struct_top:n {
  \stex_debug:nn{structure}{
    invoking~structure~{\l_stex_current_type_tl}<\tl_to_str:n{#1}>
  }
  \peek_charcode:NTF [ {
    \__stex_expr_merge:nw{#1}
  }{
    \__stex_expr_struct_type:n {#1}
    \tl_set:Nn \l_stex_struct_this_tl {}
    \peek_charcode_remove:NTF ! {
      \peek_charcode:NTF [ {
        \__stex_expr_maybe_notation:w
      }{
        \__stex_expr_maybe_notation:w []
      }
    }{
      \__stex_expr_invoke_this:n
    }
  }
}

\cs_new_protected:Npn \__stex_expr_merge:nw #1 [ #2 ] {
  \exp_args:Ne \stex_str_if_starts_with:nnTF {\tl_to_str:n{#2}}{comp=}{
    \__stex_expr_set_customcomp: #2 \__stex_expr_end:
    \__stex_expr_struct_top:n{#1}
  }{
    \exp_args:Ne \stex_str_if_starts_with:nnTF {\tl_to_str:n{#2}}{this=}{
      \__stex_expr_set_thisnotation: #2 \__stex_expr_end:
      \__stex_expr_struct_top:n{#1}
    }{
      \tl_if_empty:nTF{#1}{
        \__stex_expr_struct_top:n{#2}
      }{
        \tl_if_empty:nTF{#2}{
          \__stex_expr_struct_top:n{#1}
        }{
          \__stex_expr_struct_top:n{#1,#2}
        }
      }
    }
  }
}

\cs_new_protected:Npn \__stex_expr_set_thisnotation: this= #1 \__stex_expr_end: {
  \tl_set:Nn \l_stex_return_notation_tl { \comp{#1} }
  \tl_set:Nn \l__stex_expr_set_comp_tl {}
}

\cs_new_protected:Npn \__stex_expr_set_customcomp: comp= #1 \__stex_expr_end: {
  \tl_set:Nn \l__stex_expr_set_comp_tl {
    \__stex_expr_set_custom_comp:n{#1}
  }
  \tl_set:Nn \l_stex_return_notation_tl { \comp{} }
}
\cs_new_protected:Nn \__stex_expr_struct_type:n {
  \__stex_expr_do_assign_list:n{#1}
  \clist_if_empty:NTF \l__stex_expr_fields_clist {
    \int_compare:nNnTF {\clist_count:N \l_stex_current_type_tl}
      = 1 {
        \tl_set:Ne \l__stex_expr_current_type_tl {
          \tl_set:Nn \exp_not:N \l_stex_current_full_tl { \l_stex_current_full_tl }
          \exp_args:No \exp_not:n \l_stex_current_redo_tl
          \_stex_term_oms_or_omv:nn{}{}
        }
      }{
        \exp_args:No \__stex_expr_make_type:n \l_stex_current_type_tl
    }
  }{
    \int_compare:nNnTF {\clist_count:N \l_stex_current_type_tl}
      = 1 {
        \__stex_expr_make_type:n {}
      }{
        \exp_args:No \__stex_expr_make_type:n \l_stex_current_type_tl
    }
  }
}

\cs_new_protected:Nn \__stex_expr_do_assign_list:n {
  \clist_clear:N \l__stex_expr_fields_clist
  \tl_if_empty:nF {#1} {
    \keyval_parse:NNn\TODO\__stex_expr_do_assign:nn{#1}
  }
}

\cs_new_protected:Nn \__stex_expr_do_assign:nn {
  \clist_put_right:Nn \l__stex_expr_fields_clist {{#1}{#2}}
}

\cs_new_protected:Nn \__stex_expr_make_type:n {
  \tl_if_empty:nTF{#1}{
    \seq_clear:N \l_tmpa_seq
  }{
    \seq_set_split:Nnn \l_tmpa_seq ,{#1}
    \seq_pop_right:NN \l_tmpa_seq \l_tmpa_tl
    \seq_reverse:N \l_tmpa_seq
  }
  \tl_set:Ne \l__stex_expr_current_type_tl {
    \symuse{Metatheory?module~type~merge}{
      {
        \exp_args:No \exp_not:n \l_stex_current_redo_tl
        \_stex_term_oms_or_omv:nn{}{}
      }
      \seq_map_function:NN \l_tmpa_seq \__stex_expr_make_mod:n
      \clist_if_empty:NF \l__stex_expr_fields_clist {
        ,\symuse{Metatheory?anonymous~record}{
          \exp_args:Ne \tl_tail:n{
            \clist_map_function:NN \l__stex_expr_fields_clist \__stex_expr_make_oml:n
          }
        }
      }
    }
  }
}

\cs_new:Nn \__stex_expr_make_mod:n {
  ,\symuse{Metatheory?module~type}{
    \exp_args:Ne \stex_annotate:nn{data-shtml-term=OMMOD,data-shtml-head={\stex_use_module_uri:n{#1}}}{}
  }
}

\cs_new:Nn \__stex_expr_make_oml:n {
  \__stex_expr_make_oml:nn #1
}
\cs_new:Nn \__stex_expr_make_oml:nn {
  ,\stex_annotate:nn{
    data-shtml-term=OML,
    data-shtml-head={#1}
  }{
    \_stex_annotate_force_break:n{
      \stex_annotate:nn{data-shtml-definiens={}}{\exp_not:n{#2!}}
    }
  }
}
\cs_new:Nn \__stex_expr_current_type: {
  %\exp_args:No \exp_not:n \l_stex_current_redo_tl
  \tl_set:Nn \exp_not:N \l_stex_current_term_tl {
    \exp_args:No\exp_not:n\l__stex_expr_current_type_tl
  }
  \_stex_term_oms_or_omv:nn{}{}
}
\cs_new_protected:Npn \__stex_expr_maybe_notation:w [ #1 ] {
  \tl_set_eq:NN \l_stex_current_term_tl \l__stex_expr_current_type_tl
  \stex_use_notation:nnTF \l_stex_current_full_tl {#1}{
    \l_stex_notation_cs\group_end:
  }{
    \__stex_expr_make_prop:
    \__stex_expr_make_prop_assign:
    \__stex_expr_present_i:w [#1]
  }
}

\cs_new_protected:Nn \__stex_expr_present: {
  \peek_charcode:NTF [ {
    \__stex_expr_present_i:w
  }{
    \__stex_expr_present:nn{}{}
  }
}

\cs_new_protected:Npn \__stex_expr_present_i:w [#1] {
  \int_compare:nNnTF{\clist_count:n{#1}} = 1 {
    \__stex_expr_present:nn{}{#1}
  }{
    \peek_charcode:NTF [ {
      \__stex_expr_present_ii:nw{#1}
    }{
      \__stex_expr_present:nn{#1}{}
    }
  }
}

\cs_new_protected:Npn \__stex_expr_present_ii:nw #1 [#2] {
  \__stex_expr_present:nn{#1}{#2}
}

\cs_new_protected:Nn \__stex_expr_present:nn {
  \clist_clear:N \l__stex_expr_clist
  \tl_if_empty:nTF{#1}{
    \cs_set:Npn \l__stex_expr_cs ##1 ##2 ##3 {
      \tl_if_empty:nF{##2}{
        \__stex_expr_present_entry:nn {##1}{##3}
      }
    }
  }{
    \cs_set:Npn \l__stex_expr_cs ##1 ##2 ##3 {
      \exp_args:Ne \clist_if_in:nnT{\tl_to_str:n{#1}}{##1}{
        \__stex_expr_present_entry:nn {##1}{##3}
      }
    }
  }
  \prop_map_inline:Nn \l__stex_expr_prop {
    \l__stex_expr_cs {##1} ##2
  }
  \_stex_term_oms_or_omv:nn{}{
    \exp_args:Nno \use:n{
      \bool_set_true:N \l_stex_allow_semantic_bool
      \symuse{Metatheory?mathematical~structure}[#2]
    }{\l__stex_expr_clist}
  }\group_end:
}

\cs_new_protected:Nn \__stex_expr_present_entry:nn {
  \seq_if_in:NnTF \l__stex_expr_assigned_seq {#1}{
    \clist_put_right:Nn \l__stex_expr_clist {#2!}
  }{
    \exp_args:NNe \clist_put_right:Nn \l__stex_expr_clist {
      \_stex_next_symbol:n {
        \exp_args:No \exp_not:n \l__stex_expr_set_comp_tl
        \tl_set:Nn \exp_not:N \l_stex_struct_this_tl {
          \exp_args:No \exp_not:n \l_stex_struct_this_tl
        }
        \exp_not:n {
          \tl_set_eq:NN \this \l_stex_struct_this_tl
        }
        \tl_set:Nn \exp_not:N \l_stex_return_notation_tl {
          \exp_args:No \exp_not:n \l_stex_return_notation_tl
        }
      }
      \exp_not:n{#2!}
    }
  }
}


\cs_new_protected:Nn \__stex_expr_set_custom_comp:n {
  \exp_args:Ne \tl_if_eq:NNF {\tl_head:N \maincomp} \_customthiscomp {
    \stex_debug:nn{structs}{Setting~custom~comp:~\tl_to_str:n{#1}}
    \exp_args:Nne \__stex_expr_set_custom_i:nn{#1}{\comp}
    \def\maincomp {\_customthiscomp}
  }
}

\cs_new_protected:Nn \__stex_expr_set_custom_i:nn {
  \cs_set_protected:Npn \_customthiscomp ##1 {
    \group_begin:
      \bool_set_true:N \l_stex_allow_semantic_bool
      \cs_set:Npn \l__stex_expr_comp_cs ####1 { #1 }
      \def \maincomp {#2}
      \l__stex_expr_comp_cs{#2{##1}}
    \group_end:
  }
}
\cs_new_protected:Nn \__stex_expr_invoke_this:n {
  \peek_charcode_remove:NTF ! {
    \exp_args:Nne\use:nn{
      \group_end:\symuse{Metatheory?of~type}[invisible]{
        \tl_if_empty:nTF{#1}{\_stex_annotate_force_break:n{}}{#1}
      }
    }{
      {
        \tl_set:Nn \exp_not:N \l_stex_current_full_tl { \l_stex_current_full_tl}
        \__stex_expr_current_type:
      }
    }
  }{
    \__stex_expr_invoke_maybe_field:nn{#1}
  }
}

\cs_new_protected:Nn \__stex_expr_invoke_maybe_field:nn {
  \__stex_expr_make_prop:
  \__stex_expr_set_this:n{#1}
  \tl_if_empty:nTF{#2}{
    \__stex_expr_make_prop_assign:
    \__stex_expr_present:
  }{
    \__stex_expr_invoke_field:n{#2}
  }
}

\cs_new_protected:Nn \__stex_expr_set_this:n {
  \tl_if_empty:nTF{#1}{
    %\tl_put_right:Nn \l_stex_current_redo_tl {
    %  \tl_clear:N \l_stex_struct_this_tl
    %}
  }{
    \tl_set:Ne \l_stex_struct_this_tl {{
      \bool_set_true:N \l_stex_allow_semantic_bool
      \tl_set:Nn \exp_not:N \this {
        \exp_args:No \exp_not:n \this
      }
      \tl_set:Nn \exp_not:N \l_stex_current_full_tl { \l_stex_current_full_tl }
      \exp_not:n{#1}
    }}
    \tl_set_eq:NN \this \l_stex_struct_this_tl
    % \l_stex_return_notation_tl
  }
}

\cs_new_protected:Nn \__stex_expr_get_field_name:n {
  \str_set:Ne \l__stex_expr_field_name_str {
    \exp_args:Nne \use:n {\exp_after:wN \use_i:nn \use:n}
    {\prop_item:Nn \l__stex_expr_prop {#1}}
  }
  \str_if_empty:NT \l__stex_expr_field_name_str {
    \str_set:Nn \l__stex_expr_field_name_str {#1}
  }
}

\cs_new_protected:Nn \__stex_expr_invoke_field:n {
  \prop_if_in:NnTF \l__stex_expr_prop {#1}{
    \__stex_expr_get_field_name:n{#1}
    \tl_clear:N \l__stex_expr_more_nextsymbol_tl
    %\exp_args:NNe \seq_if_in:NnF \l__stex_expr_assigned_seq {\tl_to_str:n{#1}}{
      \tl_set:Ne \l__stex_expr_more_nextsymbol_tl {
        \tl_set:Nn \exp_not:N \l_stex_struct_this_tl {
          \exp_args:No \exp_not:n \l_stex_struct_this_tl
        }
        \exp_not:n {
          \tl_set_eq:NN \this \l_stex_struct_this_tl
        }
        \tl_set:Nn \exp_not:N \l_stex_return_notation_tl {
          \exp_args:No \exp_not:n \l_stex_return_notation_tl
        }
        \exp_args:No \exp_not:n \l__stex_expr_set_comp_tl
      }
    %}
    \exp_args:NNe \use:nn \group_end: {
      \_stex_next_symbol:n {
        \exp_args:No \exp_not:n \l__stex_expr_redo_tl
        \tl_set:Nn \exp_not:N \l_stex_current_term_tl {
          \symuse{Metatheory?record~field}{
            \symuse{Metatheory?of~type}{
              \exp_args:No\tl_if_empty:nTF \l_stex_struct_this_tl {\_stex_annotate_force_break:n{}}{\exp_args:No \exp_not:n \l_stex_struct_this_tl}
            }{
              \tl_set:Nn \exp_not:N \l_stex_current_full_tl { \l_stex_current_full_tl}
              \__stex_expr_current_type:
            }
          }{
            \stex_annotate:nn{data-shtml-term=OML,data-shtml-head={\l__stex_expr_field_name_str}}{}
          }
        }
        \exp_args:No \exp_not:n \l__stex_expr_more_nextsymbol_tl
      }
      \exp_not:N \use_ii:nn
      \prop_item:Nn \l__stex_expr_prop {#1}
    }
  }{
    \msg_error:nnn{stex}{error/unknownfield}{#1}
  }
}

\cs_new_protected:Nn \__stex_expr_make_prop: {
  \prop_clear:N \l__stex_expr_prop
  \seq_clear:N \l__stex_expr_seq
  \seq_clear:N \l__stex_expr_assigned_seq
  \tl_clear:N \l__stex_expr_redo_tl
  \__stex_expr_prop_do_decls:
}

\cs_new_protected:Nn \__stex_expr_prop_do_decls: {
  \group_begin:
    \stex_debug:nn{expressions}{constructing~record}
    \seq_clear:N \l_stex_all_module_seq
    \exp_args:Ne \stex_activate_module:n {\clist_item:Nn \l_stex_current_type_tl 1}
    \exp_args:No \stex_iterate_symbols:nn \l_stex_current_type_tl {
      % uri, macro name, name, arity, args, type, def, return, macro
      \tl_if_empty:nTF{##2}{
        \exp_args:Nne\__stex_expr_do_decl_nomacro:nnnnnnnnn{##3}
      }{
        \exp_args:Nne\__stex_expr_do_decl:nnnnnnnnn{##2}
      }
      {\stex_new_symbol_uri:nn{##1}{##3}}{##3}{##4}{##5}{##6}{##7}{##8}##9
    }
    \exp_after:wN \tl_set:Nn \exp_after:wN \l__stex_expr_after_tl \exp_after:wN {
      \exp_after:wN \tl_set:Nn \exp_after:wN \l__stex_expr_prop \exp_after:wN { \l__stex_expr_prop }
    }
    \__stex_expr_prop_do_notations:
    \stex_debug:nn{expressions}{record:~\meaning\l__stex_expr_after_tl}
    \tl_put_right:Ne \l__stex_expr_after_tl {\tl_set:Nn \exp_not:N \l__stex_expr_redo_tl {\exp_args:No \exp_not:n \l__stex_expr_redo_tl}}
  \exp_after:wN \group_end: \l__stex_expr_after_tl
}

\cs_new_protected:Nn \__stex_expr_do_decl_nomacro:nnnnnnnnn {
  \prop_if_in:NnF \l__stex_expr_prop {#1} {
    \seq_put_left:Ne \l__stex_expr_seq {\tl_to_str:n{#2}}
    \prop_put:Nnn \l__stex_expr_prop {#1}{
      {}{
        \_stex_invoke_symbol:nnnnnnN
        {#2}
        {#4}
        {#5}{#6}{#7}{#8}#9
      }
    }
  }
}

\cs_new_protected:Nn \__stex_expr_do_decl:nnnnnnnnn {
  \prop_if_in:NnF \l__stex_expr_prop {#1} {
    \seq_put_left:Ne \l__stex_expr_seq {\tl_to_str:n{#2}}
    \prop_put:Nnn \l__stex_expr_prop {#1}{
      {#3}{
        \_stex_invoke_symbol:nnnnnnN
        {#2}
        {#4}
        {#5}{#6}{#7}{#8}#9
      }
    }
  }
}

\cs_new_protected:Nn \__stex_expr_make_prop_assign: {
  \clist_if_empty:NF \l__stex_expr_fields_clist {
    \clist_map_inline:Nn \l__stex_expr_fields_clist {
      \__stex_expr_make_prop_assign:nn ##1
    }
  }
}

\cs_new_protected:Nn \__stex_expr_make_prop_assign:nn {
  \prop_if_in:NnTF \l__stex_expr_prop {#1}{
    \exp_args:NNe \seq_put_right:Nn \l__stex_expr_assigned_seq {\tl_to_str:n{#1}}
    \exp_args:Nne \use:nn {\__stex_expr_make_prop_assign_replace:nnnn {#1}{#2}}
    {\prop_item:Nn \l__stex_expr_prop {#1}}
  }{
    \msg_error:nnn{stex}{error/unknownfieldass}{#1}
  }
}
\cs_new_protected:Nn \__stex_expr_make_prop_assign_replace:nnnn {
  \prop_put:Nnn \l__stex_expr_prop {#1}{{#3}{#2}}
  \tl_if_empty:nF{#3}{
    \tl_set:cn{#1}{ #2 }
    \tl_put_right:Nn \l__stex_expr_redo_tl {
      \tl_set:cn{#1}{ #2 }
    }
  }
}

\cs_new_protected:Nn \__stex_expr_prop_do_notations: {
  \exp_args:No \stex_iterate_notations:nn \l_stex_current_type_tl {
    \exp_args:NNe \seq_if_in:NnT \l__stex_expr_seq {\tl_to_str:n{##1}}{
      \tl_set:Nn \l_tmpa_tl {
        \cs_if_exist:cF{l_stex_notation_ \stex_use_symbol_uri:n{##1}?##2_cs}{
          \tl_set:cn{l_stex_notation_\stex_use_symbol_uri:n{##1}?##2_cs}{##4}
        }
        \cs_if_exist:cF{l_stex_notation_\stex_use_symbol_uri:n{##1}?_cs}{
          \tl_set:cn{l_stex_notation_\stex_use_symbol_uri:n{##1}?_cs}{##4}
        }
      }
      \exp_args:NNo \tl_put_right:Nn \l__stex_expr_redo_tl \l_tmpa_tl
      \exp_args:NNo \tl_put_right:Nn \l__stex_expr_after_tl \l_tmpa_tl
      \tl_if_empty:nF{##5}{
        \tl_set:Nn \l_tmpa_tl {
          \cs_if_exist:cF{l_stex_notation_\stex_use_symbol_uri:n{##1}?##2_op_cs}{
            \tl_set:cn{l_stex_notation_\stex_use_symbol_uri:n{##1}?##2_op_cs}{##5}
          }
          \cs_if_exist:cF{l_stex_notation_\stex_use_symbol_uri:n{##1}?_op_cs}{
            \tl_set:cn{l_stex_notation_\stex_use_symbol_uri:n{##1}?_op_cs}{##5}
          }
        }
        \exp_args:NNo \tl_put_right:Nn \l__stex_expr_redo_tl \l_tmpa_tl
        \exp_args:NNo \tl_put_right:Nn \l__stex_expr_after_tl \l_tmpa_tl
      }
    }
  }
}
\cs_new_protected:Nn \_stex_invoke_variable:nnnnnnN {
  \bool_if:NTF \l_stex_allow_semantic_bool{
    \group_begin:
    \tl_set:Nn \l_stex_current_full_tl { #1 }
    \tl_set:Nn \l_stex_current_display_tl { #1 }
    \stex_if_html_backend:T{\relax\ifvmode\indent\fi}
    \__stex_expr_setup:nnnnn{\_varcomp}{#2}{#3}{#6}{#5}
    \cs_set_eq:NN \_stex_term_oms_or_omv:nn \_stex_term_omv:nn
    \tl_put_right:Nn \l_stex_current_redo_tl {
      \cs_set_eq:NN \_stex_term_oms_or_omv:nn \_stex_term_omv:nn
    }
    #7
  }{
    \msg_error:nnxx{stex}{error/notallowed}{#1}{\l_stex_current_full_tl}
  }
}
\NewDocumentCommand \svar {O{} m}{
  \group_begin:
    \tl_if_empty:nTF{#1}{
      \tl_set:Nn \l_stex_current_full_tl { #2 }
      \tl_set:Nn \l_stex_current_display_tl { #2 }
    }{
      \tl_set:Nn \l_stex_current_full_tl { #1 }
      \tl_set:Nn \l_stex_current_display_tl { #1 }
    }
    \bool_if:NTF \l_stex_allow_semantic_bool{
        \tl_clear:N \l_stex_current_term_tl
        \_stex_term_omv:nn{}{\_varcomp{#2}}
    }{
      \msg_error:nnxx{stex}{error/notallowed}{Variable}{\l_stex_current_full_tl}
    }
  \group_end:
}
\cs_new_protected:Nn \__stex_expr_math: {
  \stex_debug:nn{expressions}{math~mode}
  \peek_charcode_remove:NTF ! {
    % operator
    \peek_charcode_remove:NTF * \__stex_expr_op_custom:n {
      % op notation
      \peek_charcode:NTF [ \__stex_expr_op_notation:w {
        \__stex_expr_op_notation:w []
      }
    }
  }{
    \peek_charcode_remove:NTF * \__stex_expr_custom:n {
      % normal
      \peek_charcode:NTF [ \__stex_expr_notation:w {
        \__stex_expr_notation:w []
      }
    }
  }
}
\cs_new_protected:Nn \__stex_expr_text: {
  \stex_debug:nn{expressions}{text~mode}
  \peek_charcode_remove:NTF ! \__stex_expr_op_custom:n \__stex_expr_custom:n
}
\cs_new_protected:Npn \__stex_expr_notation:w [ #1 ] {
  \peek_charcode_remove:NTF ! {
    \__stex_expr_op_notation:w [#1]
  }{
    \__stex_expr_full_notation:n {#1}
  }
}
\cs_new_protected:Nn \__stex_expr_full_notation:n {
  \stex_use_notation:nnTF \l_stex_current_full_tl {#1}{
    \stex_debug:nn{expressions}{using~notation~"#1"~for~\l_stex_current_full_tl}
    \tl_if_empty:NTF \l_stex_current_return_tl {
      \stex_debug:nn{expressions}{return~empty}
      \l_stex_notation_cs{\group_end:\_stex_eat_exclamation_point:}
    }{
      \stex_debug:nn{expressions}{return?}
      \exp_after:wN \__stex_expr_maybe_return:n \exp_after:wN {
        \l_stex_notation_cs{}
      }
    }
  }{
    \stex_debug:nn{expressions}{notation~"#1"~for~\l_stex_current_full_tl{}~does~not~exist;~using~default}
    \stex_do_default_notation:
    \tl_if_empty:NTF \l_stex_current_return_tl {
      \l_stex_default_notation{\group_end:\_stex_eat_exclamation_point:}
    }{
      \exp_after:wN
      \__stex_expr_maybe_return:n
      \exp_after:wN
      {\l_stex_default_notation {}}
    }
  }
}
\cs_new_protected:Npn \__stex_expr_op_notation:w [#1] {
  \stex_debug:nn{expressions}{op~notation~for~\l_stex_current_full_tl}
  \stex_use_op_notation:nnTF \l_stex_current_full_tl {#1}{
    \_stex_maybe_brackets:nn{\neginfprec}{
      \_stex_term_oms_or_omv:nn{#1}
      {\l_stex_notation_cs}
    }
    \group_end:
  }{
    \int_compare:nNnTF \l_stex_current_arity_str = 0 {
      \tl_clear:N \l_stex_current_return_tl
      \__stex_expr_notation:w [#1]
    }{
      \stex_do_default_notation_op:
      \_stex_maybe_brackets:nn{\neginfprec}{
        \_stex_term_oms_or_omv:nn{#1}
        {\l_stex_default_notation}
      }
      \group_end:
    }
  }
}
\cs_new_protected:Nn \__stex_expr_op_custom:n {
  \stex_debug:nn{expressions}{custom~op}
  \bool_set_true:N \l_stex_allow_semantic_bool
  \_stex_term_oms_or_omv:nn{}{\maincomp{#1}}
  \group_end:
}
\int_new:N \l__stex_expr_arg_counter_int

\cs_new_protected:Nn \__stex_expr_custom:n {
  \stex_debug:nn{custom}{custom~notation~for~\l_stex_current_full_tl}
  \stex_pseudogroup:nn{
    \bool_set_true:N \l_stex_allow_semantic_bool
    \prop_gclear:N \l__stex_expr_customs_prop
    \seq_gclear:N \l__stex_expr_customs_seq
    \int_gzero:N \l__stex_expr_arg_counter_int
    \tl_if_empty:NF \l_stex_current_args_tl {
      \exp_after:wN \__stex_expr_add_prop_arg:nnw \l_stex_current_args_tl \_stex_args_end:
      \cs_set_eq:NN \arg \__stex_expr_arg:n
    }
    \tl_set_eq:NN \l_stex_get_symbol_args_tl \l_stex_current_args_tl
    \cs_set_eq:NN \__stex_expr_do_ab_next:nn \_stex_term_oma:nn
    \_stex_map_args:N \__stex_expr_check_b:nn
    \__stex_expr_do_ab_next:nn{}{#1}
  }{
    \prop_if_exist:NT \l__stex_expr_customs_prop {
      \prop_gset_from_keyval:Nn \exp_not:N \l__stex_expr_customs_prop {
        \prop_to_keyval:N \l__stex_expr_customs_prop
      }
    }
    \int_gset:Nn \l__stex_expr_arg_counter_int { \int_use:N \l__stex_expr_arg_counter_int}
    \seq_if_exist:NT \l__stex_expr_customs_seq {
      \seq_gset_split:Nnn \exp_not:N \l__stex_expr_customs_seq , {
        \seq_use:Nn \l__stex_expr_customs_seq ,
      }
    }
  }
  % TODO check that all arguments are present
  \group_end:
}

\cs_new_protected:Npn \__stex_expr_add_prop_arg:nnw #1 #2 #3\_stex_args_end: {
  \prop_gput:Nnn \l__stex_expr_customs_prop {#1} {}
  \seq_gput_right:Nn \l__stex_expr_customs_seq {#2}
  \tl_if_empty:nF{#3}{\__stex_expr_add_prop_arg:nnw #3 \_stex_args_end:}
}

\cs_new:Nn \__stex_expr_check_b:nn {
  \str_case:nn #2 {
    b {\cs_set_eq:NN \__stex_expr_do_ab_next:nn \_stex_term_omb:nn}
    B {\cs_set_eq:NN \__stex_expr_do_ab_next:nn \_stex_term_omb:nn}
  }
}
\NewDocumentCommand \__stex_expr_arg:n {s O{} m} {
  \IfBooleanTF #1 {
    \stex_annotate_invisible:n{
      \__stex_expr_arg_inner:nn{#2}{#3}
    }
  }{
    \__stex_expr_arg_inner:nn{#2}{#3}
  }
}

\cs_new_protected:Nn \__stex_expr_arg_inner:nn {
  \tl_if_empty:nTF{#1}{
    \int_gincr:N \l__stex_expr_arg_counter_int
    \exp_args:Ne \__stex_expr_check:nTF{ \int_use:N \l__stex_expr_arg_counter_int }{
      \__stex_expr_arg_do:oon \l_tmpa_tl \l_tmpb_tl
    }{
      \__stex_expr_arg_inner:nn{}
    }{ #2 }
  }{
    \__stex_expr_check:nTF {#1}{
      \__stex_expr_arg_do:oon \l_tmpa_tl \l_tmpb_tl { #2 }
    }{
      \exp_args:No \str_case:nnTF \l_tmpb_tl {
        {a}{
          \exp_args:NNne \prop_gput:Nnn \l__stex_expr_customs_prop {#1}{
            \l_tmpa_tl X
          }
          \tl_set:Nx \l_tmpa_tl { #1 \int_eval:n {\tl_count:N \l_tmpa_tl + 1} }
        }
        {B}{
          \exp_args:NNne \prop_gput:Nnn \l__stex_expr_customs_prop {#1}{
            \l_tmpa_tl X
          }
          \tl_set:Ne \l_tmpa_tl { #1 \int_eval:n {\tl_count:N \l_tmpa_tl + 1} }
        }
      }{
        \__stex_expr_arg_do:oon \l_tmpa_tl \l_tmpb_tl { #2 }
      }{
        \msg_error:nnxx{stex}{error/invalidarg}{#1}{\l_stex_current_full_tl}
      }
    }
  }
}

\prg_new_conditional:Nnn \__stex_expr_check:n {TF} {
  \exp_args:NNe \prop_get:NnNTF \l__stex_expr_customs_prop {#1} \l_tmpa_tl {
    \tl_set:Ne \l_tmpb_tl {\seq_item:Nn \l__stex_expr_customs_seq {#1} }
    \tl_if_empty:NTF \l_tmpa_tl {
      \exp_args:NNe \prop_gput:Nnn \l__stex_expr_customs_prop
        { #1 }{X}
      \exp_args:No \str_case:nnF \l_tmpb_tl {
        {a}{
          \tl_set:Ne \l_tmpa_tl{ #1 1 }
        }
        {B}{
          \tl_set:Ne \l_tmpa_tl{ #1 1 }
        }
      }{
        \tl_set:Ne \l_tmpa_tl{ #1 }
      }
      \prg_return_true:
    }{
      \prg_return_false:
    }
  }{
    \msg_error:nnxx{stex}{error/invalidarg}{#1}{\l_stex_current_full_tl}
    \prg_return_false:
  }
}

\cs_new_protected:Nn \__stex_expr_arg_do:nnn {
  \stex_debug:nn{custom}{Doing~argument~#1~of~mode~#2:~\tl_to_str:n{#3}}
  \group_begin:
    \bool_set_true:N \l_stex_allow_semantic_bool
    \_stex_term_arg:nnn {#2}{#1}{#3}
  \group_end:
}
\cs_generate_variant:Nn \__stex_expr_arg_do:nnn {oon}
\cs_new_protected:Nn \__stex_expr_maybe_return:n {
  \tl_set:Nn \l__stex_expr_return_this_tl {#1}
  \tl_clear:N \l__stex_expr_return_args_tl
  \exp_args:Nne \use:n {
  \cs_generate_from_arg_count:NNnn \__stex_expr_ret_cs:
    \cs_set:Npn \l_stex_current_arity_str } {
      \int_step_function:nN \l_stex_current_arity_str \__stex_expr_return_arg:n
      \__stex_expr_return_next:
    }
  \__stex_expr_ret_cs:
}

\cs_new:Nn \__stex_expr_return_arg:n {
  \tl_put_right:Nn \exp_not:N \l__stex_expr_return_args_tl {{## #1}}
}

\cs_new_protected:Nn \__stex_expr_return_next: {
  \peek_charcode_remove:NTF ! {
    \exp_after:wN \l__stex_expr_return_this_tl \l__stex_expr_return_args_tl \group_end:
  }\__stex_expr_return:
}

\cs_new_protected:Nn \__stex_expr_return: {
  \tl_set:Ne \l__stex_expr_return_this_tl {
    \tl_if_empty:NTF \l_stex_return_notation_tl {
      \exp_after:wN \exp_after:wN \exp_after:wN
      \exp_not:n \exp_after:wN \exp_after:wN \exp_after:wN {
        \exp_after:wN \l__stex_expr_return_this_tl \l__stex_expr_return_args_tl
      }
    }{
      \l_stex_return_notation_tl
    }
  }
  \stex_debug:nn{return}{Notation:~\meaning\l__stex_expr_return_this_tl}

  \exp_after:wN
  \tl_put_left:Nn \exp_after:wN \l__stex_expr_return_this_tl \exp_after:wN {
    \exp_after:wN \group_begin: \l_stex_current_redo_tl
  }
  \exp_args:Nne \use:n {
  \cs_generate_from_arg_count:NNnn \__stex_expr_ret_cs:
    \cs_set:Npn \l_stex_current_arity_str } {
      \exp_args:No \exp_not:n \l_stex_current_return_tl
    }
  \stex_debug:nn{return}{
    \meaning\__stex_expr_ret_cs:^^J
    \meaning\l__stex_expr_return_this_tl^^J
    \exp_args:No \exp_not:n \l__stex_expr_return_args_tl^^J
  }
  \exp_args:Nne \use:nn {
    \exp_after:wN \group_end: \__stex_expr_ret_cs:
  }{
    \exp_args:No \exp_not:n \l__stex_expr_return_args_tl
    {
      \exp_args:No \exp_not:n \l__stex_expr_return_this_tl
      \group_end:
    }
  }
}
\cs_new_protected:Nn \_stex_eat_exclamation_point: {
  \peek_charcode_remove:NT ! \_stex_eat_exclamation_point:
}
\bool_new:N \stex_in_invisible_html_bool
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \_stex_term_oms:nn {
    \tl_if_empty:NTF \l_stex_current_term_tl {
      \__stex_expr_annotate:nnn{OMID}{#1}{#2}
    }{
      \__stex_expr_do_headterm:nn{#1}{#2}
    }
  }
}{
  \cs_new_protected:Nn \_stex_term_oms:nn {#2}
}

\cs_set_eq:NN \_stex_term_oms_or_omv:nn \_stex_term_oms:nn
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \_stex_term_omv:nn {
    \tl_if_empty:NTF \l_stex_current_term_tl {
      \__stex_expr_annotate:nnn{OMV}{#1}{#2}
    }{
      \__stex_expr_do_headterm:nn{#1}{#2}
    }
  }
}{
  \cs_new_protected:Nn \_stex_term_omv:nn {#2}
}
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \__stex_expr_do_headterm:nn {
    \bool_if:NTF \stex_in_invisible_html_bool {
      {\bool_set_true:N \l_stex_allow_semantic_bool
        \ensuremath{\l_stex_current_term_tl}
      }
    }{
      \__stex_expr_annotate:nnn{complex}{#1}{
        \stex_annotate_invisible:nn{data-shtml-headterm={}}{
          {\bool_set_true:N \l_stex_allow_semantic_bool
            \ensuremath{\l_stex_current_term_tl}
          }
        }
        #2
      }
    }
  }
}{
  \cs_new_protected:Nn \__stex_expr_do_headterm:nn { #2 }
}
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \_stex_term_oma:nn {
    \__stex_expr_annotate:nnn{OMA}{#1}{
      \tl_if_empty:NF \l_stex_current_term_tl {
        \stex_annotate_invisible:nn{data-shtml-headterm={}}{{
          \bool_set_true:N \l_stex_allow_semantic_bool
          \l_stex_current_term_tl
        }}
      }
      #2
    }
  }
}{
  \cs_new_protected:Nn \_stex_term_oma:nn {#2}
}
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \_stex_term_omb:nn {
    \__stex_expr_annotate:nnn{OMBIND}{#1}{
      \tl_if_empty:NF \l_stex_current_term_tl {
        \stex_annotate_invisible:nn{data-shtml-headterm={}}{{
          \bool_set_true:N \l_stex_allow_semantic_bool
          \l_stex_current_term_tl
        }}
      }
      #2
    }
  }
}{
  \cs_new_protected:Nn \_stex_term_omb:nn {#2}
}
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \__stex_expr_annotate:nnn {
    \exp_args:Ne \stex_annotate:nn{
      data-shtml-term=#1,
      data-shtml-head={\l_stex_current_full_tl},
      data-shtml-notationid={#2},
    }{
      \_stex_annotate_force_break:n{#3}
    }
  }
}{
  \cs_new_protected:Nn \__stex_expr_annotate:nnn { #3 }
}

\cs_new_protected:Nn \_stex_term_arg:nnnnn {
  \group_begin:
    \tl_clear:N \l_stex_current_symbol_uri
    \tl_clear:N \l_stex_current_full_tl
    \tl_clear:N \l_stex_current_display_tl
    \tl_clear:N \l_stex_current_term_tl
    \int_set:Nn \l_stex_notation_downprec { #3 }
    \bool_set_true:N \l_stex_allow_semantic_bool
    \_stex_term_arg:nnn {#2}{#1}{#5}
  \group_end:
}
\stex_if_html_backend:TF {
  \cs_new_protected:Nn \_stex_term_arg:nnn {
    \stex_if_do_html:TF{
      \_stex_annotate_force_break:n{
        \stex_annotate:nn{
          data-shtml-arg={#2}, data-shtml-argmode={#1}
        }{
          \_stex_annotate_force_break:n{}
          #3
        }
      }
    }{ #3 }
  }
}{
  \cs_new_protected:Nn \_stex_term_arg:nnn {#3}
}
\cs_new:Nn \__stex_expr_do_aB_clist: {
  \_stex_annotate_force_break:n{
    \seq_use:Nn \l_stex_aB_args_seq {
      \mathpunct{\comp{,}}
    }
  }
}

\cs_set_eq:NN \_stex_term_do_aB_clist: \__stex_expr_do_aB_clist:

\cs_new_protected:Nn \_stex_is_sequentialized:n {
  \group_begin: #1 \group_end:
}
\int_new:N \l__stex_expr_count_int
\cs_new_protected:Nn \_stex_term_arg_aB:nnnnn {
  \stex_debug:nn{sequences}{Processing~argument:~ \tl_to_str:n{#5}}
  \tl_if_empty:nTF{#5}{
    \_stex_term_arg:nnnnn{#1}{#2}{#3}{#4}{}
  }{
    \seq_clear:N \l_stex_aB_args_seq
    \int_zero:N \l__stex_expr_count_int
    \clist_map_inline:nn{#5}{
      \__stex_expr_aB_arg:nnnnn{##1}{#1}{#2}{#3}{#4}
    }
    \_stex_term_do_aB_clist:
  }
}
\cs_new_protected:Npn \__stex_expr_aB_arg:nnnnn #1 #2 #3 {
  \int_incr:N \l__stex_expr_count_int
  \stex_debug:nn{expressions}{matching~argument~ #2 #3:~ \tl_to_str:n{#1}}
  \__stex_expr_is_varseq:nTF{#1}{
    \stex_debug:nn{expressions}{=sequence~variable}
    \exp_after:wN \exp_after:wN \exp_after:wN
    \__stex_expr_assoc_seq:nnnnnnn
    \exp_after:wN
    \__stex_expr_gobble:nnnnnnnn #1 \__stex_expr_end:
  }{
    \__stex_expr_is_seqmap:nTF{#1}{
      \stex_debug:nn{expressions}{=seqmap}
      \exp_args:NNe \use:nn \__stex_expr_do_seqmap:nnnnnn {\tl_tail:n{#1}}
    }{
      \stex_debug:nn{expressions}{=simple}
      \__stex_expr_aB_simple_arg:nnnnn{#1}
    }
  }
  {#2}{#3}
}

\cs_new:Npn \__stex_expr_gobble:nnnnnnnn #1 #2 #3 #4 #5 #6 #7 #8 #9 \__stex_expr_end: {
  {#2} #3 {#6}
}
\prg_new_conditional:Nnn \__stex_expr_is_varseq:n {TF} {
  \int_compare:nNnTF {\tl_count:n{#1}} = 1 {
    \exp_args:Ne \cs_if_eq:NNTF {\exp_args:No \tl_head:n{#1}}
    \_stex_invoke_variable:nnnnnnN {
      \exp_args:Ne \cs_if_eq:NNTF {\exp_args:No\tl_item:nn{#1}{8}}
        \stex_invoke_sequence:
          \prg_return_true:\prg_return_false:
    }\prg_return_false:
  }\prg_return_false:
}
\prg_new_conditional:Nnn \__stex_expr_is_seqmap:n {TF} {
  \int_compare:nNnTF {\tl_count:n{#1}} = 3 {
    \exp_args:Ne \tl_if_eq:nnTF {\tl_head:n{#1}} {\seqmap}
      \prg_return_true:\prg_return_false:
  }\prg_return_false:
}
\prg_new_conditional:Nnn \__stex_expr_is_argsep:n {TF} {
  \int_compare:nNnTF {\tl_count:n{#1}} = 3 {
    \exp_args:Ne \tl_if_eq:nnTF {\tl_head:n{#1}} {\argsep}
      \prg_return_true:\prg_return_false:
  }\prg_return_false:
}
\cs_new_protected:Nn \__stex_expr_aB_simple_arg:nnnnn{
  \seq_put_right:Ne \l_stex_aB_args_seq {
    \_stex_term_arg:nnnnn{#2\int_use:N\l__stex_expr_count_int}{#3}{#4}{#5}{
      \exp_not:n{
        \tl_set_eq:NN \_stex_term_do_aB_clist: \__stex_expr_do_aB_clist:
        #1
      }
    }
  }
}
\cs_new_protected:Nn \__stex_expr_assoc_seq:nnnnnnn {
  \group_begin:
    \seq_clear:N \l_stex_aB_args_seq
    \tl_set:Nn \l_stex_current_full_tl{#1}
    \tl_set:Nn \l_stex_current_display_tl{#1}
    \__stex_expr_assoc_make_seq:nnn{#1}{#3}{#2}
  \exp_args:NNe \use:nn \group_end: {
    \seq_put_right:Nn \exp_not:N \l_stex_aB_args_seq {
      \_stex_is_sequentialized:n{
        \_stex_term_arg:nnnnn{#4\int_use:N\l__stex_expr_count_int}{#5}{#6}{#7}{
          \bool_set_true:N \l_stex_allow_semantic_bool
          \tl_if_empty:NF \l_stex_current_term_tl {
            \tl_set:Nn \exp_not:N \l_stex_current_term_tl {
              \exp_args:No \exp_not:n \l_stex_current_term_tl
            }
          }
          \stex_annotate:nn{
            data-shtml-term=OMV,
            data-shtml-head={#1},
            data-shtml-notationid={}
          }{
            \_stex_annotate_force_break:n{
              \_stex_term_do_aB_clist:
            }
          }
        }
      }
    }
  }
}

\cs_new_protected:Nn \__stex_expr_assoc_make_seq:nnn {
  \stex_use_notation:nnTF {#1}{}{
    \cs_set_eq:NN \l__stex_expr_cs \l_stex_notation_cs
  }{
    \stex_do_default_notation:
    \cs_set_eq:NN \l__stex_expr_cs \l_stex_default_notation
  }
  \clist_map_inline:nn{#2}{
    \tl_if_eq:nnTF{##1}{\ellipses}{
      \seq_put_right:Nn \l_stex_aB_args_seq { ##1 }
    }{
      \int_compare:nNnTF {#3} = 1 {
        \tl_set:Nn \l__stex_expr_iarg_tl { {##1} }
      }{
        \tl_set:Nn \l__stex_expr_iarg_tl { ##1 }
      }
      \seq_put_right:Ne \l_stex_aB_args_seq {
        \group_begin:
        \exp_not:n {
          \tl_set_eq:NN \_stex_term_do_aB_clist: \__stex_expr_do_aB_clist:
          \def\comp{\_varcomp}
          \tl_set:Nn \l_stex_current_full_tl{#1}
        }
        \exp_after:wN \exp_after:wN \exp_after:wN \exp_not:n
        \exp_after:wN \exp_after:wN \exp_after:wN {
          \exp_after:wN \l__stex_expr_cs \exp_after:wN \group_end: \l__stex_expr_iarg_tl
        }
      }
    }
  }
}
\cs_new_protected:Nn \__stex_expr_do_seqmap:nnnnnn {
  \group_begin:
    \cs_set:Npn \l_tmpa_cs ##1 {#1}
    \seq_clear:N \l_stex_aB_args_seq
    \clist_map_inline:nn{#2}{
      \__stex_expr_is_varseq:nTF{##1}{
        \exp_after:wN
        \__stex_expr_varseq_in_map:nnnnnnnn ##1
      }{
        \seq_put_right:Nn \l_stex_aB_args_seq {##1}
      }
    }
    \seq_clear:N \l__stex_expr_old_seq
    \seq_map_inline:Nn \l_stex_aB_args_seq {
      \tl_if_eq:nnTF{##1}{\ellipses}{
        \seq_put_right:Nn \l__stex_expr_old_seq {##1}
      }
      % TODO \_stex_is_sequentialized:n
      {
        \exp_args:NNo \seq_put_right:Nn \l__stex_expr_old_seq {
          \l_tmpa_cs {##1}
        }
      }
    }
    \seq_set_eq:NN \l_stex_aB_args_seq \l__stex_expr_old_seq
  \exp_args:NNe \use:nn \group_end: {
    \seq_put_right:Nn \exp_not:N \l_stex_aB_args_seq {
      \_stex_is_sequentialized:n{
        \_stex_term_arg:nnnnn{#3\int_use:N\l__stex_expr_count_int}{#4}{#5}{#6}{
          \bool_set_true:N \l_stex_allow_semantic_bool
          \tl_set:Nn \exp_not:N \l_stex_current_full_tl
            {\l_stex_current_full_tl}
          \tl_set:Nn \exp_not:N \l_stex_current_term_tl {
            \symuse{Metatheory?sequence~map}
            {\exp_args:No \exp_not:n \l_tmpa_tl}
            {\_stex_term_do_aB_clist:}
          }
          \__stex_expr_do_headterm:nn{}{
            \_stex_term_do_aB_clist:
          }
        }
      }
    }
  }
}

\cs_new_protected:Nn \__stex_expr_varseq_in_map:nnnnnnnn {
  \__stex_expr_assoc_make_seq:nnn{#2}{#6}{#3}
}
\cs_set_protected:Npn \comp {}

\cs_new_protected:Npn \compemph@uri #1 #2 {
    \compemph{ #1 }
}

\cs_new_protected:Npn \compemph #1 { #1 }

\cs_new_protected:Npn \_comp {
  \_do_comp:nnNn {comp}{}\compemph@uri
}

\cs_new_protected:Npn \_thiscomp #1 #2 {
  {\tl_set:cn{this}{{}}#1{#2}\c_math_subscript_token{
    \group_begin:
    \bool_set_true:N \l_stex_allow_semantic_bool
    \l_stex_struct_this_tl
    \group_end:
  }
  }
}

\def\maincomp{\comp}
\cs_new_protected:Npn \varemph@uri #1 #2 {
    \varemph{#1}
}

\cs_new_protected:Npn \varemph #1 { #1 }

\cs_new_protected:Npn \_varcomp {
  \_do_comp:nnNn {comp}{}\varemph@uri
}
\cs_new_protected:Npn \defemph@uri #1 #2 {
    \defemph{#1}
}

\cs_new_protected:Npn \defemph #1 {
    \ifmmode\else\expandafter\textbf\fi{#1}
}

\cs_new_protected:Npn \_defcomp {
  \_do_comp:nnNn {defcomp}{}\defemph@uri
}
\cs_new_protected:Npn \symrefemph@uri #1 #2 {
    \symrefemph{#1}
}

\cs_new_protected:Npn \symrefemph #1 { \emph{#1} }
\cs_new_protected:Nn \_do_comp:nnNn {
  \stex_pseudogroup_with:nn{\comp}{
    \def\comp##1{##1}
    \stex_if_html_backend:TF {
      \stex_annotate:nn { data-shtml-#1 = {#2}}{ #4 }
    }{
      \tl_if_empty:NTF \l_stex_current_full_tl {
        #4
      }{
        #3 { #4 } \l_stex_current_full_tl

      }
    }
  }
}
\stex_keys_define:nnnn{symname}{
  \tl_clear:N \l_stex_key_pre_tl
  \tl_clear:N \l_stex_key_post_tl
  %\tl_clear:N \l_stex_key_root_tl
}{
  pre    .tl_set:N   = \l_stex_key_pre_tl ,
  post   .tl_set:N   = \l_stex_key_post_tl ,
  %root   .code:n     = {}%.tl_set:N   = \l_stex_key_root_tl
}{}

\stex_keys_define:nnnn{symref}{
  %\tl_clear:N \l_stex_key_root_tl
}{
  root   .code:n     = {}%.tl_set:N   = \l_stex_key_root_tl
}{}
\NewDocumentCommand \symref { O{} m m} {
  \group_begin:
  \stex_keys_set:nn{symname}{#1}
  \stex_get_symbol:n{#2}
  \__stex_comps_do_ref:nNn{#3}\symrefemph@uri\_stex_term_oms:nn
}
\let\sr\symref
\NewDocumentCommand \symname { O{} m} {
  \group_begin:
  \stex_keys_set:nn{symname}{#1}
  \stex_get_symbol:n{#2}
  \tl_set:Nn \l_stex_current_full_tl { \stex_use_symbol_uri:N \l_stex_get_symbol_uri }
  \tl_set:Nn \l_stex_current_display_tl {
    \stex_symbol_uri_name:N \l_stex_get_symbol_uri
  }
  \__stex_comps_do_ref:nNn{
    \l_stex_key_pre_tl \l_stex_current_display_tl \l_stex_key_post_tl
  }\symrefemph@uri\_stex_term_oms:nn
}
\let\sn\symname
\protected\def\sns{\symname[post=s]}

\cs_new:Nn \__stex_comps_uppercase:n { \uppercase{#1}}

\NewDocumentCommand \Symname { O{} m} {
  \group_begin:
  \stex_keys_set:nn{symname}{#1}
  \stex_get_symbol:n{#2}
  \tl_set:Nn \l_stex_current_full_tl { \stex_use_symbol_uri:N \l_stex_get_symbol_uri }
  \tl_set:Nn \l_stex_current_display_tl {
    \stex_symbol_uri_name:N \l_stex_get_symbol_uri
  }
  \__stex_comps_do_ref:nNn{
    \l_stex_key_pre_tl \exp_args:NNe \use:nn \__stex_comps_uppercase:n \l_stex_current_display_tl \l_stex_key_post_tl
  }\symrefemph@uri\_stex_term_oms:nn
}
\let\Sn\Symname
\protected\def\Sns{\Symname[post=s]}
\NewDocumentCommand \varref { O{} m m} {
  \group_begin:
  \stex_keys_set:nn{symname}{#1}
  \stex_get_var:n{#2}
  \__stex_comps_do_ref:nNn{#3}\varemph@uri{
    \tl_set:Nn \l_stex_current_full_tl { \l_stex_get_variable_str }
    \tl_set:Nn \l_stex_current_display_tl {\l_stex_get_variable_str}
    \def\comp{\_varcomp}
    \_stex_term_omv:nn
  }
}

\NewDocumentCommand \varname { O{} m} {
  \group_begin:
  \stex_keys_set:nn{symname}{#1}
  \stex_get_var:n{#2}
  \__stex_comps_do_ref:nNn{
    \l_stex_key_pre_tl\l_stex_get_variable_str\l_stex_key_post_tl
  }\varemph@uri{
    \tl_set:Nn \l_stex_current_full_tl { \l_stex_get_variable_str }
    \tl_set:Nn \l_stex_current_display_tl {\l_stex_get_variable_str}
    \def\comp{\_varcomp}
    \_stex_term_omv:nn
  }
}

\NewDocumentCommand \Varname { O{} m} {
  \group_begin:
  \stex_keys_set:nn{symname}{#1}
  \stex_get_var:n{#2}
  \__stex_comps_do_ref:nNn{
    \l_stex_key_pre_tl\exp_after:wN\__stex_comps_uppercase:n\l_stex_get_variable_str\l_stex_key_post_tl
  }\varemph@uri{
    \tl_set:Nn \l_stex_current_full_tl { \l_stex_get_variable_str }
    \tl_set:Nn \l_stex_current_display_tl {\l_stex_get_variable_str}
    \def\comp{\_varcomp}
    \_stex_term_omv:nn
  }
}
\stex_keys_define:nnnn{defname}{}{
  gf     .code:n       = {},
  root   .code:n       = {}
}{symname}

\stex_keys_define:nnnn{definiendum}{}{
  gf     .code:n       = {},
  root   .code:n       = {}
}{}

\NewDocumentCommand \definiendum { O{} m m} {
  \stex_keys_set:nn{definiendum}{ #1 }
  \__stex_comps_do_defref:nn{#2}{#3}
}
\stex_deactivate_macro:Nn \definiendum {definition~environments}

\NewDocumentCommand \definame { O{} m } {
  \stex_keys_set:nn{defname}{#1}
  \__stex_comps_do_defref:nn{#2}{
    \l_stex_key_pre_tl\l_stex_current_display_tl\l_stex_key_post_tl
  }
}
\protected\def\definames{\definame[post=s]}
\stex_deactivate_macro:Nn \definame {definition~environments}

\NewDocumentCommand \Definame { O{} m } {
  \stex_keys_set:nn{defname}{#1}
  \__stex_comps_do_defref:nn{#2}{
    \l_stex_key_pre_tl \exp_args:NNe \use:nn \__stex_comps_uppercase:n \l_stex_current_display_tl\l_stex_key_post_tl
  }
}
\protected\def\Definames{\Definame[post=s]}
\stex_deactivate_macro:Nn \Definame {definition~environments}

\NewDocumentCommand \defnotation{ m } {
  \_stex_next_symbol:n { \def\comp{\_defcomp}}#1
}
\stex_deactivate_macro:Nn \defnotation {definition~environments}
  %
\cs_new_protected:Nn \__stex_comps_do_ref:nNn {
  \stex_if_html_backend:T{\relax\ifvmode\indent\fi}
  \bool_if:NTF \l_stex_allow_semantic_bool{
    \tl_set_eq:NN \l_stex_current_symbol_uri \l_stex_get_symbol_uri
    \tl_set:Nn \l_stex_current_full_tl { \stex_use_symbol_uri:N \l_stex_current_symbol_uri }
    %\str_set:Ne \l_stex_current_symbol_name_str { \stex_symbol_uri_name:N \l_stex_current_symbol_uri }
    %\str_if_in:NnT \l_stex_current_symbol_name_str / {
    %  \str_set:Ne \l_stex_current_symbol_name_str {
    %    \exp_after:wN \__stex_comps_slash:w \l_stex_current_symbol_name_str
    %    /\_stex_args_end:
    %  }
    %}
    \tl_clear:N \l_stex_current_term_tl
    \def\comp{\_comp}
    \let\compemph@uri#2
    #3{}{\comp{#1}}
  }{
    \msg_error:nnxx{stex}{error/notallowed}{#1}{\l_stex_current_full_tl}
  }
  \group_end:
}
\cs_new_protected:Nn \__stex_comps_do_defref:nn {
  \stex_if_html_backend:T{\relax\ifvmode\indent\fi}
  \group_begin:
  \stex_get_symbol:n{#1}
  \bool_if:NTF \l_stex_allow_semantic_bool{
    \tl_set:Nn \l_stex_current_full_tl { \stex_use_symbol_uri:N \l_stex_get_symbol_uri }
    \tl_set:Nn \l_stex_current_display_tl {
      \stex_symbol_uri_name:N \l_stex_get_symbol_uri
    }
    %\str_if_in:NnT \l_stex_get_svariable_str / {
    %  \str_set:Ne \l_stex_get_variable_str {
    %    \exp_after:wN \__stex_comps_slash:w \l_stex_get_variable_str
    %    /\_stex_args_end:
    %  }
    %}
    \exp_args:Ne \stex_ref_new_sym_target:n \l_stex_current_full_tl
    \_do_comp:nnNn {definiendum}{\l_stex_current_full_tl}\defemph@uri{#2}
  }{
    \msg_error:nnxx{stex}{error/notallowed}{#1}{\l_stex_current_full_tl}
  }
  \group_end:
}

\cs_new:Npn \__stex_comps_slash:w #1/#2/#3\_stex_args_end: {
  \tl_if_empty:nTF{#3}{
  #2
  }{
    \__stex_comps_slash:w #2 / #3 \_stex_args_end:
  }
}
\stex_keys_define:nnnn{mathstructure}{
  \tl_clear:N \l_stex_current_this_tl
  \str_clear:N \l__stex_structures_name_str
}{
  this    .tl_set:N = \l_stex_current_this_tl ,
  unknown .code:n   = {
    \str_if_empty:NTF \l_keys_key_str {
      \str_set:Ne \l__stex_structures_name_str {\l_keys_key_tl}
    }{
      \str_set_eq:NN \l__stex_structures_name_str \l_keys_key_str
    }
  }
}{}
\stex_new_stylable_env:nnnnnnn {mathstructure}{m O{}}{
  \__stex_structures_begin:nn{#1}{#2}
  \stex_smsmode_do:
}{
  \stex_structural_feature_module_end:
  \__stex_structures_do_externals:
}{}{}{}

\stex_sms_allow_env:n{mathstructure}
\stex_deactivate_macro:Nn \mathstructure {module~environments}
\stex_every_module:n {\stex_reactivate_macro:N \mathstructure}
\cs_new_protected:Nn \__stex_structures_begin:nn {
  \stex_keys_set:nn {mathstructure}{#2}
  \str_if_empty:NT \l__stex_structures_name_str {
    \str_set:Nn \l__stex_structures_name_str {#1}
  }
  \def\comp{\_comp}

  \tl_set:Ne \l__stex_structures_struct_uri {
    \exp_args:No \stex_new_module_uri:n \l__stex_structures_name_str
  }

  \exp_args:Nne \use:nn { \stex_add_symbol:nnnnnnnN }
    { {#1}{\l__stex_structures_name_str}{0}{}{defed}{\l__stex_structures_struct_uri}}
    {}\stex_invoke_structure:
  \str_set:Ne \l_stex_macroname_str {#1}

  \exp_args:No \stex_structural_feature_module:nn
    {\l__stex_structures_name_str}{structure}
}

\cs_new_protected:Nn \__stex_structures_do_externals: {
  \tl_set:Nn \l__stex_structures_replace_this_tl {####1}
}

\stex_new_stylable_env:nnnnnnn {extstructure}{m O{} m}{
  \seq_clear:N \l__stex_structures_imports_seq
  \clist_map_inline:nn{#3}{
    \stex_get_mathstructure:n{##1}
    \clist_map_inline:Nn \l_stex_get_symbol_type_tl {
      \stex_if_module_exists:nT{####1}{
        \seq_put_right:Nn \l__stex_structures_imports_seq{####1}
      }
    }
  }
  \__stex_structures_begin:nn{#1}{#2}
  \seq_map_inline:Nn\l__stex_structures_imports_seq{
    \stex_if_do_html:T {
      \hbox{\stex_annotate_invisible:nn
        {data-shtml-import={\stex_use_module_uri:n{##1}}} {}}
    }
    \stex_add_morphism:nonn
      {}{##1}{import}{}
    \stex_execute_in_module:e{
      \stex_activate_module:n {##1}
    }
  }
  \stex_smsmode_do:
}{
  \stex_structural_feature_module_end:
  \__stex_structures_do_externals:
}{}{}{}

\stex_sms_allow_env:n{extstructure}
\stex_deactivate_macro:Nn \extstructure {module~environments}
\stex_every_module:n {
  \stex_reactivate_macro:N \extstructure
}

\stex_new_stylable_env:nnnnnnn {extstructure*}{m}{
  \__stex_structures_new_extstruct_name:
  \seq_clear:N \l__stex_structures_imports_seq
  \stex_get_mathstructure:n{#1}

  \clist_map_inline:Nn \l_stex_get_symbol_type_tl {
    \stex_if_module_exists:nT{##1}{
      \seq_put_right:Nn \l__stex_structures_imports_seq{##1}
    }
  }

  \stex_module_uri_split_name:NNN \l__stex_structures_parent_uri \l__stex_structures_last_name_str \l_stex_get_structure_module_uri

  \stex_execute_in_module:e{
    \__stex_structures_extend_structure:nnnn{\l__stex_structures_parent_uri}{\l__stex_structures_last_name_str}{\exp_args:No \stex_new_module_uri:n {\l__stex_structures_exstruct_name_str}}{\l_stex_get_structure_module_uri}
  }

  \exp_args:No \__stex_structures_begin:nn\l__stex_structures_exstruct_name_str{}

  \seq_map_inline:Nn \l__stex_structures_imports_seq {
    \stex_if_do_html:T {
      \stex_annotate_invisible:nn
        {data-shtml-import= {\stex_use_module_uri:n{##1}}} {}
    }
    %\stex_add_morphism:nonn
    %  {}{##1}{import}{}
    %\stex_execute_in_module:e{
    %  \stex_activate_module:n {##1}
    %}
    \stex_activate_module:n {##1}
  }

  \stex_smsmode_do:
}{
  \prop_map_inline:cn{\_stex_symbol_macro:N \l_stex_current_module_uri }{
    \__stex_structures_check_def:nnnnnnnn ##2
  }
  \stex_structural_feature_module_end:
  %\exp_args:Ne \stex_do_up_to_module:n {
  %  \stex_activate_module:n {\exp_args:No \stex_new_module_uri:n {\l__stex_structures_exstruct_name_str}}
  %}
  \__stex_structures_do_externals:
}{}{}{}

\stex_sms_allow_env:n{extstructure*}
\exp_after:wN \stex_deactivate_macro:Nn
  \cs:w extstructure*\cs_end: {module~environments}
\stex_every_module:n {
  \exp_after:wN \stex_reactivate_macro:N \cs:w extstructure*\cs_end:
}

\cs_new_protected:Nn \__stex_structures_extend_structure:nnnn {
  \stex_debug:nn{ext}{Extending~\stex_use_module_uri:n {#1} / #2~by~\stex_use_module_uri:n {#3}}
  \exp_args:Nne \tl_put_right:cn{\_stex_module_code_macro:n{#4}}{
    \stex_activate_module:n{#3}
  }
  \exp_args:Nne \prop_put:cnn{\_stex_morphisms_macro:n{#4}}{\stex_use_module_uri:n{#3}}{
    {}{#3}{extstruct}{}
  }
  \exp_args:Nne \use:nn {\__stex_structures_extend_ii:nnnn}{
    \exp_args:NNe \use:nn \__stex_structures_extend_i:nnnnnnnNn {
      \prop_item:cn{\_stex_symbol_macro:n {#1} } { #2 }
    } { #3 }
  }{#1}{#2}
}

\cs_new_protected:Nn \__stex_structures_extend_ii:nnnn {
  \prop_put:cnn{\_stex_symbol_macro:n {#3} } { #4 }{#2}
  \tl_set:ce{#1}{
    \_stex_invoke_symbol:nnnnnnN {\stex_new_symbol_uri:nn {#3}{#4}}
    \use_none:nn #2
  }
}

\cs_new:Nn \__stex_structures_extend_i:nnnnnnnNn {
  {#1}{{#1}{#2}{#3}{#4}{#5}{#6,#9}{#7}#8}
}

\cs_new_protected:Nn \__stex_structures_check_def:nnnnnnnn {
  \tl_if_empty:nT{#5}{
    \msg_error:nnnn{stex}{error/needsdefiniens}{#2}{extstructure*}
  }
}

\cs_new_protected:Nn \__stex_structures_new_extstruct_name: {
  \stex_do_up_to_module:n {
    \str_set:Ne \l__stex_structures_extname_count {\int_eval:n{\l__stex_structures_extname_count+1}}
  }
  \str_set:Ne \l__stex_structures_exstruct_name_str {EXTSTRUCT_\l__stex_structures_extname_count}
}

\stex_every_module:n{ \str_set:Nn \l__stex_structures_extname_count 0}
\cs_new_protected:Npn \stex_current_this: {
  { \bool_set_true:N \l_stex_allow_semantic_bool
    \tl_if_empty:NTF \l_stex_current_this_tl {{}}{
      \tl_set:Nn \l_stex_current_full_tl {
        \exp_args:Ne \stex_use_symbol_uri:n {
          \exp_args:No \stex_new_symbol_uri:n \l__stex_structures_name_str
        }
      }
      \str_set_eq:NN \l_stex_current_display_tl \l__stex_structures_name_str
      \maincomp{\l_stex_current_this_tl}
    }
  }
}

\let \this \stex_current_this:
\cs_new_protected:Nn \stex_get_mathstructure:n {
  \tl_clear:N \l_stex_get_structure_module_uri
  \stex_get_symbol:nF{#1}{
    \msg_error:nnn{stex}{error/unknownstructure}{#1}
  }
  \exp_args:No \tl_if_eq:NNTF \l_stex_get_symbol_invoke_cs \stex_invoke_structure: {
    \tl_set:Ne \l_stex_get_structure_module_uri { \exp_after:wN \__stex_structures_get:w \l_stex_get_symbol_type_tl , \stex_end:  }
  }{
    \msg_error:nnn{stex}{error/unknownstructure}{#1}
  }
}

\cs_new:Npn \__stex_structures_get:w #1 , #2 \stex_end: { #1 }
\cs_new_protected:Npn \usestructure #1 {
  \stex_get_mathstructure:n{ #1 }
  \stex_debug:nn{usestructure}{Using~structure~#1:~\stex_use_module_uri:N \l_stex_get_structure_module_uri}
  \seq_clear:N \l__stex_structures_imports_seq
  \clist_map_inline:Nn \l_stex_get_symbol_type_tl {
    \stex_if_module_exists:nT{##1}{
      \seq_put_right:Nn \l__stex_structures_imports_seq{##1}
    }
  }
  \seq_map_inline:Nn \l__stex_structures_imports_seq {
    \stex_if_do_html:T {
      \hbox{\stex_annotate_invisible:nn
        {data-shtml-usemodule=\stex_use_module_uri:n {##1}} {}}
    }
    \stex_activate_module:n {##1}
  }
}
\stex_keys_define:nnnn{statement}{
  \str_clear:N \l_stex_key_name_str
  \str_clear:N \l_stex_key_macroname_str
  \clist_clear:N \l_stex_key_for_clist
  \str_clear:N \l_stex_key_args_str
  \tl_clear:N \l_stex_key_type_tl
  \tl_clear:N \l_stex_key_def_tl
  \tl_clear:N \l_stex_key_return_tl
  \clist_clear:N \l_stex_key_argtypes_clist
}{
  name     .str_set:N = \l_stex_key_name_str ,
  for      .clist_set:N = \l_stex_key_for_clist ,
  macro    .str_set:N = \l_stex_key_macroname_str ,
  % start  .str_set:N = \l_stex_key_title_str , % TODO remove
  type     .tl_set:N = \l_stex_key_type_tl ,
  judgment .code:n = {},
  from     .code:n= {}, % TODO remove
  to       .code:n={} % TODO remove
}{id,title,style,symargs}
\cs_new_protected:Npn \_stex_do_for_list: {
  \seq_clear:N \l_stex_fors_seq
  \clist_map_inline:Nn \l_stex_key_for_clist {
    \exp_args:Ne\stex_get_symbol:n{\tl_to_str:n{##1}}
    \seq_put_right:No \l_stex_fors_seq
      {\l_stex_get_symbol_uri}
  }
}
\cs_new_protected:Nn \stex_new_statement:nnn {
  \stex_new_stylable_env:nnnnnnn {#1}{O{}}{
    \stex_keys_set:nn{statement}{##1}
    #3

    \stex_if_smsmode:F {
      \exp_args:Nne \begin{stex_annotate_env}{
        \__stex_statements_html_keyvals:nn{#1}{false}
      }
      \tl_set_eq:NN \thistitle \l_stex_key_title_tl
      \str_set_eq:NN \thisname \l_stex_key_name_str
      \clist_set_eq:NN \thisfor \l_stex_key_for_str
      \stex_if_html_backend:TF {
        \noindent
        \stex_annotate:nn{data-shtml-title={}}{\_stex_annotate_force_break:n\l_stex_key_title_tl}
      }
      \stex_style_apply:
    }
    \_stex_do_id:
    \stex_smsmode_do:
  }{
    \stex_if_smsmode:F {
      \stex_if_html_backend:F \stex_style_apply:
      \end{stex_annotate_env}
    }
  }{}{}{s}
  \stex_sms_allow_env:n{s#1}

  \tl_if_empty:nF{#2}{\__stex_statements_make_macro:nnn{#1}{#2}{#3}}
}

\cs_new_protected:Nn \__stex_statements_make_macro:nnn {
  \exp_after:wN \NewDocumentCommand \cs:w inline#2\cs_end: { O{} m}{
    \group_begin:
      \stex_keys_set:nn{statement}{##1}
      #3
      \_stex_do_id:
      \stex_if_smsmode:F{
        \exp_args:Ne \stex_annotate:nn{\__stex_statements_html_keyvals:nn{#1}{true}}{
          \_stex_annotate_force_break:n{##2}
        }
      }
    \group_end:
    %\stex_if_smsmode:TF \stex_smsmode_do: \stex_ignore_spaces_and_pars:
    \stex_smsmode_do:
  }
  \exp_after:wN \stex_sms_allow_escape:N\cs:w inline#2\cs_end:
}

\cs_new:Nn \__stex_statements_html_keyvals:nn {
  data-shtml-#1={},
  data-shtml-inline={#2},
  \seq_if_empty:NF \l_stex_fors_seq {,
    data-shtml-fors={\seq_map_indexed_function:NN \l_stex_fors_seq \__stex_statements_comma_sep_uri:nn }
  }
  \str_if_empty:NF \l_stex_key_id_str {,
    data-shtml-id={\l_stex_key_id_str}%{\stex_uri_use:N \l_stex_current_doc_uri ? \l_stex_key_id_str}
  }
  \clist_if_empty:NF \l_stex_key_style_clist {,
    data-shtml-styles={\l_stex_key_style_clist}
  }
}

\cs_new:Nn \__stex_statements_comma_sep_uri:nn {
  \int_compare:nNnF{#1}=1 {,}
  \stex_use_symbol_uri:n{#2}
}
\cs_new_protected:Nn \__stex_statements_setup:n {
  \str_if_empty:NF \l_stex_key_macroname_str {
    \str_if_empty:NT \l_stex_key_name_str {
      \str_set_eq:NN \l_stex_key_name_str \l_stex_key_macroname_str
    }
  }
  \_stex_do_for_list:
  \tl_clear:N \l__stex_statements_uri

  \str_if_empty:NTF \l_stex_key_name_str \__stex_statements_setup_noname: {
    \__stex_statements_setup_named:n{#1}
  }
}

\cs_new_protected:Nn \__stex_statements_setup_named:n {
  \__stex_statements_force_id:
  \seq_put_right:Ne \l_stex_fors_seq {
    \l_stex_current_module_uri {\l_stex_key_name_str}
  }
  \str_set_eq:NN \l_stex_macroname_str \l_stex_key_macroname_str
  \str_set:Nn \l_stex_key_role_str {#1}
  \stex_symdecl_do:
  \exp_args:Nne \use:nn {\stex_add_symbol:nnnnnnnN}{
    {\l_stex_key_macroname_str}{\l_stex_key_name_str}
    {\int_use:N \l_stex_get_symbol_arity_int}
    {\l_stex_get_symbol_args_tl}
    {#1}{}{}\stex_invoke_symbol:
  }
  \stex_if_do_html:T \_stex_symdecl_html:
  \tl_set:Ne \l__stex_statements_uri {\exp_args:No \stex_new_symbol_uri:nn \l_stex_current_module_uri \l_stex_key_name_str }
  \stex_debug:nn{statement}{name:~\stex_use_symbol_uri:N \l__stex_statements_uri}
}

\cs_new_protected:Nn \__stex_statements_setup_noname: {
  \stex_debug:nn{statement}{no~name}
  \int_compare:nNnTF {\seq_count:N \l_stex_fors_seq} = 1 {
    \tl_set:Ne \l__stex_statements_uri {\seq_item:Nn \l_stex_fors_seq 1}
    \stex_debug:nn{statement}{for:~\stex_use_symbol_uri:N \l__stex_statements_uri}
  }{
    \stex_debug:nn{statement}{no~for}
  }
}

\cs_new_protected:Nn \__stex_statements_force_id: {
  \str_if_empty:NT \l_stex_key_id_str {
    \_stex_ref_new_id:n{}
    \str_set_eq:NN \l_stex_key_id_str \l__stex_refs_str
  }
}
\cs_new_protected:Nn \__stex_statements_setup_def: {
  \stex_if_smsmode:F{
    \seq_map_inline:Nn \l_stex_fors_seq {
      \stex_ref_new_sym_target:n{##1}
    }
  }
  \stex_reactivate_macro:N \definiendum
  \stex_reactivate_macro:N \defnotation
  \stex_reactivate_macro:N \definame
  \stex_reactivate_macro:N \Definame
  \stex_reactivate_macro:N \varbind
  \stex_reactivate_macro:N \definiens
}
\stex_new_statement:nnn{definition}{def}{
  \__stex_statements_force_id:
  \__stex_statements_setup:n{}
  \__stex_statements_setup_def:
}
\stex_new_statement:nnn{assertion}{ass}{
  \__stex_statements_setup:n{assertion}
  \stex_if_smsmode:F{
    \seq_map_inline:Nn \l_stex_fors_seq {
      \stex_ref_new_sym_target:n{##1}
    }
  }
  \stex_reactivate_macro:N \varbind
  \stex_reactivate_macro:N \conclusion
  \stex_reactivate_macro:N \premise
  \stex_reactivate_macro:N \definiendum
  \stex_reactivate_macro:N \defnotation
  \stex_reactivate_macro:N \definame
  \stex_reactivate_macro:N \Definame
}
\stex_new_statement:nnn{example}{ex}{
  \stex_if_smsmode:F {\__stex_statements_setup:n{example}}
}
\stex_new_statement:nnn{paragraph}{}{
  \clist_if_in:NnTF \l_stex_key_style_clist {symdoc}{
    \__stex_statements_force_id:
    \__stex_statements_setup:n{}
    \__stex_statements_setup_def:
  }{
    \__stex_statements_setup:n{}
  }
}
\NewDocumentCommand \definiens { O{} m }{
  \group_begin:
  \tl_if_empty:nF {#1} {
    \stex_get_symbol:n { #1 }
    \tl_set_eq:NN \l__stex_statements_uri \l_stex_get_symbol_uri
  }
  \tl_if_empty:NT \l__stex_statements_uri {
    \msg_error:nn{stex}{error/definiensfor}
  }
  \stex_debug:nn{definiens}{Checking~\stex_use_symbol_uri:N \l__stex_statements_uri }

  \exp_args:No \_stex_add_definiens:nn \l__stex_statements_uri {#2}

  \group_end:
  \stex_smsmode_do:
}

\stex_deactivate_macro:Nn \definiens {definition~environments}
\stex_sms_allow_escape:N \definiens
\cs_new_protected:Nn \_stex_add_definiens:nn {
  \stex_if_smsmode:F {
    \stex_annotate:nn{data-shtml-definiens={\stex_use_symbol_uri:n{#1}}}{
      #2 %\_stex_annotate_force_break:n{ #2 }
    }
  }
  \stex_if_in_module:T {
    \exp_args:Ne \str_if_eq:noT {\stex_symbol_uri_module:n{#1}}\l_stex_current_module_uri{
      \__stex_statements_add_definiens:n{#1}
    }
  }
}

\cs_new_protected:Nn \__stex_statements_add_definiens:n {
  \stex_debug:nn{definiens}{Adding~definiens~to~\stex_use_symbol_uri:n{#1}}
  \exp_args:Nne \prop_gput:cne{\exp_args:Ne \_stex_symbol_macro:n {\stex_symbol_uri_module:n{#1}} }
    {\stex_symbol_uri_name:n {#1}} {
      \exp_args:Nne \use:nn { \__stex_statements_definiens_inner:nnnnnnnN }{ \exp_args:Nne \prop_item:cn {\exp_args:Ne \_stex_symbol_macro:n {\stex_symbol_uri_module:n{#1}} } {\stex_symbol_uri_name:n {#1}} }
  }
}

\cs_new:Nn \__stex_statements_definiens_inner:nnnnnnnN {
  {#1}{#2}{#3}{#4}{defed}{#6}{#7}{#8}
}
\NewDocumentCommand \varbind {m} {
  \clist_map_inline:nn {#1} {
    \stex_get_var:n {##1}
    \stex_if_do_html:T {
      \stex_annotate_invisible:nn {data-shtml-bind=\l_stex_get_variable_str}{}
    }
  }
}
\stex_deactivate_macro:Nn \varbind {definition~or~assertion~environments}
\NewDocumentCommand \conclusion { O{} m} {
  \group_begin:
  \tl_if_empty:nF {#1} {
    \stex_get_symbol:n { #1 }
    \tl_set_eq:NN \l__stex_statements_uri \l_stex_get_symbol_uri
  }
  \tl_if_empty:NT \l__stex_statements_uri {
    \msg_error:nn{stex}{error/conclusionfor}
  }
  \stex_annotate:nn{ data-shtml-conclusion={\stex_use_symbol_uri:N \l__stex_statements_uri}}{
    #2 %\_stex_annotate_force_break:n{ #2 }
  }
  \group_end:
}
\stex_deactivate_macro:Nn \conclusion {assertion~environments}
\NewDocumentCommand \premise {O{} m} {
  \tl_if_empty:nF {#1} {
    \stex_debug:nn{Here:}{Variable~#1}
    \exp_args:Nne\use:nn{\vardef}{{v#1}[name=#1]{#1}}
  }
  \stex_annotate:nn{data-shtml-premise={#1}}{#2}
}
\stex_deactivate_macro:Nn \premise {assertion~environments}
\stex_keys_define:nnnn{ spf }{
  \tl_clear:N \l_stex_key_for_clist
  \tl_clear:N \l_stex_key_from_tl
  \tl_set_eq:NN \l_stex_key_proofend_tl \__stex_proof_proof_box_tl
  \tl_clear:N \l_stex_key_continues_tl
  \tl_clear:N \l_stex_key_term_tl
  \tl_clear:N \l_stex_key_functions_tl
  \tl_clear:N \l_stex_key_method_tl
  \bool_set_false:N \l_stex_key_hide_bool
}{
  for         .clist_set:N  = \l_stex_key_for_clist ,
  from        .tl_set:N     = \l_stex_key_from_tl ,
  proofend    .tl_set:N     = \l_stex_key_proofend_tl,
  continues   .tl_set:N     = \l_stex_key_continues_tl,
  functions   .tl_set:N     = \l_stex_key_functions_tl,
  term        .tl_set:N     = \l_stex_key_term_tl,
  method      .tl_set:N     = \l_stex_key_method_tl,
  hide        .bool_set:N   = \l_stex_key_hide_bool
}{id,style,title}

\bool_set_true:N \l__stex_proof_inc_counter_bool
\intarray_new:Nn\l__stex_proof_counter_intarray{50}

\cs_new_protected:Npn \__stex_proof_insert_number: {
  \int_set:Nn \l_tmpa_int {1}
  \bool_while_do:nn {
    \int_compare_p:nNn {
      \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int
    } > 0
  }{
    \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int .
    \int_incr:N \l_tmpa_int
  }
}
\cs_new_protected:Nn \__stex_proof_number_as_string:N {
  \str_clear:N #1
  \int_set:Nn \l_tmpa_int {1}
  \bool_while_do:nn {
    \int_compare_p:nNn {
      \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int
    } > 0
  }{
    \str_put_right:Nx #1 {\intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int .}
    \int_incr:N \l_tmpa_int
  }
}

\cs_new_protected:Npn \__stex_proof_inc_counter: {
  \int_set:Nn \l_tmpa_int {1}
  \bool_while_do:nn {
    \int_compare_p:nNn {
      \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int
    } > 0
  }{
    \int_incr:N \l_tmpa_int
  }
  \int_compare:nNnF \l_tmpa_int = 1 {
    \int_decr:N \l_tmpa_int
  }
  \intarray_gset:Nnn \l__stex_proof_counter_intarray \l_tmpa_int {
    \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int + 1
  }
}

\cs_new_protected:Npn \__stex_proof_add_counter: {
  \int_set:Nn \l_tmpa_int {1}
  \bool_while_do:nn {
    \int_compare_p:nNn {
      \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int
    } > 0
  }{
    \int_incr:N \l_tmpa_int
  }
  \intarray_gset:Nnn \l__stex_proof_counter_intarray \l_tmpa_int { 1 }
}

\cs_new_protected:Npn \__stex_proof_remove_counter: {
  \int_set:Nn \l_tmpa_int {1}
  \bool_while_do:nn {
    \int_compare_p:nNn {
      \intarray_item:Nn \l__stex_proof_counter_intarray \l_tmpa_int
    } > 0
  }{
    \int_incr:N \l_tmpa_int
  }
  \int_decr:N \l_tmpa_int
  \intarray_gset:Nnn \l__stex_proof_counter_intarray \l_tmpa_int { 0 }
}
\bool_set_false:N \l__stex_proof_in_spfblock_bool

\cs_new_protected:Nn \__stex_proof_begin_proof:nn {\par
  \intarray_gzero:N \l__stex_proof_counter_intarray
  \intarray_gset:Nnn \l__stex_proof_counter_intarray 1 1
  \stex_keys_set:nn{spfsteps}{#1}
  \_stex_do_for_list:
  \stex_if_do_html:T {
    \__stex_proof_html_env:n{proof}
  }
  \seq_map_inline:Nn \l_stex_fors_seq {
    \stex_debug:nn{definiens}{Adding~definiens~to~##1}
    \_stex_add_definiens:nn {##1}{\STEXinvisible{proven}}
  }
  \stex_style_apply:
  \_stex_do_id:
  \stex_reactivate_macro:N \subproof
  \stex_reactivate_macro:N \spfstep
  \stex_reactivate_macro:N \conclude
  \stex_reactivate_macro:N \assumption
  \stex_reactivate_macro:N \eqstep
  \stex_reactivate_macro:N \yield
  \stex_reactivate_macro:N \spfblock
  \stex_reactivate_macro:N \spfjust
  \stex_annotate:nn{data-shtml-title={}}{#2}
  \stex_if_do_html:T{
    \begin{stex_annotate_env}{data-shtml-proofbody={}}
  }
}

\cs_new_protected:Nn \__stex_proof_html_env:n {
  \exp_args:Nne \begin{stex_annotate_env}{
    data-shtml-#1={
      \seq_if_empty:NF \l_stex_fors_seq {
        \seq_map_function:NN \l_stex_fors_seq \stex_use_symbol_uri:N
      }
    }
    \bool_if:NT \l_stex_key_hide_bool {,
      data-shtml-proofhide=true
    }
  }
  \__stex_proof_html:
}

\stex_new_stylable_env:nnnnnnn{proof}{O{} m}{
  \__stex_proof_begin_proof:nn{#1}{#2}
  \bool_set_true:N\l__stex_proof_in_spfblock_bool\__stex_proof_start_list:n{}
  \group_begin:\stexcommentfont
}{
  \stex_style_apply:
  \stex_if_do_html:T{\end{stex_annotate_env}\end{stex_annotate_env}}
}{
  \emph{\sproofautorefname :}~
}{
  \sproofend
}{s}

\AddToHook{env/sproof/end}{
  \bool_if:NT\l__stex_proof_in_spfblock_bool {
    \group_end:\__stex_proof_end_list:
  }
}

\stex_new_stylable_env:nnnnnnn{proof*}{O{}}{
  \__stex_proof_begin_proof:nn{#1}{}
  \bool_set_false:N\l__stex_proof_in_spfblock_bool
}{
  \stex_style_apply:
  \stex_if_do_html:T{\end{stex_annotate_env}\end{stex_annotate_env}}
}{
  \emph{Proof:}~
}{
  \sproofend
}{s}

\cs_new_protected:Nn \__stex_proof_start_list:n {
  \begin{list}{}{
    \setlength\topsep{0pt}
    \setlength\parsep{0pt}
    \setlength\rightmargin{0pt}
  }\item[#1]
}

\cs_new_protected:Nn \__stex_proof_end_list: {
  \end{list}
}

\cs_new_protected:Nn \__stex_proof_html: {
  \stex_annotate_invisible:n{\hbox{
    \tl_if_empty:NF \l_stex_key_term_tl {
      $\stex_annotate:nn{data-shtml-proofterm={}}{\l_stex_key_term_tl}$
    }
    \tl_if_empty:NF \l_stex_key_method_tl {
      \stex_annotate:nn{data-shtml-proofmethod={}}{\l_stex_key_method_tl}
    }
  }}
}
\str_set_eq:NN \subproofautorefname \spfstepautorefname

\stex_new_stylable_env:nnnnnnn{subproof}{s O{} m}{\par
  \stex_keys_set:nn{spf}{#2}
  \_stex_do_for_list:
  \stex_if_do_html:T {
    \__stex_proof_html_env:n{subproof}
  }
  \seq_map_inline:Nn \l_stex_fors_seq {
    \stex_debug:nn{definiens}{Adding~definiens~to~##1}
    \_stex_add_definiens:nn {##1}{\STEXinvisible{proven}}
  }

  \IfBooleanTF #1 {
    \stex_style_apply:
    \str_if_empty:NF \l_stex_key_id_str {
      \__stex_proof_number_as_string:N \@currentlabel
      \str_set:Ne \@currentHref{subproof.\@currentlabel}
      \_stex_do_id:
    }
    \bool_set_false:N \l__stex_proof_in_spfblock_bool
    \stex_annotate:nn{data-shtml-title={}}{#3}
  }{
    \bool_if:NTF \l__stex_proof_in_spfblock_bool {
      \str_if_empty:NF \l_stex_key_id_str {
        \__stex_proof_number_as_string:N \@currentlabel
        \str_set:Ne \@currentHref{subproof.\@currentlabel}
        \_stex_do_id:
      }
      \__stex_proof_start_list:n\__stex_proof_insert_number:
        \stex_annotate:nn{data-shtml-title={}}{#3}
        \__stex_proof_add_counter:
        \stex_style_apply:
    }{
      \stex_annotate:nn{data-shtml-title={}}{#3}
      \stex_style_apply:
      \_stex_do_id:
    }
  }
  \stex_if_do_html:T{
    \begin{stex_annotate_env}{data-shtml-proofbody={}}
  }
  \bool_if:NT \l__stex_proof_in_spfblock_bool {\group_begin:\stexcommentfont}
}{
  \stex_style_apply:
  \bool_if:NT \l__stex_proof_in_spfblock_bool \__stex_proof_inc_counter:
  \stex_if_do_html:T{\end{stex_annotate_env}}
  \bool_if:NT\l__stex_proof_in_spfblock_bool \__stex_proof_end_list:
  \stex_if_do_html:T{\end{stex_annotate_env}}
  \aftergroup \__stex_proof_inblock_restore:
}{}{}{}

\AddToHook{env/subproof/before}{
  \bool_if:NT \l__stex_proof_in_spfblock_bool \group_end:
}

\AddToHook{env/subproof/end}{
  \bool_if:NT\l__stex_proof_in_spfblock_bool {
    \group_end:\__stex_proof_remove_counter:
    %\__stex_proof_end_list:
  }
}

\stex_deactivate_macro:Nn \subproof {sproof~environments}

\cs_new_protected:Nn \__stex_proof_inblock_restore: {
  \bool_if:NT\l__stex_proof_in_spfblock_bool {
    \group_begin:\stexcommentfont
  }
}
\newenvironment{spfsketchenv}{}{}
\stex_new_stylable_cmd:nnnn{spfsketch}{O{} m}{\par
  \begin{spfsketchenv}
  \stex_keys_set:nn{spf}{#1}
  \_stex_do_for_list:
  \_stex_do_id:
  \exp_args:Ne \stex_annotate:nn{
    data-shtml-proofsketch={
      \seq_if_empty:NF \l_stex_fors_seq {
        \seq_map_function:NN \l_stex_fors_seq \stex_use_symbol_uri:N
      }
    }
  }{
    \stex_style_apply:
    #2
  }
  \end{spfsketchenv}
}{
  \noindent\emph{\spfsketchenvautorefname :}~
}
\stex_keys_define:nnnn { spfsteps } {
  \clist_clear:N \l_stex_key_for_clist
  \str_clear:N \l_stex_key_name_str
  \tl_clear:N \l_stex_key_method_tl
  \tl_clear:N \l_stex_key_term_tl
}{
  for         .clist_set:N  = \l_stex_key_for_clist ,
  method      .tl_set:N     = \l_stex_key_method_tl,
  term        .tl_set:N     = \l_stex_key_term_tl,
  name        .str_set_x:N  = \l_stex_key_name_str
  % todo: style=inline
}{id,style,title}
\cs_new_protected:Nn \__stex_proof_make_step_macro:Nnnnn {
  \NewDocumentCommand #1 {s O{} +m} {
    \bool_if:NT \l__stex_proof_in_spfblock_bool \group_end:
    \stex_keys_set:nn{spfsteps}{##2}
    \str_if_empty:NF \l_stex_key_name_str {
      \exp_args:Nne\use:nn{\vardef}{{v\l_stex_key_name_str}[name=\l_stex_key_name_str]{\l_stex_key_name_str}}
    }

    \begin{spfstepenv}
      \str_if_empty:NF \l_stex_key_id_str {
        \__stex_proof_number_as_string:N \@currentlabel
        \str_set:Ne \@currentHref{spfstep.\@currentlabel}
        \_stex_do_id:
      }

    \bool_if:NTF \l__stex_proof_in_spfblock_bool {
      \IfBooleanTF ##1 {
        \__stex_proof_step_html:nn{#2}{##3}
      }{
        \__stex_proof_step_html:nn{#2}{\__stex_proof_start_list:n{#3} ##3 \__stex_proof_end_list:}
        #5
      }
      \end{spfstepenv}
      \group_begin:\stexcommentfont
    }{
      \__stex_proof_step_html:nn{#2}{##3}
      \end{spfstepenv}
    }
  }
  \stex_deactivate_macro:Nn #1 {sproof~environments}
}

\cs_new_protected:Nn \__stex_proof_step_html:nn {
  \stex_if_do_html:TF{
    \exp_args:Ne \stex_annotate:nn{
      data-shtml-spf#1={
        \seq_if_empty:NF \l_stex_fors_seq {
          \seq_map_function:NN \l_stex_fors_seq \stex_use_symbol_uri:N
        }
      }
      \str_if_empty:NF \l_stex_key_name_str {,
        data-shtml-stepname={\l_stex_key_name_str}
      }
    }{
      \__stex_proof_html:
      #2
    }
  }{ #2 }
}
\newenvironment{spfstepenv}{
  \str_set_eq:NN \spfstepenvautorefname \spfstepautorefname
}{}
\NewDocumentEnvironment{spfblock}{}{
  \bool_set_false:N \l__stex_proof_in_spfblock_bool
}{
  \aftergroup\__stex_proof_inblock_restore:
}

\stex_deactivate_macro:Nn \spfblock {sproof~environments}
\AddToHook{env/spfblock/before}{
  \bool_if:NT \l__stex_proof_in_spfblock_bool \group_end:
}
\__stex_proof_make_step_macro:Nnnnn \spfstep {step} \__stex_proof_insert_number: {} \__stex_proof_inc_counter:
\__stex_proof_make_step_macro:Nnnnn \assumption {assumption} \__stex_proof_insert_number: {} \__stex_proof_inc_counter:
\__stex_proof_make_step_macro:Nnnnn \conclude {conclusion} {$\Rightarrow$} {} {}
\NewDocumentCommand \eqstep {s m}{
  \bool_if:NTF \l__stex_proof_in_spfblock_bool {
    \group_end:
    \IfBooleanTF #1 {
      \__stex_proof_step_html:nn{eqstep}{$= #2$}
    }{
      \__stex_proof_step_html:nn{eqstep}{\__stex_proof_start_list:n{$=$} $#2$ \__stex_proof_end_list:}
    }
    \group_begin:\stexcommentfont
  }{
    \__stex_proof_step_html:nn{eqstep}{$= #2$}
  }
}
\stex_deactivate_macro:Nn \eqstep {sproof~environments}
\NewDocumentCommand \yield {+m}{
  \stex_annotate:nn{data-shtml-proofterm={}}{ #1 }
}
\stex_deactivate_macro:Nn \yield {sproof~environments}
\newcommand\spfjust[1]{
  \stex_annotate:nn{spfjust={}}{ #1 }
}
\stex_deactivate_macro:Nn \spfjust {sproof~environments}
\tl_set:Nn \__stex_proof_proof_box_tl {
  \ltx@ifpackageloaded{amssymb}{$\square$}{
    \hbox{\vrule\vbox{\hrule width 6 pt\vskip 6pt\hrule}\vrule}
  }
}

\tl_set:Nn \sproofend {
  \tl_if_empty:NF \l_stex_key_proofend_tl {
    \hfil\null\nobreak\hfill\l_stex_key_proofend_tl\par\smallskip
  }
}
\cs_new_protected:Npn \stexcommentfont {
  \small\itshape
}
\group_begin:
\cs_set:Npn \__stex_modules_persist_module: {}
\cs_set:Npn \stex_check_term:nn #1 #2 {}
\cs_set:Npn \_stex_sref_do_aux:n #1 { #1 }
\bool_set_false:N \c_stex_check_terms_bool
\bool_set_false:N \l__stex_annotate_do_output_bool
\tl_if_exist:cF {c_stex_mathhub_sTeX/meta-inf_archive}{
  \tl_gset:ce {c_stex_mathhub_sTeX/meta-inf_archive}{
    {\tl_to_str:n{sTeX/meta-inf}}
    {\tl_to_str:n{http://mathhub.info}}
    {}
  }
}
\tl_set:Ne \l_stex_current_document_uri {
  {\tl_to_str:n{sTeX/meta-inf}}{}
  {\tl_to_str:n{Metatheory}}{\tl_to_str:n{en}}{}
}
\_stex_module_setup_top_nosig:n{Metatheory}
\g_stex_every_module_tl
\symdef{of~type}[args=ii,invisible]{#1}
\notation{of~type}[colon]{#1 \mathbin{\comp{:}} #2}

\symdef{apply}[args=ia,prec=0;\infprec x\infprec]{#1\mathopen{\comp(} #2 \mathclose{\comp)}}
\notation{apply}[lambda]{#1\; \argsep{#2}{\;}}
\notation{apply}[infixop]{\argsep{#2}{\mathbin{#1}}\STEXinvisible{#1}}
\notation{apply}[infixrel]{\argsep{#2}{\mathrel{#1}}\STEXinvisible{#1}}

\symdef{module~type}[args=i,op=\mathtt{MOD}]
  {\mathopen{\comp{\mathtt{MOD}(}}#1\mathclose{\comp{)}}}
\symdef{module~type~merge}[args=a,op=\oplus]
  {\argsep{#1}{\mathbin{\comp{\oplus}}}}
\symdef{anonymous~record}[args=a]
  {\mathopen{\comp{[[}}#1\mathclose{\comp{]]}}}
\symdef{record~field}[args=2]{#1\comp{.}#2}
\symdecl*{record~type}

\symdecl{mathstruct}[name=mathematical~structure,args=a] % TODO
\notation{mathstruct}[angle,prec=nobrackets]
  {\mathopen{\comp\langle} #1 \mathclose{\comp\rangle}}
\notation{mathstruct}[parens,prec=nobrackets]
  {\mathopen{\comp(} #1 \mathclose{\comp)}}

\symdef{ellipses}[ldots]{\ldots}
\symdef{sequence~expression}[comma,args=a]{#1}
\symdef{sequence~type}[args=1]{#1^{\comp\ast}}
\symdef{sequence~map}[args=ia]{
  \comp{\mathrm{map}}\mathopen{\comp{(}}#1\mathpunct{\comp{,}}
  #2\mathclose{\comp{)}}
}

\symdecl{bind}[args=Bi,assoc=pre]
\notation{bind}[depfun,prec=nobrackets,op=(\cdot)\;\to\;\cdot]
  {\mathopen{\comp(} #1 \mathclose{\comp{)}\mathbin{\comp{\to}}} #2}
\notation{bind}[forall]{\comp\forall #1.\;#2}
\notation{bind}[Pi]{\mathop{\comp\prod}\c_math_subscript_token{#1}#2}

\symdef{implicit~bind}[args=Bi,assoc=pre]{\mathopen{\comp\{} #1 \mathclose{\comp{\}\c_math_subscript_token I}} #2}

\symdecl*{integer~literal}
\notation{integer~literal}{\mathbb Z}

\symdecl*{ordinal}
\notation{ordinal}{\mathtt{Ord}}

\symdef{prop}[name=proposition]{\mathtt{Prop}}
\symdef{judgment~holds}[args=i,role=judgment]{\comp\vdash\;#1}

\symdef{object}{\mathtt{Obj}}

\symdef{aseqdots}[args=a,prec=nobrackets]
  {#1\comp{,\ldots}}%{##1\comp,##2}
\symdef{aseqfromto}[args=ai,prec=nobrackets]
  {#1\comp{,\ldots,}#2}%{##1\comp,##2}
\symdef{aseqfromtovia}[args=aii,prec=nobrackets]
  {#1\comp{,\ldots,}#2\comp{,\ldots,}#3}%{##1\comp,##2}
\global \let \l_stex_metatheory_uri \l_stex_current_module_uri
\global \let \c_stex_default_metatheory \l_stex_metatheory_uri
\stex_close_module:
\group_end:

\cs_new_protected:Npn \MSC #1 {}

\_stex_persist_read_now:
\cs_new_protected:Nn \__stex_others_newlabel:n {
  \exp_args:Ne\__stex_others_old_newlabel:{\tl_to_str:n{#1}}
}
\AtBeginDocument{
  \iow_now:Nn \@auxout {
    \ExplSyntaxOn
    \let\__stex_others_old_newlabel:\newlabel
    \let\newlabel\__stex_others_newlabel:n
    \ExplSyntaxOff
  }
}
\endinput
%%
%% End of file `stex.sty'.
